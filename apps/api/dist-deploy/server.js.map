{
  "version": 3,
  "sources": ["../src/lib/telemetry.ts", "../src/server.ts", "../src/lib/logger.ts", "../src/middleware/auth.ts", "../src/middleware/rate-limit.ts", "../src/routes/ai/chat.ts", "../../../packages/types/src/planned-workout.ts", "../../../packages/types/src/validation.ts", "../src/config/ai.ts", "../src/services/ai/conversation.ts", "../src/services/ai/graph.ts", "../src/services/ai/prompt.ts", "../src/services/ai/supabase.ts", "../src/services/ai/tools/analyze-biometric-trends.ts", "../src/services/ai/tools/analyze-form.ts", "../src/services/ai/tools/analyze-workouts.ts", "../src/services/ai/tools/generate-workout-plan.ts", "../src/services/ai/tools/get-athlete-profile.ts", "../src/services/ai/tools/get-health-metrics.ts", "../src/services/ai/tools/get-progress-report.ts", "../src/services/ai/tools/get-squad-leaderboard.ts", "../src/services/ai/tools/get-training-plan.ts", "../src/services/ai/tools/get-workout-history.ts", "../../../packages/core/src/strength/index.ts", "../src/services/ai/tools/log-injury.ts", "../src/services/ai/tools/log-workout.ts", "../src/services/ai/tools/match-documents.ts", "../src/services/ai/tools/modify-training-plan.ts", "../src/services/ai/tools/pass-baton.ts", "../src/services/ai/tools/predict-injury-risk.ts", "../src/services/ai/tools/save-memory.ts", "../src/services/ai/tools/schedule-workout.ts", "../src/services/ai/tools/search-workouts.ts", "../src/services/ai/tools/traverse-graph.ts", "../src/services/ai/tools/update-soreness.ts", "../src/services/ai/tools/index.ts", "../src/services/ai/memory-extractor.ts", "../src/services/ai/safety.ts", "../src/routes/ai/stream.ts", "../src/routes/integrations/index.ts", "../src/config/integrations.ts", "../src/services/integrations/errors.ts", "../src/services/integrations/http.ts", "../src/services/integrations/providers/garmin.ts", "../src/services/integrations/providers/polar.ts", "../src/services/integrations/providers/strava.ts", "../src/services/integrations/providers/wahoo.ts", "../src/services/integrations/registry.ts", "../src/services/integrations/crypto.ts", "../src/services/integrations/token-manager.ts", "../src/routes/integrations/garmin.ts", "../src/services/integrations/normalizer.ts", "../src/services/integrations/oauth-state.ts", "../src/services/integrations/oauth.ts", "../src/routes/integrations/polar.ts", "../src/routes/integrations/strava.ts", "../src/routes/integrations/wahoo.ts", "../src/routes/planned-workouts/index.ts", "../src/middleware/validate.ts", "../src/routes/webhooks/index.ts", "../src/services/integrations/webhook-queue.ts"],
  "sourcesContent": ["// ============================================================\n// OpenTelemetry Bootstrap \u2014 MUST be imported before all other modules\n// Initializes tracing, HTTP instrumentation, and GenAI spans.\n// ============================================================\n\nimport { OTLPTraceExporter } from \"@opentelemetry/exporter-trace-otlp-http\";\nimport { registerInstrumentations } from \"@opentelemetry/instrumentation\";\nimport { HttpInstrumentation } from \"@opentelemetry/instrumentation-http\";\nimport { resourceFromAttributes } from \"@opentelemetry/resources\";\nimport { BatchSpanProcessor, NodeTracerProvider } from \"@opentelemetry/sdk-trace-node\";\nimport { ATTR_SERVICE_NAME, ATTR_SERVICE_VERSION } from \"@opentelemetry/semantic-conventions\";\n\nconst provider = new NodeTracerProvider({\n\tresource: resourceFromAttributes({\n\t\t[ATTR_SERVICE_NAME]: \"triathlon-ai-api\",\n\t\t[ATTR_SERVICE_VERSION]: \"0.1.0\",\n\t\t\"deployment.environment\": process.env.NODE_ENV ?? \"development\",\n\t}),\n\tspanProcessors: [\n\t\tnew BatchSpanProcessor(\n\t\t\tnew OTLPTraceExporter({\n\t\t\t\turl: process.env.OTEL_EXPORTER_OTLP_ENDPOINT ?? \"http://localhost:4318/v1/traces\",\n\t\t\t}),\n\t\t),\n\t],\n});\n\nprovider.register();\n\nregisterInstrumentations({\n\tinstrumentations: [\n\t\tnew HttpInstrumentation({\n\t\t\tignoreIncomingRequestHook: (req) => req.url === \"/health\",\n\t\t\trequestHook: (span, request) => {\n\t\t\t\tconst headers = \"headers\" in request ? request.headers : undefined;\n\t\t\t\tconst requestId =\n\t\t\t\t\theaders && typeof headers === \"object\" && \"x-request-id\" in headers\n\t\t\t\t\t\t? String(headers[\"x-request-id\"])\n\t\t\t\t\t\t: \"\";\n\t\t\t\tif (requestId) {\n\t\t\t\t\tspan.setAttribute(\"http.request.id\", requestId);\n\t\t\t\t}\n\t\t\t},\n\t\t}),\n\t],\n});\n\nprocess.on(\"SIGTERM\", () => provider.shutdown());\n\nexport { provider };\n", "// OTel MUST be imported before all other modules\nimport \"./lib/telemetry.js\";\n\nimport { serve } from \"@hono/node-server\";\nimport { swaggerUI } from \"@hono/swagger-ui\";\nimport { OpenAPIHono } from \"@hono/zod-openapi\";\nimport { bodyLimit } from \"hono/body-limit\";\nimport { cors } from \"hono/cors\";\nimport { secureHeaders } from \"hono/secure-headers\";\nimport { logger } from \"./lib/logger.js\";\nimport { extractClaims, jwtAuth } from \"./middleware/auth.js\";\nimport { RATE_LIMITS, rateLimit } from \"./middleware/rate-limit.js\";\nimport { aiRoutes } from \"./routes/ai/chat.js\";\nimport { aiStreamRoutes } from \"./routes/ai/stream.js\";\nimport { integrationRoutes } from \"./routes/integrations/index.js\";\nimport { plannedWorkoutsRoutes } from \"./routes/planned-workouts/index.js\";\nimport { webhookRoutes } from \"./routes/webhooks/index.js\";\nimport { stopPolling } from \"./services/integrations/webhook-queue.js\";\n\nconst app = new OpenAPIHono();\n\n// \u2500\u2500 Global error handler \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\napp.onError((err, c) => {\n\tlogger.error({ err, path: c.req.path, method: c.req.method }, \"Unhandled error\");\n\treturn c.json(\n\t\t{\n\t\t\terror: err.message || \"Internal Server Error\",\n\t\t\tstack: process.env.NODE_ENV === \"production\" ? undefined : err.stack,\n\t\t},\n\t\t500,\n\t);\n});\n\n// \u2500\u2500 Global middleware \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\napp.use(\"*\", secureHeaders());\napp.use(\n\t\"*\",\n\tcors({\n\t\torigin: (origin) => {\n\t\t\t// Allow any localhost origin in development (Next.js, Flutter web, etc.)\n\t\t\tif (origin && /^https?:\\/\\/localhost(:\\d+)?$/.test(origin)) {\n\t\t\t\treturn origin;\n\t\t\t}\n\t\t\t// Allow configured WEB_URL and Azure production domain\n\t\t\tconst allowed = [\n\t\t\t\tprocess.env.WEB_URL,\n\t\t\t\t\"https://jpx-workout-web.azurewebsites.net\",\n\t\t\t\t\"https://jpx.nu\",\n\t\t\t].filter(Boolean) as string[];\n\t\t\tif (origin && allowed.includes(origin)) {\n\t\t\t\treturn origin;\n\t\t\t}\n\t\t\treturn allowed[0] || \"http://localhost:3000\";\n\t\t},\n\t\tcredentials: true,\n\t}),\n);\n\n// \u2500\u2500 Request body size limits \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\n// Default 2 MB for general API routes\napp.use(\"/api/*\", bodyLimit({ maxSize: 2 * 1024 * 1024 }));\n// AI chat supports image uploads \u2014 allow up to 12 MB\napp.use(\"/api/ai/*\", bodyLimit({ maxSize: 12 * 1024 * 1024 }));\n\n// \u2500\u2500 Health check (public) \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\napp.get(\"/health\", (c) =>\n\tc.json({\n\t\tstatus: \"ok\",\n\t\tversion: \"0.1.0\",\n\t\ttimestamp: new Date().toISOString(),\n\t\truntime: `Node.js ${process.version}`,\n\t}),\n);\n\n// \u2500\u2500 Webhook routes (signature-verified, no JWT) \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\napp.route(\"/webhooks\", webhookRoutes);\n\n// \u2500\u2500 Protected API routes \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\n// JWT auth + claims extraction for all /api/* routes\napp.use(\"/api/*\", jwtAuth(), extractClaims);\n\n// Rate limiting for AI endpoints\napp.use(\"/api/ai/*\", rateLimit(RATE_LIMITS.aiChat));\n\n// Route groups \u2014 chained for Hono RPC type inference\nconst routes = app\n\t.route(\"/api/ai\", aiRoutes)\n\t.route(\"/api/ai\", aiStreamRoutes)\n\t.route(\"/api/planned-workouts\", plannedWorkoutsRoutes)\n\t.route(\"/api/integrations\", integrationRoutes);\n\n// \u2500\u2500 OpenAPI documentation \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\napp.doc(\"/api/doc\", {\n\topenapi: \"3.1.0\",\n\tinfo: {\n\t\ttitle: \"Triathlon AI Coaching API\",\n\t\tversion: \"0.1.0\",\n\t\tdescription: \"REST API for the triathlon AI coaching platform\",\n\t},\n});\n\napp.get(\"/api/reference\", swaggerUI({ url: \"/api/doc\" }));\n\n// \u2500\u2500 Start server \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\nconst port = parseInt(process.env.PORT || \"8787\", 10);\n\nlogger.info({ port }, \"Triathlon AI API server starting\");\n\nconst server = serve({\n\tfetch: app.fetch,\n\tport,\n});\n\n// \u2500\u2500 Graceful shutdown \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\n// Ensures in-flight requests complete before Azure restarts the process\nfunction shutdown(signal: string) {\n\tlogger.info({ signal }, \"Shutdown signal received \u2014 closing gracefully\");\n\tstopPolling();\n\tserver.close(() => {\n\t\tlogger.info(\"Server closed\");\n\t\tprocess.exit(0);\n\t});\n\t// Force exit after 10s if connections don't drain\n\tsetTimeout(() => {\n\t\tlogger.warn(\"Forced shutdown after 10s timeout\");\n\t\tprocess.exit(1);\n\t}, 10_000).unref();\n}\n\nprocess.on(\"SIGTERM\", () => shutdown(\"SIGTERM\"));\nprocess.on(\"SIGINT\", () => shutdown(\"SIGINT\"));\n\n// Export for Hono RPC client type inference\nexport type AppType = typeof routes;\nexport default app;\n", "// ============================================================\n// Structured Logger \u2014 Pino with OpenTelemetry trace correlation\n// ============================================================\n\nimport pino from \"pino\";\n\nexport const logger = pino({\n\tlevel: process.env.LOG_LEVEL ?? \"info\",\n\ttransport:\n\t\tprocess.env.NODE_ENV === \"development\"\n\t\t\t? {\n\t\t\t\t\ttarget: \"pino/file\",\n\t\t\t\t\toptions: { destination: 1 }, // stdout\n\t\t\t\t}\n\t\t\t: undefined,\n\tformatters: {\n\t\tlevel(label) {\n\t\t\treturn { level: label };\n\t\t},\n\t},\n\ttimestamp: pino.stdTimeFunctions.isoTime,\n});\n\n/** Create a child logger with contextual bindings */\nexport function createLogger(context: Record<string, unknown>) {\n\treturn logger.child(context);\n}\n", "/**\n * Auth Middleware \u2014 JWT validation using jose JWKS verification\n *\n * Validates Supabase JWTs (ES256) from the Authorization header using\n * the project's JWKS endpoint for public key discovery.\n * Extracts `club_id` and `role` from `app_metadata` custom claims.\n */\n\nimport type { Context, MiddlewareHandler } from \"hono\";\nimport { createMiddleware } from \"hono/factory\";\nimport { createRemoteJWKSet, jwtVerify } from \"jose\";\nimport { logger } from \"../lib/logger.js\";\n\n// \u2500\u2500 Types \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\n\nexport interface AuthContext {\n\tuserId: string;\n\tclubId: string;\n\trole: \"athlete\" | \"coach\" | \"admin\" | \"owner\";\n}\n\n// \u2500\u2500 JWKS Setup \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\n\nconst SUPABASE_URL = process.env.SUPABASE_URL;\nif (!SUPABASE_URL) {\n\tthrow new Error(\"SUPABASE_URL environment variable is required\");\n}\nconst JWKS = createRemoteJWKSet(new URL(`${SUPABASE_URL}/auth/v1/.well-known/jwks.json`));\n\n// \u2500\u2500 JWT Verification \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\n\n/**\n * Validates the Supabase JWT using JWKS (ES256 public key verification).\n * Must be applied before `extractClaims`.\n */\nexport function jwtAuth(): MiddlewareHandler {\n\treturn createMiddleware(async (c, next) => {\n\t\tconst authHeader = c.req.header(\"Authorization\");\n\n\t\tif (!authHeader || !authHeader.startsWith(\"Bearer \")) {\n\t\t\treturn c.json({ error: \"Missing or invalid Authorization header\" }, 401);\n\t\t}\n\n\t\tconst token = authHeader.slice(7);\n\n\t\ttry {\n\t\t\tconst { payload } = await jwtVerify(token, JWKS, {\n\t\t\t\tissuer: `${SUPABASE_URL}/auth/v1`,\n\t\t\t});\n\n\t\t\t// Store the payload for downstream middleware\n\t\t\tc.set(\"jwtPayload\", payload);\n\t\t} catch (err) {\n\t\t\tconst message = err instanceof Error ? err.message : \"Token verification failed\";\n\t\t\tlogger.warn({ reason: message }, \"JWT verification failed\");\n\t\t\treturn c.json({ error: \"Invalid or expired token\" }, 401);\n\t\t}\n\n\t\tawait next();\n\t});\n}\n\n// \u2500\u2500 Claims Extraction \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\n\n/**\n * Extracts `club_id` and `role` from the validated JWT's `app_metadata`\n * and sets them as Hono context variables.\n *\n * Must be used after `jwtAuth()`.\n *\n * Usage in routes:\n *   const auth = getAuth(c);\n *   const { userId, clubId, role } = auth;\n */\nexport const extractClaims = createMiddleware(async (c, next) => {\n\tconst payload = c.get(\"jwtPayload\") as Record<string, unknown>;\n\n\tif (!payload?.sub) {\n\t\treturn c.json({ error: \"Missing user ID in token\" }, 401);\n\t}\n\n\tconst appMetadata = payload.app_metadata as Record<string, string> | undefined;\n\n\tconst auth: AuthContext = {\n\t\tuserId: payload.sub as string,\n\t\tclubId: appMetadata?.club_id || \"00000000-0000-0000-0000-000000000001\",\n\t\trole: (appMetadata?.role || \"athlete\") as AuthContext[\"role\"],\n\t};\n\n\tc.set(\"auth\", auth);\n\tawait next();\n});\n\n// \u2500\u2500 Helper \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\n\n/**\n * Retrieves the authenticated user context from a Hono request.\n * Throws if auth middleware hasn't run (programming error).\n */\nexport function getAuth(c: Context): AuthContext {\n\tconst auth = c.get(\"auth\") as AuthContext | undefined;\n\tif (!auth) {\n\t\tthrow new Error(\"getAuth() called without auth middleware \u2014 check route middleware stack\");\n\t}\n\treturn auth;\n}\n", "/**\n * Rate Limiter Middleware \u2014 PostgreSQL-backed sliding window\n *\n * Distributed rate limiting that works across multiple API instances.\n * Uses a PostgreSQL function for atomic check-and-increment.\n * Falls back to allowing requests when DB is unreachable (fail-open).\n *\n * Uses Draft 7 RateLimit response headers.\n */\n\nimport { createClient } from \"@supabase/supabase-js\";\nimport { createMiddleware } from \"hono/factory\";\nimport { createLogger } from \"../lib/logger.js\";\n\nconst log = createLogger({ module: \"rate-limit\" });\n\n// \u2500\u2500 Configuration \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\n\ninterface RateLimitConfig {\n\t/** Max requests allowed in the window */\n\tlimit: number;\n\t/** Window duration in seconds */\n\twindowSeconds: number;\n}\n\n/** Presets for different route groups */\nexport const RATE_LIMITS = {\n\taiChat: { limit: 20, windowSeconds: 60 } satisfies RateLimitConfig,\n\tapiRead: { limit: 100, windowSeconds: 60 } satisfies RateLimitConfig,\n\twebhooks: { limit: 200, windowSeconds: 60 } satisfies RateLimitConfig,\n} as const;\n\n// \u2500\u2500 Supabase client for rate limiting \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\n\nfunction getSupabase() {\n\treturn createClient(process.env.SUPABASE_URL!, process.env.SUPABASE_SERVICE_ROLE_KEY!);\n}\n\n// \u2500\u2500 Middleware Factory \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\n\nexport function rateLimit(config: RateLimitConfig) {\n\tconst { limit, windowSeconds } = config;\n\n\treturn createMiddleware(async (c, next) => {\n\t\tconst clientId =\n\t\t\tc.req.header(\"x-forwarded-for\")?.split(\",\")[0]?.trim() ||\n\t\t\tc.req.header(\"x-real-ip\") ||\n\t\t\t\"unknown\";\n\n\t\tconst key = `${clientId}:${c.req.path}`;\n\n\t\tlet remaining: number;\n\n\t\ttry {\n\t\t\tconst supabase = getSupabase();\n\t\t\tconst { data, error } = await supabase.rpc(\"check_rate_limit\", {\n\t\t\t\trate_key: key,\n\t\t\t\tmax_requests: limit,\n\t\t\t\twindow_seconds: windowSeconds,\n\t\t\t});\n\n\t\t\tif (error) {\n\t\t\t\tlog.warn({ err: error }, \"Rate limit DB check failed, allowing request\");\n\t\t\t\tremaining = limit; // fail open\n\t\t\t} else {\n\t\t\t\tremaining = data as number;\n\t\t\t}\n\t\t} catch {\n\t\t\tlog.warn(\"Rate limit DB unreachable, allowing request\");\n\t\t\tremaining = limit; // fail open\n\t\t}\n\n\t\tif (remaining < 0) {\n\t\t\tc.header(\"RateLimit-Limit\", String(limit));\n\t\t\tc.header(\"RateLimit-Remaining\", \"0\");\n\t\t\tc.header(\"RateLimit-Reset\", String(windowSeconds));\n\t\t\tc.header(\"Retry-After\", String(windowSeconds));\n\n\t\t\treturn c.json(\n\t\t\t\t{\n\t\t\t\t\terror: \"Too many requests\",\n\t\t\t\t\tretryAfter: windowSeconds,\n\t\t\t\t},\n\t\t\t\t429,\n\t\t\t);\n\t\t}\n\n\t\t// Set rate limit headers (Draft 7)\n\t\tc.header(\"RateLimit-Limit\", String(limit));\n\t\tc.header(\"RateLimit-Remaining\", String(Math.max(0, remaining)));\n\t\tc.header(\"RateLimit-Reset\", String(windowSeconds));\n\n\t\tawait next();\n\t});\n}\n", "import { HumanMessage } from \"@langchain/core/messages\";\nimport { ChatMessageInput } from \"@triathlon/types\";\nimport { Hono } from \"hono\";\nimport { streamSSE } from \"hono/streaming\";\nimport { AI_CONFIG, validateAIConfig } from \"../../config/ai.js\";\nimport { createLogger } from \"../../lib/logger.js\";\nimport { getAuth } from \"../../middleware/auth.js\";\nimport {\n\tgetOrCreateConversation,\n\tlistConversations,\n\tloadHistory,\n\tsaveMessages,\n\tupdateConversationTitle,\n} from \"../../services/ai/conversation.js\";\nimport { createAgent, toBaseMessages } from \"../../services/ai/graph.js\";\nimport { extractMemories } from \"../../services/ai/memory-extractor.js\";\nimport { checkInput, classifyIntent, processOutput } from \"../../services/ai/safety.js\";\nimport { createUserClient } from \"../../services/ai/supabase.js\";\n\nconst log = createLogger({ module: \"ai-chat\" });\n\nexport const aiRoutes = new Hono();\n\n// \u2500\u2500 AI Coach chat endpoint (SSE streaming) \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\naiRoutes.post(\"/chat\", async (c) => {\n\tconst body = await c.req.json();\n\n\t// \u2500\u2500 Input validation (Zod schema from @triathlon/types) \u2500\u2500\n\tconst parsed = ChatMessageInput.safeParse(body);\n\tif (!parsed.success) {\n\t\treturn c.json(\n\t\t\t{\n\t\t\t\terror: \"Validation failed\",\n\t\t\t\tissues: parsed.error.issues.map((i) => ({\n\t\t\t\t\tpath: i.path.join(\".\"),\n\t\t\t\t\tmessage: i.message,\n\t\t\t\t})),\n\t\t\t},\n\t\t\t400,\n\t\t);\n\t}\n\n\tconst { message, conversationId, imageUrls = [] } = parsed.data;\n\n\t// \u2500\u2500 Safety check \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\n\tconst safetyCheck = checkInput(message);\n\tif (safetyCheck.blocked) {\n\t\treturn c.json({\n\t\t\trole: \"assistant\",\n\t\t\tcontent: safetyCheck.response,\n\t\t\tconversationId: conversationId || crypto.randomUUID(),\n\t\t\tmetadata: {\n\t\t\t\tmodel: \"safety-guard\",\n\t\t\t\tblocked: true,\n\t\t\t\treason: safetyCheck.reason,\n\t\t\t},\n\t\t});\n\t}\n\n\t// \u2500\u2500 Validate AI config \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\n\tconst configCheck = validateAIConfig();\n\tif (!configCheck.valid) {\n\t\treturn c.json({\n\t\t\trole: \"assistant\",\n\t\t\tcontent:\n\t\t\t\t\"\u26A0\uFE0F AI Coach is not yet configured. Please set up the required environment variables.\",\n\t\t\tconversationId: conversationId || crypto.randomUUID(),\n\t\t\tmetadata: {\n\t\t\t\tmodel: \"none\",\n\t\t\t\terror: \"missing_config\",\n\t\t\t\tmissing: configCheck.missing,\n\t\t\t},\n\t\t});\n\t}\n\n\t// \u2500\u2500 Auth & Supabase client \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\n\tconst auth = getAuth(c);\n\tconst jwt = c.req.header(\"Authorization\")?.replace(\"Bearer \", \"\") || \"\";\n\t// User-scoped client \u2014 carries the user's JWT so auth.uid() works for RLS\n\tconst client = createUserClient(jwt);\n\n\t// \u2500\u2500 Conversation persistence \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\n\tconst conversation = await getOrCreateConversation(\n\t\tclient,\n\t\tauth.userId,\n\t\tauth.clubId,\n\t\tconversationId,\n\t);\n\n\t// Load history for context\n\tconst history = await loadHistory(client, conversation.id, AI_CONFIG.model.historyLimit);\n\n\t// Save user message and conditionally update title concurrently for lower latency\n\tconst userMsgMetadata = imageUrls.length > 0 ? { imageUrls } : undefined;\n\n\tconst savePromise = saveMessages(client, conversation.id, [\n\t\t{ role: \"user\", content: message, metadata: userMsgMetadata },\n\t]);\n\tconst titlePromise =\n\t\thistory.length === 0\n\t\t\t? updateConversationTitle(client, conversation.id, message)\n\t\t\t: Promise.resolve();\n\n\tawait Promise.all([savePromise, titlePromise]);\n\n\t// \u2500\u2500 Intent classification (for metadata) \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\n\tconst intent = classifyIntent(message);\n\n\t// \u2500\u2500 LangGraph agent invocation with SSE streaming \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\n\treturn streamSSE(c, async (stream) => {\n\t\t// Disable Azure App Service / IIS / ARR response buffering for SSE\n\t\tc.header(\"X-Accel-Buffering\", \"no\");\n\t\tc.header(\"Cache-Control\", \"no-cache, no-transform\");\n\t\ttry {\n\t\t\tconst agent = await createAgent(client, auth.userId, auth.clubId, message);\n\n\t\t\t// Build input with history + new user message\n\t\t\t// toBaseMessages handles multimodal content via metadata.imageUrls\n\t\t\tconst historyMessages = toBaseMessages(history);\n\n\t\t\t// Build the new user message \u2014 multimodal if images are attached\n\t\t\tconst userContent =\n\t\t\t\timageUrls.length > 0\n\t\t\t\t\t? [\n\t\t\t\t\t\t\t{ type: \"text\" as const, text: message },\n\t\t\t\t\t\t\t...imageUrls.map((url) => ({\n\t\t\t\t\t\t\t\ttype: \"image_url\" as const,\n\t\t\t\t\t\t\t\timage_url: { url },\n\t\t\t\t\t\t\t})),\n\t\t\t\t\t\t]\n\t\t\t\t\t: message;\n\n\t\t\tconst inputMessages = [...historyMessages, new HumanMessage({ content: userContent })];\n\n\t\t\tlet fullResponse = \"\";\n\t\t\tlet isRevisePass = false;\n\t\t\tlet notifiedReflection = false;\n\n\t\t\t// Stream the agent's response\n\t\t\tconst agentStream = await agent.stream(\n\t\t\t\t{ messages: inputMessages },\n\t\t\t\t{ streamMode: \"messages\" },\n\t\t\t);\n\n\t\t\t// Send conversation ID first\n\t\t\tawait stream.writeSSE({\n\t\t\t\tevent: \"metadata\",\n\t\t\t\tdata: JSON.stringify({\n\t\t\t\t\tconversationId: conversation.id,\n\t\t\t\t\tintent,\n\t\t\t\t\tathleteId: auth.userId,\n\t\t\t\t}),\n\t\t\t});\n\n\t\t\tfor await (const [msgChunk, metadata] of agentStream) {\n\t\t\t\t// Only stream content from the LLM node (not tool calls/results)\n\t\t\t\tif (\n\t\t\t\t\tmetadata.langgraph_node === \"llmCall\" &&\n\t\t\t\t\tmsgChunk.content &&\n\t\t\t\t\ttypeof msgChunk.content === \"string\"\n\t\t\t\t) {\n\t\t\t\t\tif (isRevisePass) {\n\t\t\t\t\t\t// Clear the frontend and reset our accumulated buffer for the new draft\n\t\t\t\t\t\tawait stream.writeSSE({ event: \"clear\", data: JSON.stringify({}) });\n\t\t\t\t\t\tfullResponse = \"\";\n\t\t\t\t\t\tisRevisePass = false;\n\t\t\t\t\t\tnotifiedReflection = false;\n\t\t\t\t\t}\n\n\t\t\t\t\tfullResponse += msgChunk.content;\n\t\t\t\t\tawait stream.writeSSE({\n\t\t\t\t\t\tevent: \"delta\",\n\t\t\t\t\t\tdata: JSON.stringify({ content: msgChunk.content }),\n\t\t\t\t\t});\n\t\t\t\t}\n\n\t\t\t\tif (metadata.langgraph_node === \"reflectNode\") {\n\t\t\t\t\tisRevisePass = true;\n\t\t\t\t\tif (!notifiedReflection) {\n\t\t\t\t\t\tnotifiedReflection = true;\n\t\t\t\t\t\tawait stream.writeSSE({\n\t\t\t\t\t\t\tevent: \"tool\",\n\t\t\t\t\t\t\tdata: JSON.stringify({\n\t\t\t\t\t\t\t\ttool: \"Self-Evaluation\",\n\t\t\t\t\t\t\t\tstatus: \"completed\",\n\t\t\t\t\t\t\t}),\n\t\t\t\t\t\t});\n\t\t\t\t\t}\n\t\t\t\t}\n\n\t\t\t\t// Notify frontend about tool usage\n\t\t\t\tif (metadata.langgraph_node === \"tools\" && msgChunk.name) {\n\t\t\t\t\tawait stream.writeSSE({\n\t\t\t\t\t\tevent: \"tool\",\n\t\t\t\t\t\tdata: JSON.stringify({\n\t\t\t\t\t\t\ttool: msgChunk.name,\n\t\t\t\t\t\t\tstatus: \"completed\",\n\t\t\t\t\t\t}),\n\t\t\t\t\t});\n\t\t\t\t}\n\t\t\t}\n\n\t\t\t// \u2500\u2500 Output safety processing \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\n\t\t\tconst processed = processOutput(fullResponse, {\n\t\t\t\tconfidence: 0.85,\n\t\t\t\thasMedicalContent: intent === \"medical\",\n\t\t\t});\n\n\t\t\t// If safety modified the output, send the corrected version\n\t\t\tif (processed.content !== fullResponse) {\n\t\t\t\tawait stream.writeSSE({\n\t\t\t\t\tevent: \"correction\",\n\t\t\t\t\tdata: JSON.stringify({ content: processed.content }),\n\t\t\t\t});\n\t\t\t\tfullResponse = processed.content;\n\t\t\t}\n\n\t\t\t// Save assistant response\n\t\t\tawait saveMessages(client, conversation.id, [\n\t\t\t\t{\n\t\t\t\t\trole: \"assistant\",\n\t\t\t\t\tcontent: fullResponse,\n\t\t\t\t\tmetadata: {\n\t\t\t\t\t\tmodel: AI_CONFIG.azure.deploymentName,\n\t\t\t\t\t\tintent,\n\t\t\t\t\t\tdisclaimerAdded: processed.disclaimerAdded,\n\t\t\t\t\t},\n\t\t\t\t},\n\t\t\t]);\n\n\t\t\t// Fire-and-forget: extract memories from this conversation turn\n\t\t\textractMemories(client, auth.userId, message, fullResponse).catch((err) =>\n\t\t\t\tlog.warn({ err }, \"Background memory extraction failed\"),\n\t\t\t);\n\n\t\t\t// Signal completion\n\t\t\tawait stream.writeSSE({\n\t\t\t\tevent: \"done\",\n\t\t\t\tdata: JSON.stringify({\n\t\t\t\t\tconversationId: conversation.id,\n\t\t\t\t\tdisclaimerAdded: processed.disclaimerAdded,\n\t\t\t\t}),\n\t\t\t});\n\t\t} catch (err) {\n\t\t\tlog.error({ err }, \"AI Agent error\");\n\t\t\tconst errorMessage =\n\t\t\t\t\"\u274C Sorry, I encountered an error processing your request. Please try again.\";\n\n\t\t\tawait stream.writeSSE({\n\t\t\t\tevent: \"error\",\n\t\t\t\tdata: JSON.stringify({ message: errorMessage }),\n\t\t\t});\n\n\t\t\t// Still save the error as a response for context\n\t\t\tawait saveMessages(client, conversation.id, [\n\t\t\t\t{ role: \"assistant\", content: errorMessage, metadata: { error: true } },\n\t\t\t]);\n\t\t}\n\t});\n});\n\n// \u2500\u2500 List conversations \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\naiRoutes.get(\"/conversations\", async (c) => {\n\tconst auth = getAuth(c);\n\tconst jwt = c.req.header(\"Authorization\")?.replace(\"Bearer \", \"\") || \"\";\n\tconst client = createUserClient(jwt);\n\n\tconst conversations = await listConversations(client, auth.userId);\n\n\treturn c.json({ conversations, athleteId: auth.userId });\n});\n", "/**\n * Planned Workout Types \u2014 Zod schemas and TypeScript types\n * for workout planning, scheduling, and AI plan generation.\n *\n * Uses Zod 4 APIs (consistent with the rest of @triathlon/types).\n */\n\nimport { z } from \"zod/v4\";\n\n// \u2500\u2500 Enums \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\n\nexport const ActivityType = z.enum([\"SWIM\", \"BIKE\", \"RUN\", \"STRENGTH\", \"YOGA\", \"OTHER\"]);\n\nexport const Intensity = z.enum([\"RECOVERY\", \"EASY\", \"MODERATE\", \"HARD\", \"MAX\"]);\n\nexport const PlannedWorkoutStatus = z.enum([\n\t\"planned\",\n\t\"completed\",\n\t\"skipped\",\n\t\"modified\",\n\t\"in_progress\",\n\t\"cancelled\",\n]);\n\nexport const WorkoutSource = z.enum([\"AI\", \"COACH\", \"MANUAL\"]);\n\n// \u2500\u2500 Session Data Schemas \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\n\nexport const ExerciseSet = z.object({\n\tsetNumber: z.number().int().min(1),\n\treps: z.number().int().min(1).optional(),\n\tweight: z.number().min(0).optional(),\n\tdurationSec: z.number().int().min(0).optional(),\n\tdistanceM: z.number().min(0).optional(),\n\trpe: z.number().min(1).max(10).optional(),\n\trest: z.number().int().min(0).optional(),\n\tnotes: z.string().optional(),\n});\nexport type ExerciseSet = z.infer<typeof ExerciseSet>;\n\nexport const Exercise = z.object({\n\tname: z.string().min(1),\n\tsets: z.array(ExerciseSet).min(1),\n\tnotes: z.string().optional(),\n\tsupersetWith: z.string().optional(),\n});\nexport type Exercise = z.infer<typeof Exercise>;\n\nexport const Interval = z.object({\n\tname: z.string(),\n\tdurationMin: z.number().optional(),\n\tdistanceKm: z.number().optional(),\n\ttargetPace: z.string().optional(),\n\ttargetHrZone: z.number().int().min(1).max(5).optional(),\n\ttargetRpe: z.number().min(1).max(10).optional(),\n\trepeat: z.number().int().min(1).default(1),\n\tnotes: z.string().optional(),\n});\nexport type Interval = z.infer<typeof Interval>;\n\nexport const SessionData = z.object({\n\texercises: z.array(Exercise).optional(),\n\tintervals: z.array(Interval).optional(),\n\twarmupMin: z.number().optional(),\n\tcooldownMin: z.number().optional(),\n\tnotes: z.string().optional(),\n});\nexport type SessionData = z.infer<typeof SessionData>;\n\n// \u2500\u2500 Planned Workout Schema \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\n\nexport const PlannedWorkout = z.object({\n\tid: z.uuid(),\n\tathleteId: z.uuid(),\n\tclubId: z.uuid(),\n\tplanId: z.uuid().nullable().optional(),\n\tworkoutId: z.uuid().nullable().optional(),\n\n\t// Scheduling\n\tplannedDate: z.string(),\n\tplannedTime: z.string().nullable().optional(),\n\n\t// Session definition\n\tactivityType: ActivityType,\n\ttitle: z.string().min(1),\n\tdescription: z.string().nullable().optional(),\n\tdurationMin: z.number().int().nullable().optional(),\n\tdistanceKm: z.number().nullable().optional(),\n\ttargetTss: z.number().nullable().optional(),\n\ttargetRpe: z.number().int().min(1).max(10).nullable().optional(),\n\tintensity: Intensity.nullable().optional(),\n\n\t// Structured data\n\tsessionData: SessionData.optional().default({}),\n\n\t// Status\n\tstatus: PlannedWorkoutStatus.default(\"planned\"),\n\n\t// Metadata\n\tsortOrder: z.number().int().default(0),\n\tnotes: z.string().nullable().optional(),\n\tcoachNotes: z.string().nullable().optional(),\n\tsource: WorkoutSource.default(\"MANUAL\"),\n\tcreatedAt: z.string().optional(),\n\tupdatedAt: z.string().optional(),\n});\nexport type PlannedWorkout = z.infer<typeof PlannedWorkout>;\n\n// \u2500\u2500 Create / Update DTOs \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\n\nexport const CreatePlannedWorkout = PlannedWorkout.omit({\n\tid: true,\n\tathleteId: true,\n\tclubId: true,\n\tworkoutId: true,\n\tcreatedAt: true,\n\tupdatedAt: true,\n});\nexport type CreatePlannedWorkout = z.infer<typeof CreatePlannedWorkout>;\n\nexport const UpdatePlannedWorkout = CreatePlannedWorkout.partial();\nexport type UpdatePlannedWorkout = z.infer<typeof UpdatePlannedWorkout>;\n\n// \u2500\u2500 AI Plan Generation Schemas \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\n\nexport const AiPlannedSession = z.object({\n\tdayOffset: z.number().int().min(0),\n\tactivityType: ActivityType,\n\ttitle: z.string(),\n\tdescription: z.string(),\n\tdurationMin: z.number().int().min(5),\n\tintensity: Intensity,\n\ttargetRpe: z.number().int().min(1).max(10).optional(),\n\tdistanceKm: z.number().optional(),\n\tsessionData: SessionData.optional(),\n});\nexport type AiPlannedSession = z.infer<typeof AiPlannedSession>;\n\nexport const AiWeeklyBlock = z.object({\n\tweekNumber: z.number().int().min(1),\n\ttheme: z.string(),\n\tsessions: z.array(AiPlannedSession).min(1),\n});\nexport type AiWeeklyBlock = z.infer<typeof AiWeeklyBlock>;\n\nexport const AiTrainingPlanOutput = z.object({\n\tname: z.string(),\n\tdurationWeeks: z.number().int().min(1).max(52),\n\tgoal: z.string(),\n\tweeks: z.array(AiWeeklyBlock).min(1),\n});\nexport type AiTrainingPlanOutput = z.infer<typeof AiTrainingPlanOutput>;\n\n// \u2500\u2500 DB <-> camelCase converters \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\n\nexport function dbRowToPlannedWorkout(row: Record<string, unknown>): PlannedWorkout {\n\treturn {\n\t\tid: row.id as string,\n\t\tathleteId: row.athlete_id as string,\n\t\tclubId: row.club_id as string,\n\t\tplanId: (row.plan_id as string) || null,\n\t\tworkoutId: (row.workout_id as string) || null,\n\t\tplannedDate: row.planned_date as string,\n\t\tplannedTime: (row.planned_time as string) || null,\n\t\tactivityType: row.activity_type as PlannedWorkout[\"activityType\"],\n\t\ttitle: row.title as string,\n\t\tdescription: (row.description as string) || null,\n\t\tdurationMin: (row.duration_min as number) || null,\n\t\tdistanceKm: (row.distance_km as number) || null,\n\t\ttargetTss: (row.target_tss as number) || null,\n\t\ttargetRpe: (row.target_rpe as number) || null,\n\t\tintensity: (row.intensity as PlannedWorkout[\"intensity\"]) || null,\n\t\tsessionData: (row.session_data as SessionData) || {},\n\t\tstatus: (row.status as PlannedWorkout[\"status\"]) || \"planned\",\n\t\tsortOrder: (row.sort_order as number) || 0,\n\t\tnotes: (row.notes as string) || null,\n\t\tcoachNotes: (row.coach_notes as string) || null,\n\t\tsource: (row.source as PlannedWorkout[\"source\"]) || \"MANUAL\",\n\t\tcreatedAt: row.created_at as string,\n\t\tupdatedAt: row.updated_at as string,\n\t};\n}\n\nexport function plannedWorkoutToDbRow(pw: Partial<CreatePlannedWorkout>) {\n\tconst row: Record<string, unknown> = {};\n\tif (pw.plannedDate !== undefined) row.planned_date = pw.plannedDate;\n\tif (pw.plannedTime !== undefined) row.planned_time = pw.plannedTime;\n\tif (pw.activityType !== undefined) row.activity_type = pw.activityType;\n\tif (pw.title !== undefined) row.title = pw.title;\n\tif (pw.description !== undefined) row.description = pw.description;\n\tif (pw.durationMin !== undefined) row.duration_min = pw.durationMin;\n\tif (pw.distanceKm !== undefined) row.distance_km = pw.distanceKm;\n\tif (pw.targetTss !== undefined) row.target_tss = pw.targetTss;\n\tif (pw.targetRpe !== undefined) row.target_rpe = pw.targetRpe;\n\tif (pw.intensity !== undefined) row.intensity = pw.intensity;\n\tif (pw.sessionData !== undefined) row.session_data = pw.sessionData;\n\tif (pw.status !== undefined) row.status = pw.status;\n\tif (pw.sortOrder !== undefined) row.sort_order = pw.sortOrder;\n\tif (pw.notes !== undefined) row.notes = pw.notes;\n\tif (pw.coachNotes !== undefined) row.coach_notes = pw.coachNotes;\n\tif (pw.source !== undefined) row.source = pw.source;\n\tif (pw.planId !== undefined) row.plan_id = pw.planId;\n\treturn row;\n}\n\n// \u2500\u2500 Display constants \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\n\nexport const ACTIVITY_COLORS = {\n\tSWIM: \"#3b82f6\",\n\tBIKE: \"#22c55e\",\n\tRUN: \"#f97316\",\n\tSTRENGTH: \"#a855f7\",\n\tYOGA: \"#ec4899\",\n\tOTHER: \"#6b7280\",\n} as const;\n\nexport const ACTIVITY_ICONS = {\n\tSWIM: \"\uD83C\uDFCA\",\n\tBIKE: \"\uD83D\uDEB4\",\n\tRUN: \"\uD83C\uDFC3\",\n\tSTRENGTH: \"\uD83C\uDFCB\uFE0F\",\n\tYOGA: \"\uD83E\uDDD8\",\n\tOTHER: \"\u26A1\",\n} as const;\n\nexport const INTENSITY_COLORS = {\n\tRECOVERY: \"#86efac\",\n\tEASY: \"#4ade80\",\n\tMODERATE: \"#facc15\",\n\tHARD: \"#f97316\",\n\tMAX: \"#ef4444\",\n} as const;\n", "/**\n * Zod Validation Schemas \u2014 Runtime input validation at API boundaries\n *\n * Uses Zod 4 APIs:\n *   - z.interface() for API inputs (better optional/undefined handling)\n *   - z.email(), z.uuid() top-level format helpers\n *   - .toJSONSchema() available on all schemas\n *\n * @see https://zod.dev\n */\n\nimport { z } from \"zod/v4\";\nimport { ActivityType, Intensity, PlannedWorkoutStatus, WorkoutSource } from \"./planned-workout.js\";\n\n// \u2500\u2500 String Sanitizers \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\n\n/** Strips HTML tags and trims whitespace */\nconst sanitizedString = z.string().transform((val) => val.replace(/<[^>]*>/g, \"\").trim());\n\n// \u2500\u2500 Chat Schemas \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\n\nexport const ChatMessageInput = z.object({\n\tmessage: sanitizedString.pipe(\n\t\tz\n\t\t\t.string()\n\t\t\t.min(1, \"Message cannot be empty\")\n\t\t\t.max(4000, \"Message too long (max 4000 characters)\"),\n\t),\n\tconversationId: z.uuid().optional(),\n\timageUrls: z.array(z.url()).max(3, \"Maximum 3 images allowed\").optional(),\n});\nexport type ChatMessageInput = z.infer<typeof ChatMessageInput>;\n\n// \u2500\u2500 Workout Schemas \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\nconst DataSource = z.enum([\n\t\"GARMIN\",\n\t\"POLAR\",\n\t\"WAHOO\",\n\t\"FORM\",\n\t\"MANUAL\",\n\t\"HEALTHKIT\",\n\t\"HEALTH_CONNECT\",\n]);\n\nexport const WorkoutInput = z.object({\n\tactivity_type: ActivityType,\n\tsource: DataSource,\n\tstarted_at: z.iso.datetime({ message: \"started_at must be ISO 8601 datetime\" }),\n\tduration_s: z.number().int().positive(),\n\tdistance_m: z.number().nonnegative(),\n\tavg_hr: z.number().int().min(30).max(250).optional(),\n\tmax_hr: z.number().int().min(30).max(250).optional(),\n\tavg_pace_s_km: z.number().positive().optional(),\n\tavg_power_w: z.number().nonnegative().optional(),\n\tcalories: z.number().int().nonnegative().optional(),\n\ttss: z.number().nonnegative().optional(),\n\traw_data: z.record(z.string(), z.unknown()).optional(),\n});\nexport type WorkoutInput = z.infer<typeof WorkoutInput>;\n\n// \u2500\u2500 Profile Schemas \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\n\nexport const ProfileUpdate = z.object({\n\tdisplay_name: sanitizedString.pipe(z.string().min(1).max(100)).optional(),\n\ttimezone: z.string().max(50).optional(),\n\tavatar_url: z.url().optional(),\n\tpreferences: z.record(z.string(), z.unknown()).optional(),\n});\nexport type ProfileUpdate = z.infer<typeof ProfileUpdate>;\n\n// \u2500\u2500 Daily Log Schemas \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\n\nexport const DailyLogInput = z.object({\n\tlog_date: z.iso.date(),\n\tsleep_hours: z.number().min(0).max(24).optional(),\n\tsleep_quality: z.number().int().min(1).max(10).optional(),\n\trpe: z.number().int().min(1).max(10).optional(),\n\tmood: z.number().int().min(1).max(10).optional(),\n\thrv: z.number().nonnegative().optional(),\n\tresting_hr: z.number().int().min(20).max(200).optional(),\n\tweight_kg: z.number().min(20).max(300).optional(),\n\tnotes: sanitizedString.pipe(z.string().max(2000)).optional(),\n});\nexport type DailyLogInput = z.infer<typeof DailyLogInput>;\n\n// \u2500\u2500 Injury Schemas \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\n\nexport const InjuryInput = z.object({\n\tbody_part: sanitizedString.pipe(z.string().min(1).max(100)),\n\tseverity: z.number().int().min(1).max(5),\n\tnotes: sanitizedString.pipe(z.string().max(2000)).optional(),\n});\nexport type InjuryInput = z.infer<typeof InjuryInput>;\n\n// \u2500\u2500 Planned Workout Schemas \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\n\nexport const PlannedWorkoutInput = z.object({\n\tplannedDate: z.iso.date({ message: \"plannedDate must be ISO date (YYYY-MM-DD)\" }),\n\tplannedTime: z.string().max(5).optional(),\n\tactivityType: ActivityType,\n\ttitle: sanitizedString.pipe(z.string().min(1).max(200)),\n\tdescription: sanitizedString.pipe(z.string().max(2000)).optional(),\n\tdurationMin: z.number().int().positive().optional(),\n\tdistanceKm: z.number().nonnegative().optional(),\n\ttargetTss: z.number().nonnegative().optional(),\n\ttargetRpe: z.number().int().min(1).max(10).optional(),\n\tintensity: Intensity.optional(),\n\tsessionData: z.record(z.string(), z.unknown()).optional(),\n\tsortOrder: z.number().int().nonnegative().optional(),\n\tnotes: sanitizedString.pipe(z.string().max(2000)).optional(),\n\tcoachNotes: sanitizedString.pipe(z.string().max(2000)).optional(),\n\tsource: WorkoutSource.optional(),\n\tplanId: z.uuid().optional(),\n});\nexport type PlannedWorkoutInput = z.infer<typeof PlannedWorkoutInput>;\n\nexport const PlannedWorkoutUpdate = z.object({\n\tplannedDate: z.iso.date().optional(),\n\tplannedTime: z.string().max(5).optional(),\n\tactivityType: ActivityType.optional(),\n\ttitle: sanitizedString.pipe(z.string().min(1).max(200)).optional(),\n\tdescription: sanitizedString.pipe(z.string().max(2000)).optional(),\n\tdurationMin: z.number().int().positive().optional(),\n\tdistanceKm: z.number().nonnegative().optional(),\n\ttargetTss: z.number().nonnegative().optional(),\n\ttargetRpe: z.number().int().min(1).max(10).optional(),\n\tintensity: Intensity.optional(),\n\tsessionData: z.record(z.string(), z.unknown()).optional(),\n\tstatus: PlannedWorkoutStatus.optional(),\n\tsortOrder: z.number().int().nonnegative().optional(),\n\tnotes: sanitizedString.pipe(z.string().max(2000)).optional(),\n\tcoachNotes: sanitizedString.pipe(z.string().max(2000)).optional(),\n});\nexport type PlannedWorkoutUpdate = z.infer<typeof PlannedWorkoutUpdate>;\n\n// \u2500\u2500 Webhook Schemas \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\n\nexport const WebhookPayload = z.object({\n\tsource: DataSource,\n\tpayload: z.record(z.string(), z.unknown()),\n\ttimestamp: z.iso.datetime().optional(),\n});\nexport type WebhookPayload = z.infer<typeof WebhookPayload>;\n\n// \u2500\u2500 Environment Validation \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\n\nexport const EnvSchema = z.object({\n\tNEXT_PUBLIC_SUPABASE_URL: z.url(),\n\tNEXT_PUBLIC_SUPABASE_ANON_KEY: z.string().min(1),\n\tSUPABASE_SERVICE_ROLE_KEY: z.string().min(1),\n\tSUPABASE_JWT_SECRET: z.string().min(1),\n\tAZURE_OPENAI_ENDPOINT: z.url().optional(),\n\tAZURE_OPENAI_API_KEY: z.string().optional(),\n\tAZURE_OPENAI_DEPLOYMENT: z.string().optional(),\n\tAZURE_OPENAI_API_VERSION: z.string().optional(),\n\tWEB_URL: z.url().optional(),\n\tAPI_URL: z.url().optional(),\n\tPORT: z.string().regex(/^\\d+$/).optional(),\n});\n", "// ============================================================\n// AI Agent Configuration\n// Centralizes all AI-related settings for easy swapping\n// ============================================================\n\nimport { createLogger } from \"../lib/logger.js\";\n\nconst log = createLogger({ module: \"ai-config\" });\n\nexport const AI_CONFIG = {\n\t/** Azure OpenAI deployment settings */\n\tazure: {\n\t\t/** Azure OpenAI resource endpoint, e.g. https://<resource>.openai.azure.com */\n\t\tendpoint: process.env.AZURE_OPENAI_ENDPOINT || \"\",\n\t\t/** Azure OpenAI API key */\n\t\tapiKey: process.env.AZURE_OPENAI_API_KEY || \"\",\n\t\t/** Deployment name for the chat model (e.g. \"gpt-5-mini\") */\n\t\tdeploymentName: process.env.AZURE_OPENAI_DEPLOYMENT || \"gpt-5-mini\",\n\t\t/** Deployment name for the embeddings model (e.g. \"text-embedding-3-small\") */\n\t\tembeddingsDeployment:\n\t\t\tprocess.env.AZURE_OPENAI_EMBEDDINGS_DEPLOYMENT || \"text-embedding-3-small\",\n\t\t/** API version \u2014 preview (supports gpt-5-mini on AIServices) */\n\t\tapiVersion: process.env.AZURE_OPENAI_API_VERSION || \"2024-12-01-preview\",\n\t},\n\n\t/** Model behavior */\n\tmodel: {\n\t\t/** gpt-5-mini only supports temperature=1 (the default) */\n\t\ttemperature: 1,\n\t\tmaxCompletionTokens: 2048,\n\t\t/** Max messages to load from conversation history for context */\n\t\thistoryLimit: 40,\n\t},\n\n\t/** Safety thresholds */\n\tsafety: {\n\t\t/** Minimum confidence to skip disclaimer */\n\t\tconfidenceThreshold: 0.7,\n\t\t/** Max user message length (chars) */\n\t\tmaxInputLength: 4000,\n\t},\n\n\t/** Feature flags */\n\tfeatures: {\n\t\t/** Enable SSE streaming responses */\n\t\tstreaming: true,\n\t\t/** Enable RAG document retrieval (future) */\n\t\tragEnabled: false,\n\t\t/** Require user confirmation before write operations */\n\t\tconfirmWrites: true,\n\t\t/** Enable vision/image analysis via GPT-5-mini */\n\t\tvisionEnabled: true,\n\t},\n\n\t/** File/image upload limits */\n\tuploads: {\n\t\t/** Maximum file size in megabytes */\n\t\tmaxFileSizeMB: 10,\n\t\t/** Allowed MIME types for image uploads */\n\t\tallowedImageTypes: [\"image/jpeg\", \"image/png\", \"image/webp\", \"image/gif\"] as readonly string[],\n\t\t/** Max images per message */\n\t\tmaxImagesPerMessage: 3,\n\t\t/** Supabase Storage bucket name */\n\t\tstorageBucket: \"chat-images\",\n\t},\n} as const;\n\n/** Validate that required env vars are set \u2014 warns at startup */\nexport function validateAIConfig(): { valid: boolean; missing: string[] } {\n\tconst missing: string[] = [];\n\n\tif (!AI_CONFIG.azure.endpoint) missing.push(\"AZURE_OPENAI_ENDPOINT\");\n\tif (!AI_CONFIG.azure.apiKey) missing.push(\"AZURE_OPENAI_API_KEY\");\n\n\tif (missing.length > 0) {\n\t\tlog.warn(\n\t\t\t{ missing },\n\t\t\t\"AI Agent: Missing env vars \u2014 agent will not function until these are set\",\n\t\t);\n\t}\n\n\treturn { valid: missing.length === 0, missing };\n}\n", "// ============================================================\n// Conversation Persistence Service\n// CRUD for conversations & messages tables\n// ============================================================\n\nimport type { SupabaseClient } from \"@supabase/supabase-js\";\n\nexport interface Conversation {\n\tid: string;\n\tathlete_id: string;\n\tclub_id: string;\n\ttitle: string | null;\n\tcreated_at: string;\n}\n\nexport interface ChatMessage {\n\tid: string;\n\tconversation_id: string;\n\trole: \"user\" | \"assistant\" | \"system\";\n\tcontent: string;\n\tmetadata: Record<string, unknown> | null;\n\tcreated_at: string;\n}\n\n/**\n * Gets an existing conversation or creates a new one.\n */\nexport async function getOrCreateConversation(\n\tclient: SupabaseClient,\n\tuserId: string,\n\tclubId: string,\n\tconversationId?: string,\n): Promise<Conversation> {\n\t// If an ID was provided, try to fetch it\n\tif (conversationId) {\n\t\tconst { data, error } = await client\n\t\t\t.from(\"conversations\")\n\t\t\t.select(\"*\")\n\t\t\t.eq(\"id\", conversationId)\n\t\t\t.eq(\"athlete_id\", userId)\n\t\t\t.single();\n\n\t\tif (data && !error) return data;\n\t\t// If not found, fall through to create\n\t}\n\n\t// Create a new conversation\n\tconst { data, error } = await client\n\t\t.from(\"conversations\")\n\t\t.insert({ athlete_id: userId, club_id: clubId })\n\t\t.select()\n\t\t.single();\n\n\tif (error) throw new Error(`Failed to create conversation: ${error.message}`);\n\treturn data;\n}\n\n/**\n * Loads message history for a conversation, ordered oldest-first.\n */\nexport async function loadHistory(\n\tclient: SupabaseClient,\n\tconversationId: string,\n\tlimit = 40,\n): Promise<ChatMessage[]> {\n\tconst { data, error } = await client\n\t\t.from(\"messages\")\n\t\t.select(\"*\")\n\t\t.eq(\"conversation_id\", conversationId)\n\t\t.order(\"created_at\", { ascending: true })\n\t\t.limit(limit);\n\n\tif (error) throw new Error(`Failed to load message history: ${error.message}`);\n\treturn data ?? [];\n}\n\n/**\n * Persists one or more messages to the conversation.\n */\nexport async function saveMessages(\n\tclient: SupabaseClient,\n\tconversationId: string,\n\tmessages: Array<{\n\t\trole: \"user\" | \"assistant\" | \"system\";\n\t\tcontent: string;\n\t\tmetadata?: Record<string, unknown>;\n\t}>,\n): Promise<void> {\n\tconst rows = messages.map((m) => ({\n\t\tconversation_id: conversationId,\n\t\trole: m.role,\n\t\tcontent: m.content,\n\t\tmetadata: m.metadata ?? null,\n\t}));\n\n\tconst { error } = await client.from(\"messages\").insert(rows);\n\tif (error) throw new Error(`Failed to save messages: ${error.message}`);\n}\n\n/**\n * Generates a short title from the first user message (for sidebar display).\n */\nexport async function updateConversationTitle(\n\tclient: SupabaseClient,\n\tconversationId: string,\n\tfirstMessage: string,\n): Promise<void> {\n\tconst title = firstMessage.length > 60 ? `${firstMessage.slice(0, 57)}...` : firstMessage;\n\n\tawait client.from(\"conversations\").update({ title }).eq(\"id\", conversationId);\n}\n\n/**\n * Lists recent conversations for the sidebar.\n * Uses Supabase relation query to get message counts in a single round-trip.\n */\nexport async function listConversations(\n\tclient: SupabaseClient,\n\tuserId: string,\n\tlimit = 20,\n): Promise<\n\tArray<{\n\t\tid: string;\n\t\ttitle: string | null;\n\t\tcreated_at: string;\n\t\tmessage_count: number;\n\t}>\n> {\n\tconst { data, error } = await client\n\t\t.from(\"conversations\")\n\t\t.select(\"id, title, created_at, messages(count)\")\n\t\t.eq(\"athlete_id\", userId)\n\t\t.order(\"created_at\", { ascending: false })\n\t\t.limit(limit);\n\n\tif (error) throw new Error(`Failed to list conversations: ${error.message}`);\n\n\treturn (data ?? []).map((conv) => ({\n\t\tid: conv.id,\n\t\ttitle: conv.title,\n\t\tcreated_at: conv.created_at,\n\t\tmessage_count: (conv.messages as Array<{ count: number }>)?.[0]?.count ?? 0,\n\t}));\n}\n", "// ============================================================\n// LangGraph Agent \u2014 ReAct StateGraph\n// The core orchestration: LLM \u2194 Tools loop with streaming\n// ============================================================\n\nimport { AIMessage, type BaseMessage, HumanMessage, SystemMessage } from \"@langchain/core/messages\";\nimport { END, MessagesAnnotation, StateGraph } from \"@langchain/langgraph\";\nimport { ToolNode } from \"@langchain/langgraph/prebuilt\";\nimport { AzureChatOpenAI } from \"@langchain/openai\";\nimport type { SupabaseClient } from \"@supabase/supabase-js\";\nimport { AI_CONFIG } from \"../../config/ai.js\";\nimport { createLogger } from \"../../lib/logger.js\";\n\nconst log = createLogger({ module: \"langgraph-agent\" });\n\nimport { buildSystemPrompt } from \"./prompt.js\";\nimport {\n\ttype AthleteMemory,\n\tgetDailyLogs,\n\tgetProfile,\n\tgetRecentMemories,\n\tsearchMemoriesBySimilarity,\n} from \"./supabase.js\";\nimport { createAllTools } from \"./tools/index.js\";\n\n/**\n * Creates a compiled LangGraph agent for a specific user session.\n *\n * Architecture:\n *   \u250C\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510     tool_calls     \u250C\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n *   \u2502 llmCall  \u2502 \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u25BA \u2502 toolNode  \u2502\n *   \u2502          \u2502 \u25C4\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500 \u2502           \u2502\n *   \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518    tool results     \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n *        \u2502\n *        \u2502 no tool_calls\n *        \u25BC\n *      [END]\n */\nexport async function createAgent(\n\tclient: SupabaseClient,\n\tuserId: string,\n\tclubId: string,\n\tuserMessage?: string,\n) {\n\t// Load profile + today's readiness data + pinned memories concurrently for faster initialization\n\tconst today = new Date().toISOString().split(\"T\")[0];\n\n\tconst [profile, pinnedMemories, dailyLogs] = await Promise.all([\n\t\tgetProfile(client, userId),\n\t\tgetRecentMemories(client, userId, 5), // Top-5 most important pinned memories\n\t\tgetDailyLogs(client, userId, {\n\t\t\tfromDate: today,\n\t\t\ttoDate: today,\n\t\t\tlimit: 1,\n\t\t}),\n\t]);\n\n\tconst todayLog = dailyLogs.length > 0 ? dailyLogs[0] : null;\n\n\t// Semantic memory recall: embed user message and find relevant memories\n\tconst allMemories: AthleteMemory[] = [...pinnedMemories];\n\n\tif (userMessage) {\n\t\ttry {\n\t\t\tconst { AzureOpenAIEmbeddings } = await import(\"@langchain/openai\");\n\t\t\tconst embeddingsModel = new AzureOpenAIEmbeddings({\n\t\t\t\tazureOpenAIApiKey: AI_CONFIG.azure.apiKey,\n\t\t\t\tazureOpenAIApiInstanceName: AI_CONFIG.azure.endpoint.split(\".\")[0].replace(\"https://\", \"\"),\n\t\t\t\tazureOpenAIApiDeploymentName: AI_CONFIG.azure.embeddingsDeployment,\n\t\t\t\tazureOpenAIApiVersion: AI_CONFIG.azure.apiVersion,\n\t\t\t});\n\n\t\t\tconst queryEmbedding = await embeddingsModel.embedQuery(userMessage);\n\t\t\tconst semanticResults = await searchMemoriesBySimilarity(client, userId, queryEmbedding, {\n\t\t\t\tmatchThreshold: 0.4,\n\t\t\t\tmatchCount: 8,\n\t\t\t});\n\n\t\t\t// Merge semantic results with pinned, deduplicate by content\n\t\t\tconst pinnedContents = new Set(pinnedMemories.map((m) => m.content));\n\t\t\tfor (const result of semanticResults) {\n\t\t\t\tif (!pinnedContents.has(result.content)) {\n\t\t\t\t\tallMemories.push({\n\t\t\t\t\t\tid: result.id,\n\t\t\t\t\t\tathlete_id: userId,\n\t\t\t\t\t\tcategory: result.category,\n\t\t\t\t\t\tcontent: result.content,\n\t\t\t\t\t\timportance: result.importance,\n\t\t\t\t\t\tcreated_at: \"\",\n\t\t\t\t\t\tupdated_at: \"\",\n\t\t\t\t\t});\n\t\t\t\t}\n\t\t\t}\n\t\t} catch (err) {\n\t\t\t// Semantic search is best-effort \u2014 don't break the agent if it fails\n\t\t\tlog.warn({ err }, \"Semantic memory recall failed (non-fatal)\");\n\t\t}\n\t}\n\n\t// Create LLM instance \u2014 uses AzureChatOpenAI for Azure Foundry compatibility\n\tconst llm = new AzureChatOpenAI({\n\t\tazureOpenAIEndpoint: AI_CONFIG.azure.endpoint,\n\t\tazureOpenAIApiKey: AI_CONFIG.azure.apiKey,\n\t\tazureOpenAIApiDeploymentName: AI_CONFIG.azure.deploymentName,\n\t\tazureOpenAIApiVersion: AI_CONFIG.azure.apiVersion,\n\t\ttemperature: AI_CONFIG.model.temperature,\n\t\tstreaming: AI_CONFIG.features.streaming,\n\t\t// gpt-5-mini requires max_completion_tokens instead of max_tokens\n\t\tmodelKwargs: { max_completion_tokens: AI_CONFIG.model.maxCompletionTokens },\n\t});\n\n\t// Create tools bound to user context\n\tconst tools = createAllTools(client, userId, clubId);\n\n\t// Bind tools to the LLM\n\tconst llmWithTools = llm.bindTools(tools);\n\n\t// Build the system prompt\n\tconst systemMessage = new SystemMessage(buildSystemPrompt(profile, todayLog, allMemories));\n\n\t// \u2500\u2500 Define graph nodes \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\n\n\t/** LLM call node: injects system prompt + invokes the model */\n\tasync function llmCall(state: typeof MessagesAnnotation.State) {\n\t\t// Prepend system message to the conversation\n\t\tconst messagesWithSystem = [systemMessage, ...state.messages];\n\n\t\tconst response = await llmWithTools.invoke(messagesWithSystem);\n\n\t\treturn { messages: [response] };\n\t}\n\n\t/** Reflection node: evaluates the draft response */\n\tasync function reflectNode(state: typeof MessagesAnnotation.State) {\n\t\tconst lastMessage = state.messages[state.messages.length - 1];\n\t\tif (!lastMessage || lastMessage._getType() !== \"ai\" || !lastMessage.content) {\n\t\t\treturn { messages: [] };\n\t\t}\n\n\t\tconst reflectionPrompt = new SystemMessage(\n\t\t\t`You are a Head Coach reviewing an AI assistant's drafted response to an athlete.\nEvaluate the draft below for tone, safety, accuracy, and conciseness.\nDoes it directly answer the user's question without rambling?\nIf the draft is good, reply with exactly \"ACCEPT\".\nIf the draft needs changes, provide a brief, actionable critique for the assistant to revise it.\nDo NOT rewrite the response yourself, just provide the critique.`,\n\t\t);\n\n\t\tconst response = await llm.invoke([\n\t\t\treflectionPrompt,\n\t\t\tnew HumanMessage(`Draft response:\\n${lastMessage.content}`),\n\t\t]);\n\n\t\tconst critique = typeof response.content === \"string\" ? response.content.trim() : \"\";\n\n\t\t// If accepted, route to END\n\t\tif (critique.toUpperCase() === \"ACCEPT\" || critique.includes(\"ACCEPT\")) {\n\t\t\treturn { messages: [] };\n\t\t}\n\n\t\t// If critiqued, add it as a user message so the llmCall sees the feedback and regenerates\n\t\treturn {\n\t\t\tmessages: [\n\t\t\t\tnew HumanMessage(`Head Coach critique: ${critique}. Please revise your response.`),\n\t\t\t],\n\t\t};\n\t}\n\n\t/** Route: check if the LLM wants to call tools or is done drafting */\n\tfunction shouldContinue(state: typeof MessagesAnnotation.State): \"tools\" | \"reflectNode\" {\n\t\tconst lastMessage = state.messages[state.messages.length - 1];\n\n\t\t// If the last message has tool_calls, route to the tool node\n\t\tif (\n\t\t\tlastMessage &&\n\t\t\t\"tool_calls\" in lastMessage &&\n\t\t\t(lastMessage as AIMessage).tool_calls &&\n\t\t\t((lastMessage as AIMessage).tool_calls?.length ?? 0) > 0\n\t\t) {\n\t\t\treturn \"tools\";\n\t\t}\n\n\t\treturn \"reflectNode\";\n\t}\n\n\t/** Route: check if reflection accepted the draft */\n\tfunction checkReflection(state: typeof MessagesAnnotation.State): \"llmCall\" | typeof END {\n\t\tconst lastMessage = state.messages[state.messages.length - 1];\n\n\t\t// If the last message is from Human (the critique), we must regenerate\n\t\tif (\n\t\t\tlastMessage &&\n\t\t\tlastMessage._getType() === \"human\" &&\n\t\t\ttypeof lastMessage.content === \"string\" &&\n\t\t\tlastMessage.content.includes(\"Head Coach critique:\")\n\t\t) {\n\t\t\treturn \"llmCall\";\n\t\t}\n\n\t\treturn END;\n\t}\n\n\t// \u2500\u2500 Build the graph \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\n\n\tconst toolNode = new ToolNode(tools);\n\n\tconst graph = new StateGraph(MessagesAnnotation)\n\t\t.addNode(\"llmCall\", llmCall)\n\t\t.addNode(\"tools\", toolNode)\n\t\t.addNode(\"reflectNode\", reflectNode)\n\t\t.addEdge(\"__start__\", \"llmCall\")\n\t\t.addConditionalEdges(\"llmCall\", shouldContinue, {\n\t\t\ttools: \"tools\",\n\t\t\treflectNode: \"reflectNode\",\n\t\t})\n\t\t.addConditionalEdges(\"reflectNode\", checkReflection, {\n\t\t\tllmCall: \"llmCall\",\n\t\t\t[END]: END,\n\t\t})\n\t\t.addEdge(\"tools\", \"llmCall\")\n\t\t.compile();\n\n\treturn graph;\n}\n\n/**\n * Converts stored chat history into LangChain message objects.\n * Supports multimodal messages \u2014 when metadata.imageUrls is present,\n * builds a content array with text + image_url items for vision models.\n */\nexport function toBaseMessages(\n\thistory: Array<{\n\t\trole: string;\n\t\tcontent: string;\n\t\tmetadata?: Record<string, unknown> | null;\n\t}>,\n): BaseMessage[] {\n\treturn history.map((msg) => {\n\t\t// Build multimodal content when images are attached\n\t\tconst imageUrls = (msg.metadata?.imageUrls as string[] | undefined) ?? [];\n\t\tconst content =\n\t\t\tmsg.role === \"user\" && imageUrls.length > 0\n\t\t\t\t? [\n\t\t\t\t\t\t{ type: \"text\" as const, text: msg.content },\n\t\t\t\t\t\t...imageUrls.map((url) => ({\n\t\t\t\t\t\t\ttype: \"image_url\" as const,\n\t\t\t\t\t\t\timage_url: { url },\n\t\t\t\t\t\t})),\n\t\t\t\t\t]\n\t\t\t\t: msg.content;\n\n\t\tswitch (msg.role) {\n\t\t\tcase \"user\":\n\t\t\t\treturn new HumanMessage({ content });\n\t\t\tcase \"assistant\":\n\t\t\t\treturn new AIMessage(msg.content);\n\t\t\tcase \"system\":\n\t\t\t\treturn new SystemMessage(msg.content);\n\t\t\tdefault:\n\t\t\t\treturn new HumanMessage({ content });\n\t\t}\n\t});\n}\n", "// ============================================================\n// Dynamic System Prompt Builder\n// Constructs the coaching persona with user context,\n// daily readiness data, and prescriptive coaching rules.\n// ============================================================\n\nimport type { AthleteMemory, AthleteProfile, DailyLog } from \"./supabase.js\";\n\n/**\n * Builds the system prompt for the AI coaching agent.\n * Injects user context and daily readiness data so the LLM\n * has immediate awareness before the athlete speaks.\n */\nexport function buildSystemPrompt(\n\tprofile: AthleteProfile | null,\n\ttodayLog: DailyLog | null = null,\n\tmemories: AthleteMemory[] = [],\n): string {\n\tconst userContext = profile\n\t\t? `\n## Current Athlete Context\n- **Name**: ${profile.display_name || \"Athlete\"}\n- **Timezone**: ${profile.timezone || \"UTC\"}\n- **Role**: ${profile.role}\n`\n\t\t: `\\n## Current Athlete Context\\nNo profile data loaded yet. Ask the athlete about their goals and background.\\n`;\n\n\tconst readinessContext = todayLog\n\t\t? `\n## Today's Readiness\n- Sleep: ${todayLog.sleep_hours ?? \"?\"}h (quality: ${todayLog.sleep_quality ?? \"?\"}/5)\n- Mood: ${todayLog.mood ?? \"?\"}/5\n- HRV: ${todayLog.hrv ?? \"not recorded\"} ms\n- Resting HR: ${todayLog.resting_hr ?? \"not recorded\"} bpm\n- Yesterday's RPE: ${todayLog.rpe ?? \"n/a\"}\n\nIf sleep is poor (<6h) or HRV is noticeably low, **proactively** mention it in your first response and suggest acting on it (e.g. \"I see you didn't sleep well, maybe we should swap today's interval run for an easy spin?\"). Use your \\`analyze_biometric_trends\\` or \\`predict_injury_risk\\` tools if you suspect they are overtraining.`\n\t\t: \"\";\n\n\tconst memoriesContext =\n\t\tmemories.length > 0\n\t\t\t? `\n## Athlete Memory & Context\nHere is what you know about this athlete from past conversations:\n${memories.map((m) => `- ${m.content}`).join(\"\\n\")}\n\nUse these facts to personalize your responses, remember their preferences, and avoid asking them things they've already told you. Do not list these facts back to them, just act on them naturally.`\n\t\t\t: \"\";\n\n\treturn `${BASE_PROMPT}\n${userContext}\n${readinessContext}\n${memoriesContext}\n${PERSONALIZATION}\n${STRENGTH_COACHING}\n${TRAINING_PLAN_COACHING}\n${GAMIFICATION_COACHING}\n${TOOL_GUIDELINES}\n${SAFETY_RULES}`;\n}\n\n// \u2500\u2500 Prompt sections \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\n\nconst BASE_PROMPT = `# AI Coaching Agent \u2014 JPX Workout\n\nYou are a fun, encouraging training buddy built into the JPX Workout app. Think of yourself as the friend who happens to know a ton about triathlon, strength training, and sports science \u2014 but never lectures.\n\n## Your Capabilities\nYou can read workouts, health metrics, training plans, injuries, and events. You can log workouts, update soreness/health, modify plans, generate structured multi-week training plans, schedule individual sessions, analyze progress, and estimate 1RM.\n\n## Communication Style \u2014 THIS IS CRITICAL\n- **Keep messages SHORT** \u2014 2-3 sentences max per response. No walls of text.\n- **One topic at a time.** Don't cover everything in one message. Let the conversation flow naturally.\n- **Be conversational and warm.** Use casual language, like texting a friend. Not a textbook.\n- **Use natural time references** \u2014 say \"today\", \"yesterday\", \"last week\", \"a couple days ago\". NEVER output raw dates like \"2026-02-19\" or ISO formats.\n- **Emojis are great** \u2014 use them naturally (\uD83D\uDCAA\uD83D\uDD25\uD83C\uDFCA\uD83D\uDEB4\uD83C\uDFC3\uD83C\uDF89) but don't overdo it.\n- **Don't recite data back** \u2014 instead of \"Your HRV was 45ms, sleep was 6.2h, mood was 3/5\", say something like \"Looks like you didn't sleep great \u2014 maybe go easier today?\"\n- **Celebrate wins!** PRs, consistency streaks, showing up on a tough day \u2014 hype them up.\n- **Ask follow-up questions** to keep the conversation going rather than dumping info.\n- Sound human. Vary your responses. Don't start every message the same way.`;\n\nconst PERSONALIZATION = `\n## Personalization \u2014 How to Use Memories\nYou remember this athlete from past conversations. Act like a coach who knows them well.\n\n### Acting on Memory Categories\n- **preference** \u2192 Adapt your style (e.g., if they prefer bullet points, use them; if they like brief answers, keep it short)\n- **goal** \u2192 Frame advice toward their goal without repeating it every message (e.g., if training for Ironman, bias toward endurance)\n- **constraint** \u2192 Never suggest things they can't do (e.g., if they have a bad knee, don't recommend deep squats)\n- **pattern** \u2192 Reference their routines naturally (\"Since you usually train mornings, how about...\")\n- **medical_note** \u2192 Apply extra caution and always defer to medical professionals\n\n### Rules\n- **Never ask something you already know.** Check your memories first. If you know their goal, don't ask \"What are you training for?\"\n- **Reference past context naturally** \u2014 \"Last time you mentioned your knee bugging you \u2014 how's it doing?\" NOT \"According to my records, you reported knee pain on...\"\n- **Don't announce memories** \u2014 Don't say \"I remember that you...\" Just act on them seamlessly.\n- **Adapt over time** \u2014 If they correct you or express a preference, adjust immediately and remember it.\n- **When in doubt, ask** \u2014 But only ask things you genuinely don't know yet.`;\n\nconst STRENGTH_COACHING = `\n## Strength Coaching\n\n### Logging Workouts\n- Walk through exercises **one at a time** \u2014 don't ask for everything upfront\n- Keep it casual: \"Nice, what weight did you use?\" not \"Please provide the load in kilograms.\"\n- If RPE is high (\u22659), gently suggest backing off. If low (\u22646), nudge them to go heavier.\n- For supersets/circuits, use group_id and group_type internally\n\n### After a Workout\n- Check recent history with \\`get_workout_history\\` to spot trends\n- If they hit a PR \u2192 celebrate it! \uD83C\uDF89\uD83D\uDD25\n- If RPE is creeping up at same weight \u2192 mention it casually, maybe suggest a deload\n- Keep the summary to 1-2 lines, not a table. Save detailed breakdowns for when they ask.\n\n### Reading the Room\n- Bad sleep or low mood? Suggest going lighter \u2014 don't push.\n- Feeling great? Encourage them to chase a PR.\n- No readiness data? Just ask \"How are you feeling today?\" before jumping in.`;\n\nconst TRAINING_PLAN_COACHING = `\n## Training Plan Coaching\n\n### Generating Plans\n- When the athlete asks for a training plan, race prep, or structured program \u2192 use \\`generate_workout_plan\\`\n- Ask about their goal, timeline, and availability FIRST \u2014 don't guess\n- Once generated, briefly summarize (plan name, # sessions, start date) and tell them to check the calendar\n- The plan auto-starts on the coming Monday and follows periodization principles\n\n### Scheduling Individual Sessions\n- For quick adds like \"add a run tomorrow\" or \"schedule strength on Friday\" \u2192 use \\`schedule_workout\\`\n- Keep it snappy \u2014 confirm the workout was scheduled and move on\n- If they have an active plan, the session auto-links to it\n\n### Modifying Plans\n- Use \\`modify_training_plan\\` for changing existing plans (swap days, adjust intensity, skip weeks)\n- Before making changes, briefly confirm what they want changed: \"Move your long run to Sunday instead?\"\n- After changes, let them know it's reflected in the calendar`;\n\nconst GAMIFICATION_COACHING = `\n## Social & Gamification\n\n### Squad Leaderboards\n- When the user asks how they are doing compared to their friends or squad, or needs motivation, use \\`get_squad_leaderboard\\`\n- Hype up the competition! E.g. \"You're only 20 minutes behind Alex this week! Let's get that run in.\"\n- If they are #1, congratulate them for leading the pack.\n\n### Relay Events (Pass the Baton)\n- If they mention completing a leg of a relay or wanting to pass the baton, use \\`pass_baton\\`\n- You can get the target athlete IDs from the leaderboard if you need to pass it to someone specific (e.g. \"pass it to Alex\")\n- Confirm the handoff with a fun, team-oriented message! \uD83C\uDFC3\u200D\u2642\uFE0F\uD83D\uDCA8`;\n\nconst TOOL_GUIDELINES = `\n## Tool Usage\n- Look up data before giving advice \u2014 don't guess.\n- Before saving anything, give a quick summary and ask \"Sound good?\" Keep the confirmation casual and short.\n- When they say \"yeah\", \"do it\", \"log it\" \u2014 go ahead and save.\n- For progress questions, pull their history first.\n- For injury/pain questions, check the injuries table before responding.`;\n\nconst SAFETY_RULES = `\n## Safety\n- Don't diagnose \u2014 if something sounds medical, suggest they see a professional.\n- No specific supplement/medication recs.\n- Chest pain, breathing issues, severe injury \u2192 tell them to call emergency services immediately.\n- Only access this athlete's data.\n- For injury/nutrition topics, keep it light: \"not a doctor, but...\" style.`;\n", "// ============================================================\n// Server-side Supabase Client for AI Agent\n// Creates authenticated clients for data access.\n// Designed as reusable service layer \u2014 tools are thin wrappers.\n// Future: expose same functions via REST for external agents.\n// ============================================================\n\nimport { createClient, type SupabaseClient } from \"@supabase/supabase-js\";\nimport { createLogger } from \"../../lib/logger.js\";\n\nconst log = createLogger({ module: \"ai-supabase\" });\n\nconst SUPABASE_URL = process.env.SUPABASE_URL || \"\";\nconst SUPABASE_ANON_KEY = process.env.SUPABASE_ANON_KEY || \"\";\nconst SUPABASE_SERVICE_ROLE_KEY = process.env.SUPABASE_SERVICE_ROLE_KEY || \"\";\n\n/**\n * Creates a Supabase admin client (bypasses RLS).\n * Use sparingly \u2014 prefer user-scoped client when possible.\n */\nexport function createAdminClient(): SupabaseClient {\n\treturn createClient(SUPABASE_URL, SUPABASE_SERVICE_ROLE_KEY, {\n\t\tauth: { persistSession: false },\n\t});\n}\n\n/**\n * Creates a Supabase client scoped to a specific user's JWT.\n * Uses the anon key so RLS policies are enforced and auth.jwt()\n * correctly returns the user's token claims (including app_metadata).\n * The service_role key bypasses RLS, which breaks requesting_club_id().\n */\nexport function createUserClient(userJwt: string): SupabaseClient {\n\treturn createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {\n\t\tauth: { persistSession: false },\n\t\tglobal: {\n\t\t\theaders: { Authorization: `Bearer ${userJwt}` },\n\t\t},\n\t});\n}\n\n// \u2500\u2500 Typed interfaces matching DB schema (00002_create_core_tables.sql) \u2500\u2500\n\nexport interface AthleteProfile {\n\tid: string;\n\tclub_id: string;\n\trole: string;\n\tdisplay_name: string | null;\n\tavatar_url: string | null;\n\ttimezone: string;\n\tpreferences: Record<string, unknown>;\n\tcreated_at: string;\n\tupdated_at: string;\n}\n\nexport interface Workout {\n\tid: string;\n\tathlete_id: string;\n\tclub_id: string;\n\tactivity_type: string;\n\tsource: string;\n\tstarted_at: string;\n\tduration_s: number | null;\n\tdistance_m: number | null;\n\tavg_hr: number | null;\n\tmax_hr: number | null;\n\tavg_pace_s_km: number | null;\n\tavg_power_w: number | null;\n\tcalories: number | null;\n\ttss: number | null;\n\traw_data: Record<string, unknown> | null;\n\tnotes: string | null;\n\tembedding?: number[];\n\tcreated_at: string;\n}\n\nexport interface DailyLog {\n\tid: string;\n\tathlete_id: string;\n\tclub_id: string;\n\tlog_date: string;\n\tsleep_hours: number | null;\n\tsleep_quality: number | null;\n\trpe: number | null;\n\tmood: number | null;\n\thrv: number | null;\n\tresting_hr: number | null;\n\tweight_kg: number | null;\n\tnotes: string | null;\n\tcreated_at: string;\n}\n\nexport interface TrainingPlan {\n\tid: string;\n\tathlete_id: string;\n\tclub_id: string;\n\tevent_id: string | null;\n\tname: string;\n\tstatus: string;\n\tplan_data: unknown; // JSONB\n\tcreated_at: string;\n}\n\nexport interface HealthMetric {\n\tid: string;\n\tathlete_id: string;\n\tclub_id: string;\n\tmetric_type: string;\n\tvalue: number;\n\tunit: string | null;\n\trecorded_at: string;\n\tsource: string | null;\n\traw_data: Record<string, unknown> | null;\n\tcreated_at: string;\n}\n\nexport interface AthleteMemory {\n\tid: string;\n\tathlete_id: string;\n\tcategory: string;\n\tcontent: string;\n\tembedding?: number[];\n\timportance: number;\n\tcreated_at: string;\n\tupdated_at: string;\n}\n\n// \u2500\u2500 Read services \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\n\nexport async function getProfile(\n\tclient: SupabaseClient,\n\tuserId: string,\n): Promise<AthleteProfile | null> {\n\tconst { data, error } = await client.from(\"profiles\").select(\"*\").eq(\"id\", userId).single();\n\n\tif (error) throw new Error(`Failed to fetch profile: ${error.message}`);\n\treturn data;\n}\n\nexport async function getWorkouts(\n\tclient: SupabaseClient,\n\tuserId: string,\n\toptions: {\n\t\tlimit?: number;\n\t\tfromDate?: string;\n\t\ttoDate?: string;\n\t\tactivityType?: string;\n\t} = {},\n): Promise<Workout[]> {\n\tlet query = client\n\t\t.from(\"workouts\")\n\t\t.select(\"*\")\n\t\t.eq(\"athlete_id\", userId)\n\t\t.order(\"started_at\", { ascending: false });\n\n\tif (options.fromDate) query = query.gte(\"started_at\", options.fromDate);\n\tif (options.toDate) query = query.lte(\"started_at\", options.toDate);\n\tif (options.activityType) query = query.eq(\"activity_type\", options.activityType);\n\tif (options.limit) query = query.limit(options.limit);\n\n\tconst { data, error } = await query;\n\tif (error) throw new Error(`Failed to fetch workouts: ${error.message}`);\n\treturn data ?? [];\n}\n\nexport async function getDailyLogs(\n\tclient: SupabaseClient,\n\tuserId: string,\n\toptions: { limit?: number; fromDate?: string; toDate?: string } = {},\n): Promise<DailyLog[]> {\n\tlet query = client\n\t\t.from(\"daily_logs\")\n\t\t.select(\"*\")\n\t\t.eq(\"athlete_id\", userId)\n\t\t.order(\"log_date\", { ascending: false });\n\n\tif (options.fromDate) query = query.gte(\"log_date\", options.fromDate);\n\tif (options.toDate) query = query.lte(\"log_date\", options.toDate);\n\tif (options.limit) query = query.limit(options.limit);\n\n\tconst { data, error } = await query;\n\tif (error) throw new Error(`Failed to fetch daily logs: ${error.message}`);\n\treturn data ?? [];\n}\n\nexport async function getHealthMetrics(\n\tclient: SupabaseClient,\n\tuserId: string,\n\toptions: { limit?: number; metricType?: string; fromDate?: string } = {},\n): Promise<HealthMetric[]> {\n\tlet query = client\n\t\t.from(\"health_metrics\")\n\t\t.select(\"*\")\n\t\t.eq(\"athlete_id\", userId)\n\t\t.order(\"recorded_at\", { ascending: false });\n\n\tif (options.metricType) query = query.eq(\"metric_type\", options.metricType);\n\tif (options.fromDate) query = query.gte(\"recorded_at\", options.fromDate);\n\tif (options.limit) query = query.limit(options.limit);\n\n\tconst { data, error } = await query;\n\tif (error) throw new Error(`Failed to fetch health metrics: ${error.message}`);\n\treturn data ?? [];\n}\n\nexport async function getTrainingPlan(\n\tclient: SupabaseClient,\n\tuserId: string,\n): Promise<TrainingPlan | null> {\n\tconst { data, error } = await client\n\t\t.from(\"training_plans\")\n\t\t.select(\"*\")\n\t\t.eq(\"athlete_id\", userId)\n\t\t.eq(\"status\", \"active\")\n\t\t.order(\"created_at\", { ascending: false })\n\t\t.limit(1)\n\t\t.maybeSingle();\n\n\tif (error) throw new Error(`Failed to fetch training plan: ${error.message}`);\n\treturn data;\n}\n\nexport async function getUpcomingEvents(\n\tclient: SupabaseClient,\n\tuserId: string,\n\tlimit = 5,\n): Promise<\n\tArray<{\n\t\tid: string;\n\t\tname: string;\n\t\tevent_date: string;\n\t\tdistance_type: string | null;\n\t}>\n> {\n\tconst today = new Date().toISOString().split(\"T\")[0];\n\t// Events are club-scoped, not athlete-scoped. Query via the athlete's club.\n\tconst profile = await getProfile(client, userId);\n\tif (!profile) return [];\n\n\tconst { data, error } = await client\n\t\t.from(\"events\")\n\t\t.select(\"id, name, event_date, distance_type\")\n\t\t.eq(\"club_id\", profile.club_id)\n\t\t.gte(\"event_date\", today)\n\t\t.order(\"event_date\", { ascending: true })\n\t\t.limit(limit);\n\n\tif (error) throw new Error(`Failed to fetch events: ${error.message}`);\n\treturn data ?? [];\n}\n\nexport async function getInjuries(\n\tclient: SupabaseClient,\n\tuserId: string,\n\tactiveOnly = true,\n): Promise<\n\tArray<{\n\t\tid: string;\n\t\tbody_part: string;\n\t\tseverity: number | null;\n\t\treported_at: string;\n\t\tresolved_at: string | null;\n\t\tnotes: string | null;\n\t}>\n> {\n\tlet query = client\n\t\t.from(\"injuries\")\n\t\t.select(\"id, body_part, severity, reported_at, resolved_at, notes\")\n\t\t.eq(\"athlete_id\", userId)\n\t\t.order(\"reported_at\", { ascending: false });\n\n\tif (activeOnly) query = query.is(\"resolved_at\", null);\n\n\tconst { data, error } = await query;\n\tif (error) throw new Error(`Failed to fetch injuries: ${error.message}`);\n\treturn data ?? [];\n}\n\nexport async function getRecentMemories(\n\tclient: SupabaseClient,\n\tuserId: string,\n\tlimit = 10,\n): Promise<AthleteMemory[]> {\n\tconst { data, error } = await client\n\t\t.from(\"athlete_memories\")\n\t\t.select(\"*\")\n\t\t.eq(\"athlete_id\", userId)\n\t\t.order(\"importance\", { ascending: false })\n\t\t.order(\"created_at\", { ascending: false })\n\t\t.limit(limit);\n\n\tif (error) throw new Error(`Failed to fetch memories: ${error.message}`);\n\treturn data ?? [];\n}\n\n/**\n * Semantic memory search \u2014 finds memories relevant to a given query\n * by embedding the query and searching via pgvector cosine similarity.\n * Uses the existing `match_memories` RPC function.\n */\nexport async function searchMemoriesBySimilarity(\n\tclient: SupabaseClient,\n\tuserId: string,\n\tqueryEmbedding: number[],\n\toptions: { matchThreshold?: number; matchCount?: number } = {},\n): Promise<\n\tArray<{ id: string; category: string; content: string; importance: number; similarity: number }>\n> {\n\tconst { matchThreshold = 0.4, matchCount = 8 } = options;\n\n\tconst { data, error } = await client.rpc(\"match_memories\", {\n\t\tp_athlete_id: userId,\n\t\tquery_embedding: queryEmbedding,\n\t\tmatch_threshold: matchThreshold,\n\t\tmatch_count: matchCount,\n\t});\n\n\tif (error) {\n\t\tlog.warn({ err: error }, \"Semantic memory search failed\");\n\t\treturn [];\n\t}\n\n\treturn data ?? [];\n}\n\n// \u2500\u2500 Write services \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\n\nexport async function insertWorkout(\n\tclient: SupabaseClient,\n\tworkout: Omit<Workout, \"id\" | \"created_at\">,\n): Promise<Workout> {\n\tconst { data, error } = await client.from(\"workouts\").insert(workout).select().single();\n\n\tif (error) throw new Error(`Failed to log workout: ${error.message}`);\n\treturn data;\n}\n\nexport async function insertMemory(\n\tclient: SupabaseClient,\n\tmemory: Omit<AthleteMemory, \"id\" | \"created_at\" | \"updated_at\">,\n): Promise<AthleteMemory> {\n\tconst { data, error } = await client.from(\"athlete_memories\").insert(memory).select().single();\n\n\tif (error) throw new Error(`Failed to save memory: ${error.message}`);\n\treturn data;\n}\n\nexport async function upsertDailyLog(\n\tclient: SupabaseClient,\n\tlog: Omit<DailyLog, \"id\" | \"created_at\">,\n): Promise<DailyLog> {\n\tconst { data, error } = await client\n\t\t.from(\"daily_logs\")\n\t\t.upsert(log, { onConflict: \"athlete_id,log_date\" })\n\t\t.select()\n\t\t.single();\n\n\tif (error) throw new Error(`Failed to update daily log: ${error.message}`);\n\treturn data;\n}\n\nexport async function insertInjury(\n\tclient: SupabaseClient,\n\tinjury: {\n\t\tathlete_id: string;\n\t\tbody_part: string;\n\t\tseverity: number;\n\t\treported_at: string;\n\t\tnotes?: string;\n\t},\n) {\n\tconst { data, error } = await client.from(\"injuries\").insert(injury).select().single();\n\n\tif (error) throw new Error(`Failed to log injury: ${error.message}`);\n\treturn data;\n}\n\nexport async function updateTrainingPlan(\n\tclient: SupabaseClient,\n\tplanId: string,\n\tupdates: Partial<Pick<TrainingPlan, \"plan_data\" | \"status\">>,\n): Promise<TrainingPlan> {\n\tconst { data, error } = await client\n\t\t.from(\"training_plans\")\n\t\t.update(updates)\n\t\t.eq(\"id\", planId)\n\t\t.select()\n\t\t.single();\n\n\tif (error) throw new Error(`Failed to update training plan: ${error.message}`);\n\treturn data;\n}\n", "// ============================================================\n// Tool: Analyze Biometric Trends\n// Pulls a rolling window of daily logs to provide the LLM\n// with trends in HRV, Sleep, RHR, and RPE.\n// ============================================================\n\nimport { tool } from \"@langchain/core/tools\";\nimport type { SupabaseClient } from \"@supabase/supabase-js\";\nimport { z } from \"zod\";\nimport { getDailyLogs } from \"../supabase.js\";\n\nexport function createAnalyzeBiometricTrendsTool(client: SupabaseClient, userId: string) {\n\treturn tool(\n\t\tasync ({ days = 30 }) => {\n\t\t\tconst toDate = new Date();\n\t\t\tconst fromDate = new Date();\n\t\t\tfromDate.setDate(toDate.getDate() - days);\n\n\t\t\tconst logs = await getDailyLogs(client, userId, {\n\t\t\t\tfromDate: fromDate.toISOString().split(\"T\")[0],\n\t\t\t\ttoDate: toDate.toISOString().split(\"T\")[0],\n\t\t\t\tlimit: days, // limit to max requested days just in case\n\t\t\t});\n\n\t\t\tif (logs.length === 0) {\n\t\t\t\treturn `No daily logs found for the last ${days} days. Suggest the athlete log their metrics.`;\n\t\t\t}\n\n\t\t\t// Split into recent (first half of period) and previous (second half)\n\t\t\t// Note: logs are ordered log_date desc (newest first)\n\t\t\tconst midPoint = Math.floor(logs.length / 2);\n\t\t\tconst recentLogs = logs.slice(0, midPoint);\n\t\t\tconst olderLogs = logs.slice(midPoint);\n\n\t\t\tconst calculateAvgs = (logSet: typeof logs) => {\n\t\t\t\tlet s = 0,\n\t\t\t\t\tsc = 0;\n\t\t\t\tlet sq = 0,\n\t\t\t\t\tsqc = 0;\n\t\t\t\tlet h = 0,\n\t\t\t\t\thc = 0;\n\t\t\t\tlet rh = 0,\n\t\t\t\t\trhc = 0;\n\t\t\t\tlet rp = 0,\n\t\t\t\t\trpc = 0;\n\n\t\t\t\tlogSet.forEach((l) => {\n\t\t\t\t\tif (l.sleep_hours != null) {\n\t\t\t\t\t\ts += l.sleep_hours;\n\t\t\t\t\t\tsc++;\n\t\t\t\t\t}\n\t\t\t\t\tif (l.sleep_quality != null) {\n\t\t\t\t\t\tsq += l.sleep_quality;\n\t\t\t\t\t\tsqc++;\n\t\t\t\t\t}\n\t\t\t\t\tif (l.hrv != null) {\n\t\t\t\t\t\th += l.hrv;\n\t\t\t\t\t\thc++;\n\t\t\t\t\t}\n\t\t\t\t\tif (l.resting_hr != null) {\n\t\t\t\t\t\trh += l.resting_hr;\n\t\t\t\t\t\trhc++;\n\t\t\t\t\t}\n\t\t\t\t\tif (l.rpe != null) {\n\t\t\t\t\t\trp += l.rpe;\n\t\t\t\t\t\trpc++;\n\t\t\t\t\t}\n\t\t\t\t});\n\n\t\t\t\treturn {\n\t\t\t\t\tsleep: sc > 0 ? (s / sc).toFixed(1) : \"N/A\",\n\t\t\t\t\tsleepQuality: sqc > 0 ? (sq / sqc).toFixed(1) : \"N/A\",\n\t\t\t\t\thrv: hc > 0 ? Math.round(h / hc) : \"N/A\",\n\t\t\t\t\trhr: rhc > 0 ? Math.round(rh / rhc) : \"N/A\",\n\t\t\t\t\trpe: rpc > 0 ? (rp / rpc).toFixed(1) : \"N/A\",\n\t\t\t\t};\n\t\t\t};\n\n\t\t\tconst overall = calculateAvgs(logs);\n\t\t\tconst recent = calculateAvgs(recentLogs);\n\t\t\tconst older = calculateAvgs(olderLogs);\n\n\t\t\tlet analysis = `**Biometric Trends Analysis (${logs.length} days of data recorded within the last ${days} days)**\\n\\n`;\n\n\t\t\tanalysis += `### Overall Averages:\\n`;\n\t\t\tanalysis += `- Sleep: ${overall.sleep} hrs (Quality: ${overall.sleepQuality}/5)\\n`;\n\t\t\tanalysis += `- HRV: ${overall.hrv} ms\\n`;\n\t\t\tanalysis += `- Resting HR: ${overall.rhr} bpm\\n`;\n\t\t\tanalysis += `- Session RPE: ${overall.rpe}/10\\n\\n`;\n\n\t\t\tif (recentLogs.length > 0 && olderLogs.length > 0) {\n\t\t\t\tanalysis += `### Trend (Recent ${recentLogs.length} entries vs Previous ${olderLogs.length} entries):\\n`;\n\t\t\t\tanalysis += `- Sleep: ${recent.sleep} hrs (vs ${older.sleep} hrs)\\n`;\n\t\t\t\tanalysis += `- HRV: ${recent.hrv} ms (vs ${older.hrv} ms)\\n`;\n\t\t\t\tanalysis += `- Resting HR: ${recent.rhr} bpm (vs ${older.rhr} bpm)\\n`;\n\t\t\t\tanalysis += `- Session RPE: ${recent.rpe}/10 (vs ${older.rpe}/10)\\n\\n`;\n\t\t\t}\n\n\t\t\tanalysis += `**Coaching Guidance:** Use these trends to give the athlete deep physiological context. Explain the *why* behind their current readiness. If HRV is trending down while RPE is trending up, suggest a deload or more recovery.`;\n\n\t\t\treturn analysis;\n\t\t},\n\t\t{\n\t\t\tname: \"analyze_biometric_trends\",\n\t\t\tdescription:\n\t\t\t\t\"Analyzes the athlete's daily logs over a specific number of days to extract sleep, HRV, Resting HR, and RPE trends. Use this to act as an expert physiologist and identify long-term patterns.\",\n\t\t\tschema: z.object({\n\t\t\t\tdays: z\n\t\t\t\t\t.number()\n\t\t\t\t\t.min(7)\n\t\t\t\t\t.max(90)\n\t\t\t\t\t.optional()\n\t\t\t\t\t.describe(\"Number of days to look back for the trend analysis (default 30)\"),\n\t\t\t}),\n\t\t},\n\t);\n}\n", "import { tool } from \"@langchain/core/tools\";\nimport { z } from \"zod\";\n\n/**\n * Tool for evaluating form and technique across tri-sports and strength exercises via uploaded media.\n * This instructs the AI to query the underlying multimodal model for geometric insights.\n */\nexport const analyzeForm = tool(\n\tasync ({ activityType, specificFocus, userNotes }, _config) => {\n\t\t// Note: The actual image data is injected into the LLM context automatically via the chat handler when uploaded.\n\t\t// This tool simply triggers the analytical pathway within the agent's logic.\n\n\t\treturn JSON.stringify({\n\t\t\tstatus: \"success\",\n\t\t\tinstruction: `Multimodal analysis triggered for ${activityType}. Focus: ${specificFocus}. User noted: ${userNotes || \"None\"}. Proceed to evaluate the provided images based on these parameters.`,\n\t\t\tcontext_directive:\n\t\t\t\t\"System prompt should extract the user's uploaded image URLs from the conversation history and analyze them for posture, joint angles, pacing, and overall technique.\",\n\t\t});\n\t},\n\t{\n\t\tname: \"analyze_form\",\n\t\tdescription:\n\t\t\t\"Triggers an in-depth biomechanical analysis of user-uploaded images/videos to critique their workout form. ONLY call this when the user explicitly provides visual media and asks for form feedback.\",\n\t\tschema: z.object({\n\t\t\tactivityType: z\n\t\t\t\t.enum([\"SWIM\", \"BIKE\", \"RUN\", \"STRENGTH\", \"YOGA\"])\n\t\t\t\t.describe(\"The sport or exercise type being performed.\"),\n\t\t\tspecificFocus: z\n\t\t\t\t.string()\n\t\t\t\t.describe(\n\t\t\t\t\t\"What the user specifically wants critiqued (e.g., 'catch phase in swim', 'squat depth', 'running cadence').\",\n\t\t\t\t),\n\t\t\tuserNotes: z\n\t\t\t\t.string()\n\t\t\t\t.optional()\n\t\t\t\t.describe(\n\t\t\t\t\t\"Any context the user provided about their injury history or current feelings during this workout.\",\n\t\t\t\t),\n\t\t}),\n\t},\n);\n", "// ============================================================\n// Tool: Analyze Workouts\n// Computes deep training insights over a date range: load,\n// volume, intensity distribution.\n// ============================================================\n\nimport { tool } from \"@langchain/core/tools\";\nimport type { SupabaseClient } from \"@supabase/supabase-js\";\nimport { z } from \"zod\";\nimport { getWorkouts } from \"../supabase.js\";\n\nexport function createAnalyzeWorkoutsTool(client: SupabaseClient, userId: string) {\n\treturn tool(\n\t\tasync ({ days = 30 }) => {\n\t\t\tconst toDate = new Date();\n\t\t\tconst fromDate = new Date();\n\t\t\tfromDate.setDate(toDate.getDate() - days);\n\n\t\t\tconst workouts = await getWorkouts(client, userId, {\n\t\t\t\tfromDate: fromDate.toISOString().split(\"T\")[0],\n\t\t\t\ttoDate: toDate.toISOString().split(\"T\")[0],\n\t\t\t});\n\n\t\t\tif (workouts.length === 0) {\n\t\t\t\treturn `No workouts found for the last ${days} days.`;\n\t\t\t}\n\n\t\t\t// Also get daily logs to match RPE to workouts\n\t\t\t// Workouts don't natively have RPE, we joined that conceptual load via daily logs often\n\t\t\t// but workouts might have tss or avg_hr we can use. Let's look at workouts fields.\n\t\t\tlet totalVolumeS = 0;\n\t\t\tlet totalTss = 0;\n\t\t\tconst activityCounts: Record<string, number> = {};\n\n\t\t\tworkouts.forEach((w) => {\n\t\t\t\tif (w.duration_s != null) totalVolumeS += w.duration_s;\n\t\t\t\tif (w.tss != null) {\n\t\t\t\t\ttotalTss += w.tss;\n\t\t\t\t} else if (w.duration_s != null && w.avg_hr != null) {\n\t\t\t\t\t// Very rough TRIMP estimation if no TSS\n\t\t\t\t\ttotalTss += (w.duration_s / 60) * (w.avg_hr / 150) * 1.5;\n\t\t\t\t}\n\n\t\t\t\tactivityCounts[w.activity_type] = (activityCounts[w.activity_type] || 0) + 1;\n\t\t\t});\n\n\t\t\tconst totalHours = (totalVolumeS / 3600).toFixed(1);\n\t\t\tconst weeklyAvgHours = (totalVolumeS / 3600 / (days / 7)).toFixed(1);\n\t\t\tconst totalLoad = Math.round(totalTss);\n\t\t\tconst weeklyAvgLoad = Math.round(totalTss / (days / 7));\n\n\t\t\tconst breakdown = Object.entries(activityCounts)\n\t\t\t\t.map(([type, count]) => `- ${type}: ${count} sessions`)\n\t\t\t\t.join(\"\\n\");\n\n\t\t\tlet analysis = `**Workout Analysis (${days} days)**\\n\\n`;\n\t\t\tanalysis += `### Volume & Load\\n`;\n\t\t\tanalysis += `- Total Hours: ${totalHours}h (Avg ${weeklyAvgHours}h / week)\\n`;\n\t\t\tanalysis += `- Total Estimated Load (TSS/TRIMP): ${totalLoad} (Avg ${weeklyAvgLoad} / week)\\n\\n`;\n\n\t\t\tanalysis += `### Activity Breakdown\\n`;\n\t\t\tanalysis += `${breakdown}\\n\\n`;\n\n\t\t\tanalysis += `**Coaching Guidance:** Use this to evaluate whether the athlete's training volume is appropriate. If they are feeling fatigued (check biometrics), tell them their weekly load is ${weeklyAvgLoad} which might be too high for their current recovery state. If they want to build fitness, ensure progressive overload.`;\n\n\t\t\treturn analysis;\n\t\t},\n\t\t{\n\t\t\tname: \"analyze_workouts\",\n\t\t\tdescription:\n\t\t\t\t\"Analyzes the athlete's completed workouts over a specific number of days to extract volume, load (TSS/TRIMP), and activity distribution. Use this to act as a Sports Scientist.\",\n\t\t\tschema: z.object({\n\t\t\t\tdays: z\n\t\t\t\t\t.number()\n\t\t\t\t\t.min(7)\n\t\t\t\t\t.max(90)\n\t\t\t\t\t.optional()\n\t\t\t\t\t.describe(\"Number of days to look back (default 30)\"),\n\t\t\t}),\n\t\t},\n\t);\n}\n", "/**\n * generate-workout-plan \u2014 AI tool that creates a structured multi-week training plan.\n *\n * Uses LangChain withStructuredOutput + Zod to produce a typed plan,\n * then inserts rows into training_plans + planned_workouts.\n */\n\nimport { tool } from \"@langchain/core/tools\";\nimport { AzureChatOpenAI } from \"@langchain/openai\";\nimport type { SupabaseClient } from \"@supabase/supabase-js\";\nimport { z } from \"zod\";\nimport { createLogger } from \"../../../lib/logger.js\";\n\nconst log = createLogger({ module: \"tool-generate-workout-plan\" });\n\n// \u2500\u2500 Input schema \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\n\nconst generatePlanInputSchema = z.object({\n\tgoal: z.string().describe('Primary goal, e.g. \"finish a half marathon in under 2 hours\"'),\n\tdurationWeeks: z.number().int().min(1).max(52).default(8).describe(\"Plan duration in weeks\"),\n\tweeklyAvailability: z\n\t\t.number()\n\t\t.int()\n\t\t.min(1)\n\t\t.max(14)\n\t\t.default(5)\n\t\t.describe(\"Number of training sessions per week\"),\n\tfocusActivities: z\n\t\t.array(z.enum([\"SWIM\", \"BIKE\", \"RUN\", \"STRENGTH\", \"YOGA\", \"OTHER\"]))\n\t\t.default([\"RUN\", \"STRENGTH\"])\n\t\t.describe(\"Activities to include in the plan\"),\n\teventDate: z\n\t\t.string()\n\t\t.optional()\n\t\t.describe(\"Target event date (ISO 8601) if training for a specific event\"),\n\tadditionalContext: z\n\t\t.string()\n\t\t.optional()\n\t\t.describe(\"Any extra context: injuries, preferences, equipment available\"),\n});\n\n// \u2500\u2500 Output schema (for withStructuredOutput) \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\n\nconst sessionOutputSchema = z.object({\n\tdayOffset: z.number().int().min(0).describe(\"Day offset from week start (0=Monday)\"),\n\tactivityType: z.enum([\"SWIM\", \"BIKE\", \"RUN\", \"STRENGTH\", \"YOGA\", \"OTHER\"]),\n\ttitle: z.string().describe(\"Concise session title\"),\n\tdescription: z.string().describe(\"Detailed instructions for the athlete\"),\n\tdurationMin: z.number().int().min(5),\n\tintensity: z.enum([\"RECOVERY\", \"EASY\", \"MODERATE\", \"HARD\", \"MAX\"]),\n\ttargetRpe: z.number().int().min(1).max(10).optional(),\n\tdistanceKm: z.number().optional(),\n});\n\nconst weekOutputSchema = z.object({\n\tweekNumber: z.number().int().min(1),\n\ttheme: z.string().describe(\"Week theme/focus\"),\n\tsessions: z.array(sessionOutputSchema).min(1),\n});\n\nconst planOutputSchema = z.object({\n\tname: z.string().describe(\"Plan name\"),\n\tgoal: z.string(),\n\tweeks: z.array(weekOutputSchema).min(1),\n});\n\n// \u2500\u2500 Tool factory \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\n\nexport function createGenerateWorkoutPlanTool(\n\tclient: SupabaseClient,\n\tuserId: string,\n\tclubId: string,\n) {\n\treturn tool(\n\t\tasync (input) => {\n\t\t\ttry {\n\t\t\t\t// 1. Gather context about the athlete\n\t\t\t\tconst [profileRes, historyRes, logRes, injuryRes] = await Promise.all([\n\t\t\t\t\tclient.from(\"profiles\").select(\"*\").eq(\"id\", userId).single(),\n\t\t\t\t\tclient\n\t\t\t\t\t\t.from(\"workouts\")\n\t\t\t\t\t\t.select(\"activity_type, duration_s, distance_m, tss, started_at\")\n\t\t\t\t\t\t.eq(\"athlete_id\", userId)\n\t\t\t\t\t\t.order(\"started_at\", { ascending: false })\n\t\t\t\t\t\t.limit(20),\n\t\t\t\t\tclient\n\t\t\t\t\t\t.from(\"daily_logs\")\n\t\t\t\t\t\t.select(\"*\")\n\t\t\t\t\t\t.eq(\"athlete_id\", userId)\n\t\t\t\t\t\t.order(\"log_date\", { ascending: false })\n\t\t\t\t\t\t.limit(7),\n\t\t\t\t\tclient\n\t\t\t\t\t\t.from(\"injuries\")\n\t\t\t\t\t\t.select(\"body_part, severity, notes\")\n\t\t\t\t\t\t.eq(\"athlete_id\", userId)\n\t\t\t\t\t\t.is(\"resolved_at\", null),\n\t\t\t\t]);\n\n\t\t\t\tconst context = {\n\t\t\t\t\tprofile: profileRes.data,\n\t\t\t\t\trecentWorkouts: historyRes.data || [],\n\t\t\t\t\trecentLogs: logRes.data || [],\n\t\t\t\t\tactiveInjuries: injuryRes.data || [],\n\t\t\t\t};\n\n\t\t\t\t// 2. Generate structured plan using withStructuredOutput\n\t\t\t\tconst llm = new AzureChatOpenAI({\n\t\t\t\t\tazureOpenAIApiDeploymentName: process.env.AZURE_OPENAI_DEPLOYMENT || \"gpt-4o\",\n\t\t\t\t\tazureOpenAIApiVersion: process.env.AZURE_OPENAI_API_VERSION || \"2024-12-01-preview\",\n\t\t\t\t\ttemperature: 0.7,\n\t\t\t\t});\n\n\t\t\t\tconst structuredLlm = llm.withStructuredOutput(planOutputSchema, {\n\t\t\t\t\tname: \"training_plan\",\n\t\t\t\t});\n\n\t\t\t\tconst systemMessage = `You are an expert sports coach and exercise scientist. Generate a structured training plan based on:\n\nATHLETE CONTEXT:\n${JSON.stringify(context, null, 2)}\n\nPLAN REQUIREMENTS:\n- Goal: ${input.goal}\n- Duration: ${input.durationWeeks} weeks\n- Sessions/week: ${input.weeklyAvailability}\n- Activities: ${input.focusActivities.join(\", \")}\n${input.eventDate ? `- Event date: ${input.eventDate}` : \"\"}\n${input.additionalContext ? `- Notes: ${input.additionalContext}` : \"\"}\n${context.activeInjuries.length > 0 ? `\\n\u26A0\uFE0F ACTIVE INJURIES: ${JSON.stringify(context.activeInjuries)} \u2014 adjust plan to avoid aggravating these.` : \"\"}\n\nGUIDELINES:\n- Follow periodization principles (base \u2192 build \u2192 peak \u2192 taper if racing)\n- Include recovery days and deload weeks\n- Progress gradually (max 10% weekly volume increase)\n- Vary intensity across the week (hard/easy pattern)\n- For STRENGTH sessions, focus on compound movements\n- Set realistic RPE targets for each session\n- Day offsets: 0=Monday through 6=Sunday`;\n\n\t\t\t\tconst plan = await structuredLlm.invoke(systemMessage);\n\n\t\t\t\t// 3. Calculate start date\n\t\t\t\tconst startDate = new Date();\n\t\t\t\t// Start on the coming Monday\n\t\t\t\tconst dayOfWeek = startDate.getDay();\n\t\t\t\tconst daysUntilMonday = dayOfWeek === 0 ? 1 : (8 - dayOfWeek) % 7 || 7;\n\t\t\t\tstartDate.setDate(startDate.getDate() + daysUntilMonday);\n\n\t\t\t\t// 4. Create training_plans row\n\t\t\t\tconst { data: planRow, error: planError } = await client\n\t\t\t\t\t.from(\"training_plans\")\n\t\t\t\t\t.insert({\n\t\t\t\t\t\tathlete_id: userId,\n\t\t\t\t\t\tclub_id: clubId,\n\t\t\t\t\t\tname: plan.name,\n\t\t\t\t\t\tstatus: \"active\",\n\t\t\t\t\t\tplan_data: {\n\t\t\t\t\t\t\tgoal: plan.goal,\n\t\t\t\t\t\t\tdurationWeeks: input.durationWeeks,\n\t\t\t\t\t\t\tweeklyAvailability: input.weeklyAvailability,\n\t\t\t\t\t\t\tfocusActivities: input.focusActivities,\n\t\t\t\t\t\t\teventDate: input.eventDate || null,\n\t\t\t\t\t\t\tgeneratedAt: new Date().toISOString(),\n\t\t\t\t\t\t},\n\t\t\t\t\t})\n\t\t\t\t\t.select(\"id\")\n\t\t\t\t\t.single();\n\n\t\t\t\tif (planError) throw new Error(`Failed to create plan: ${planError.message}`);\n\n\t\t\t\t// 5. Insert all planned_workouts\n\t\t\t\tconst plannedWorkouts = plan.weeks.flatMap((week) =>\n\t\t\t\t\tweek.sessions.map((session) => {\n\t\t\t\t\t\tconst sessionDate = new Date(startDate);\n\t\t\t\t\t\tsessionDate.setDate(\n\t\t\t\t\t\t\tsessionDate.getDate() + (week.weekNumber - 1) * 7 + session.dayOffset,\n\t\t\t\t\t\t);\n\n\t\t\t\t\t\treturn {\n\t\t\t\t\t\t\tathlete_id: userId,\n\t\t\t\t\t\t\tclub_id: clubId,\n\t\t\t\t\t\t\tplan_id: planRow.id,\n\t\t\t\t\t\t\tplanned_date: sessionDate.toISOString().split(\"T\")[0],\n\t\t\t\t\t\t\tactivity_type: session.activityType,\n\t\t\t\t\t\t\ttitle: session.title,\n\t\t\t\t\t\t\tdescription: session.description,\n\t\t\t\t\t\t\tduration_min: session.durationMin,\n\t\t\t\t\t\t\tdistance_km: session.distanceKm || null,\n\t\t\t\t\t\t\ttarget_rpe: session.targetRpe || null,\n\t\t\t\t\t\t\tintensity: session.intensity,\n\t\t\t\t\t\t\tstatus: \"planned\",\n\t\t\t\t\t\t\tsource: \"AI\",\n\t\t\t\t\t\t\tcoach_notes: `Week ${week.weekNumber}: ${week.theme}`,\n\t\t\t\t\t\t};\n\t\t\t\t\t}),\n\t\t\t\t);\n\n\t\t\t\tconst { error: insertError } = await client\n\t\t\t\t\t.from(\"planned_workouts\")\n\t\t\t\t\t.insert(plannedWorkouts);\n\n\t\t\t\tif (insertError) throw new Error(`Failed to insert workouts: ${insertError.message}`);\n\n\t\t\t\t// 6. Build summary\n\t\t\t\tconst totalSessions = plannedWorkouts.length;\n\t\t\t\tconst weekSummaries = plan.weeks.map(\n\t\t\t\t\t(w) => `  Week ${w.weekNumber} (${w.theme}): ${w.sessions.length} sessions`,\n\t\t\t\t);\n\n\t\t\t\treturn `\u2705 Created \"${plan.name}\" \u2014 ${input.durationWeeks}-week plan with ${totalSessions} sessions.\n\nGoal: ${plan.goal}\nStarts: ${startDate.toISOString().split(\"T\")[0]} (coming Monday)\n\n${weekSummaries.join(\"\\n\")}\n\nThe plan is now visible in your training calendar. You can ask me to adjust any session or week.`;\n\t\t\t} catch (error) {\n\t\t\t\tconst msg = error instanceof Error ? error.message : \"Unknown error\";\n\t\t\t\tlog.error({ err: msg }, \"Failed to generate workout plan\");\n\t\t\t\treturn `\u274C Failed to generate plan: ${msg}`;\n\t\t\t}\n\t\t},\n\t\t{\n\t\t\tname: \"generate_workout_plan\",\n\t\t\tdescription: `Generates a structured multi-week training plan personalized to the athlete's goals, fitness level, and readiness. Creates the plan and all scheduled sessions. Use when the athlete asks for a training plan, wants to prepare for an event, or needs a structured program.`,\n\t\t\tschema: generatePlanInputSchema,\n\t\t},\n\t);\n}\n", "// ============================================================\n// Tool: Get Athlete Profile\n// Fetches the athlete's profile and active injuries\n// ============================================================\n\nimport { tool } from \"@langchain/core/tools\";\nimport type { SupabaseClient } from \"@supabase/supabase-js\";\nimport { z } from \"zod\";\nimport { getInjuries, getProfile } from \"../supabase.js\";\n\nexport function createGetAthleteProfileTool(client: SupabaseClient, userId: string) {\n\treturn tool(\n\t\tasync () => {\n\t\t\tconst [profile, injuries] = await Promise.all([\n\t\t\t\tgetProfile(client, userId),\n\t\t\t\tgetInjuries(client, userId, true),\n\t\t\t]);\n\n\t\t\tif (!profile) return \"No athlete profile found. The user may need to complete onboarding.\";\n\n\t\t\treturn JSON.stringify({\n\t\t\t\tname: profile.display_name,\n\t\t\t\ttimezone: profile.timezone,\n\t\t\t\trole: profile.role,\n\t\t\t\tpreferences: profile.preferences,\n\t\t\t\tactiveInjuries: injuries.map((i) => ({\n\t\t\t\t\tbodyPart: i.body_part,\n\t\t\t\t\tseverity: i.severity,\n\t\t\t\t\tsince: i.reported_at,\n\t\t\t\t\tnotes: i.notes,\n\t\t\t\t})),\n\t\t\t});\n\t\t},\n\t\t{\n\t\t\tname: \"get_athlete_profile\",\n\t\t\tdescription:\n\t\t\t\t\"Fetches the athlete profile including preferences and active injuries. Use at the start of a conversation or when asked about the athlete.\",\n\t\t\tschema: z.object({}),\n\t\t},\n\t);\n}\n", "// ============================================================\n// Tool: Get Health Metrics\n// Fetches daily logs and health metrics for wellness analysis\n// ============================================================\n\nimport { tool } from \"@langchain/core/tools\";\nimport type { SupabaseClient } from \"@supabase/supabase-js\";\nimport { z } from \"zod\";\nimport { getDailyLogs, getHealthMetrics } from \"../supabase.js\";\n\nexport function createGetHealthMetricsTool(client: SupabaseClient, userId: string) {\n\treturn tool(\n\t\tasync ({ days, metricType }) => {\n\t\t\ttry {\n\t\t\t\tconst lookbackDays = days ?? 7;\n\t\t\t\tconst fromDate = new Date(Date.now() - lookbackDays * 86400000).toISOString().split(\"T\")[0];\n\n\t\t\t\tconst [dailyLogs, healthMetrics] = await Promise.all([\n\t\t\t\t\tgetDailyLogs(client, userId, { fromDate, limit: lookbackDays }),\n\t\t\t\t\tgetHealthMetrics(client, userId, {\n\t\t\t\t\t\tfromDate,\n\t\t\t\t\t\tmetricType,\n\t\t\t\t\t}),\n\t\t\t\t]);\n\n\t\t\t\treturn JSON.stringify({\n\t\t\t\t\tdailyLogs: dailyLogs.map((d) => ({\n\t\t\t\t\t\tdate: d.log_date,\n\t\t\t\t\t\tsleepHours: d.sleep_hours,\n\t\t\t\t\t\tsleepQuality: d.sleep_quality,\n\t\t\t\t\t\trpe: d.rpe,\n\t\t\t\t\t\tmood: d.mood,\n\t\t\t\t\t\thrv: d.hrv,\n\t\t\t\t\t\trestingHr: d.resting_hr,\n\t\t\t\t\t\tweightKg: d.weight_kg,\n\t\t\t\t\t\tnotes: d.notes,\n\t\t\t\t\t})),\n\t\t\t\t\thealthMetrics: healthMetrics.map((m) => ({\n\t\t\t\t\t\ttype: m.metric_type,\n\t\t\t\t\t\tvalue: m.value,\n\t\t\t\t\t\tunit: m.unit,\n\t\t\t\t\t\trecordedAt: m.recorded_at,\n\t\t\t\t\t\tsource: m.source,\n\t\t\t\t\t})),\n\t\t\t\t});\n\t\t\t} catch (error) {\n\t\t\t\tconst msg = error instanceof Error ? error.message : \"Unknown error\";\n\t\t\t\treturn `Error fetching health metrics: ${msg}. Please check parameters and try again.`;\n\t\t\t}\n\t\t},\n\t\t{\n\t\t\tname: \"get_health_metrics\",\n\t\t\tdescription:\n\t\t\t\t\"Fetches daily wellness logs (sleep, HRV, mood, RPE) and health metrics. Use to assess recovery, readiness, and trends.\",\n\t\t\tschema: z.object({\n\t\t\t\tdays: z.number().optional().describe(\"Number of days to look back (default 7)\"),\n\t\t\t\tmetricType: z\n\t\t\t\t\t.string()\n\t\t\t\t\t.optional()\n\t\t\t\t\t.describe(\"Filter health metrics by type (e.g., VO2_MAX, BODY_FAT)\"),\n\t\t\t}),\n\t\t},\n\t);\n}\n", "// ============================================================\n// Tool: Get Progress Report\n// Computes summary statistics and trends from workout + health data\n// ============================================================\n\nimport { tool } from \"@langchain/core/tools\";\nimport type { SupabaseClient } from \"@supabase/supabase-js\";\nimport { z } from \"zod\";\nimport { getDailyLogs, getWorkouts } from \"../supabase.js\";\n\nexport function createGetProgressReportTool(client: SupabaseClient, userId: string) {\n\treturn tool(\n\t\tasync ({ days }) => {\n\t\t\tconst lookbackDays = days ?? 14;\n\t\t\tconst fromDate = new Date(Date.now() - lookbackDays * 86400000).toISOString().split(\"T\")[0];\n\n\t\t\tconst [workouts, dailyLogs] = await Promise.all([\n\t\t\t\tgetWorkouts(client, userId, { fromDate, limit: 200 }),\n\t\t\t\tgetDailyLogs(client, userId, { fromDate, limit: 200 }),\n\t\t\t]);\n\n\t\t\t// \u2500\u2500 Workout summary \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\n\t\t\tconst byActivity: Record<string, { count: number; totalMin: number; totalKm: number }> = {};\n\t\t\tfor (const w of workouts) {\n\t\t\t\tconst key = w.activity_type;\n\t\t\t\tif (!byActivity[key]) byActivity[key] = { count: 0, totalMin: 0, totalKm: 0 };\n\t\t\t\tbyActivity[key].count++;\n\t\t\t\tbyActivity[key].totalMin += w.duration_s ? Math.round(w.duration_s / 60) : 0;\n\t\t\t\tbyActivity[key].totalKm += w.distance_m ? +(w.distance_m / 1000).toFixed(2) : 0;\n\t\t\t}\n\n\t\t\t// \u2500\u2500 Health trends \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\n\t\t\tconst sleepValues = dailyLogs.map((d) => d.sleep_hours).filter((v): v is number => v != null);\n\t\t\tconst hrvValues = dailyLogs.map((d) => d.hrv).filter((v): v is number => v != null);\n\t\t\tconst moodValues = dailyLogs.map((d) => d.mood).filter((v): v is number => v != null);\n\t\t\tconst rpeValues = dailyLogs.map((d) => d.rpe).filter((v): v is number => v != null);\n\n\t\t\tconst avg = (arr: number[]) =>\n\t\t\t\tarr.length ? +(arr.reduce((a, b) => a + b, 0) / arr.length).toFixed(1) : null;\n\n\t\t\treturn JSON.stringify({\n\t\t\t\tperiod: `Last ${lookbackDays} days`,\n\t\t\t\ttotalWorkouts: workouts.length,\n\t\t\t\tbyActivity,\n\t\t\t\thealthTrends: {\n\t\t\t\t\tavgSleepHours: avg(sleepValues),\n\t\t\t\t\tavgHrv: avg(hrvValues),\n\t\t\t\t\tavgMood: avg(moodValues),\n\t\t\t\t\tavgRpe: avg(rpeValues),\n\t\t\t\t\tdaysLogged: dailyLogs.length,\n\t\t\t\t},\n\t\t\t});\n\t\t},\n\t\t{\n\t\t\tname: \"get_progress_report\",\n\t\t\tdescription:\n\t\t\t\t'Generates a progress report with workout summaries and health trends. Use for weekly reviews, trend analysis, or when the athlete asks \"how am I doing?\"',\n\t\t\tschema: z.object({\n\t\t\t\tdays: z.number().optional().describe(\"Number of days to analyze (default 14)\"),\n\t\t\t}),\n\t\t},\n\t);\n}\n", "import { tool } from \"@langchain/core/tools\";\nimport type { SupabaseClient } from \"@supabase/supabase-js\";\nimport { z } from \"zod\";\n\nexport function createGetSquadLeaderboardTool(client: SupabaseClient, userId: string) {\n\treturn tool(\n\t\tasync ({ timeframeDays }) => {\n\t\t\ttry {\n\t\t\t\tconst days = timeframeDays || 7;\n\t\t\t\tconst threshold = new Date(Date.now() - days * 24 * 60 * 60 * 1000).toISOString();\n\n\t\t\t\t// 1. Get the squads the user is a member of\n\t\t\t\tconst { data: squadMemberships, error: squadErr } = await client\n\t\t\t\t\t.from(\"squad_members\")\n\t\t\t\t\t.select(\"squad_id, squads(name)\")\n\t\t\t\t\t.eq(\"athlete_id\", userId);\n\n\t\t\t\tif (squadErr || !squadMemberships || squadMemberships.length === 0) {\n\t\t\t\t\treturn \"User is not currently in any squads.\";\n\t\t\t\t}\n\n\t\t\t\tconst squadIds = squadMemberships.map((m) => m.squad_id);\n\n\t\t\t\t// 2. Get all members of those squads\n\t\t\t\tconst { data: allMembers, error: memErr } = await client\n\t\t\t\t\t.from(\"squad_members\")\n\t\t\t\t\t.select(\"squad_id, athlete_id, squads(name), profiles(display_name)\")\n\t\t\t\t\t.in(\"squad_id\", squadIds);\n\n\t\t\t\tif (memErr || !allMembers) {\n\t\t\t\t\treturn \"Could not retrieve squad members.\";\n\t\t\t\t}\n\n\t\t\t\tconst athleteIds = [...new Set(allMembers.map((m) => m.athlete_id))];\n\n\t\t\t\t// 3. Get recent workouts for those members\n\t\t\t\tconst { data: workouts, error: workErr } = await client\n\t\t\t\t\t.from(\"workouts\")\n\t\t\t\t\t.select(\"athlete_id, duration_s\")\n\t\t\t\t\t.in(\"athlete_id\", athleteIds)\n\t\t\t\t\t.gte(\"started_at\", threshold);\n\n\t\t\t\tif (workErr || !workouts) {\n\t\t\t\t\treturn \"Could not retrieve recent workouts for leaderboard.\";\n\t\t\t\t}\n\n\t\t\t\t// Aggregate by athlete\n\t\t\t\tconst leaderboard = athleteIds\n\t\t\t\t\t.map((aId) => {\n\t\t\t\t\t\tconst athleteWorkouts = workouts.filter((w) => w.athlete_id === aId);\n\t\t\t\t\t\tconst totalDurationS = athleteWorkouts.reduce((sum, w) => sum + (w.duration_s || 0), 0);\n\t\t\t\t\t\tconst profile = allMembers.find((m) => m.athlete_id === aId)?.profiles;\n\t\t\t\t\t\tconst displayName =\n\t\t\t\t\t\t\tprofile && typeof profile === \"object\" && \"display_name\" in profile\n\t\t\t\t\t\t\t\t? profile.display_name\n\t\t\t\t\t\t\t\t: \"Unknown Athlete\";\n\n\t\t\t\t\t\treturn {\n\t\t\t\t\t\t\tathleteId: aId,\n\t\t\t\t\t\t\tdisplayName,\n\t\t\t\t\t\t\ttotalWorkouts: athleteWorkouts.length,\n\t\t\t\t\t\t\ttotalDurationMinutes: Math.round(totalDurationS / 60),\n\t\t\t\t\t\t};\n\t\t\t\t\t})\n\t\t\t\t\t.sort((a, b) => b.totalDurationMinutes - a.totalDurationMinutes);\n\n\t\t\t\tconst result = {\n\t\t\t\t\ttimeframe: `Past ${days} days`,\n\t\t\t\t\tsquads: [\n\t\t\t\t\t\t...new Set(\n\t\t\t\t\t\t\tsquadMemberships.map((m) => {\n\t\t\t\t\t\t\t\tconst squad = m.squads;\n\t\t\t\t\t\t\t\treturn squad && typeof squad === \"object\" && \"name\" in squad\n\t\t\t\t\t\t\t\t\t? squad.name\n\t\t\t\t\t\t\t\t\t: \"Unknown Squad\";\n\t\t\t\t\t\t\t}),\n\t\t\t\t\t\t),\n\t\t\t\t\t],\n\t\t\t\t\tleaderboard: leaderboard.map((l, index) => ({\n\t\t\t\t\t\trank: index + 1,\n\t\t\t\t\t\tathlete: l.athleteId === userId ? `${l.displayName} (You)` : l.displayName,\n\t\t\t\t\t\tworkouts: l.totalWorkouts,\n\t\t\t\t\t\tminutes: l.totalDurationMinutes,\n\t\t\t\t\t})),\n\t\t\t\t};\n\n\t\t\t\treturn JSON.stringify(result, null, 2);\n\t\t\t} catch (error) {\n\t\t\t\tconst msg = error instanceof Error ? error.message : \"Unknown error\";\n\t\t\t\treturn `Error fetching squad leaderboard: ${msg}. Please try again.`;\n\t\t\t}\n\t\t},\n\t\t{\n\t\t\tname: \"get_squad_leaderboard\",\n\t\t\tdescription:\n\t\t\t\t\"Gets the workout leaderboard for the athlete's squads, ranking members by accumulated workout minutes over the specified timeframe.\",\n\t\t\tschema: z.object({\n\t\t\t\ttimeframeDays: z.number().optional().describe(\"Number of days to look back\"),\n\t\t\t}),\n\t\t},\n\t);\n}\n", "// ============================================================\n// Tool: Get Training Plan\n// Fetches the active training plan and upcoming events\n// ============================================================\n\nimport { tool } from \"@langchain/core/tools\";\nimport type { SupabaseClient } from \"@supabase/supabase-js\";\nimport { z } from \"zod\";\nimport { getTrainingPlan, getUpcomingEvents } from \"../supabase.js\";\n\nexport function createGetTrainingPlanTool(client: SupabaseClient, userId: string) {\n\treturn tool(\n\t\tasync () => {\n\t\t\ttry {\n\t\t\t\tconst [plan, events] = await Promise.all([\n\t\t\t\t\tgetTrainingPlan(client, userId),\n\t\t\t\t\tgetUpcomingEvents(client, userId, 5),\n\t\t\t\t]);\n\n\t\t\t\treturn JSON.stringify({\n\t\t\t\t\tplan: plan\n\t\t\t\t\t\t? {\n\t\t\t\t\t\t\t\tid: plan.id,\n\t\t\t\t\t\t\t\tname: plan.name,\n\t\t\t\t\t\t\t\tstatus: plan.status,\n\t\t\t\t\t\t\t\tplanData: plan.plan_data,\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t: null,\n\t\t\t\t\tupcomingEvents: events.map((e) => ({\n\t\t\t\t\t\tid: e.id,\n\t\t\t\t\t\tname: e.name,\n\t\t\t\t\t\tdate: e.event_date,\n\t\t\t\t\t\tdistanceType: e.distance_type,\n\t\t\t\t\t})),\n\t\t\t\t});\n\t\t\t} catch (error) {\n\t\t\t\tconst msg = error instanceof Error ? error.message : \"Unknown error\";\n\t\t\t\treturn `Error fetching training plan: ${msg}. Please try again.`;\n\t\t\t}\n\t\t},\n\t\t{\n\t\t\tname: \"get_training_plan\",\n\t\t\tdescription:\n\t\t\t\t\"Fetches the active training plan and upcoming events. Use when asked about scheduled workouts, race calendar, or training blocks.\",\n\t\t\tschema: z.object({}),\n\t\t},\n\t);\n}\n", "// ============================================================\n// Tool: Get Workout History\n// Fetches recent workouts with optional filters.\n// For STRENGTH workouts, parses raw_data into a compact\n// exercise summary with e1RM, volume, and top sets.\n// ============================================================\n\nimport { tool } from \"@langchain/core/tools\";\nimport type { SupabaseClient } from \"@supabase/supabase-js\";\nimport { z } from \"zod\";\nimport { getWorkouts } from \"../supabase.js\";\nimport {\n\tcomputeAverageRPE,\n\tcomputeSessionVolume,\n\ttype ExerciseData,\n\tsummarizeStrengthWorkout,\n} from \"../utils/strength-utils.js\";\n\nexport function createGetWorkoutHistoryTool(client: SupabaseClient, userId: string) {\n\treturn tool(\n\t\tasync ({ activityType, fromDate, toDate, limit }) => {\n\t\t\ttry {\n\t\t\t\tconst workouts = await getWorkouts(client, userId, {\n\t\t\t\t\tactivityType,\n\t\t\t\t\tfromDate,\n\t\t\t\t\ttoDate,\n\t\t\t\t\tlimit: limit ?? 10,\n\t\t\t\t});\n\n\t\t\t\tif (!workouts.length) return \"No workouts found for the given filters.\";\n\n\t\t\t\treturn JSON.stringify(\n\t\t\t\t\tworkouts.map((w) => {\n\t\t\t\t\t\tconst base = {\n\t\t\t\t\t\t\tdate: w.started_at,\n\t\t\t\t\t\t\tactivityType: w.activity_type,\n\t\t\t\t\t\t\tdurationMin: w.duration_s ? Math.round(w.duration_s / 60) : null,\n\t\t\t\t\t\t\tnotes: w.notes,\n\t\t\t\t\t\t};\n\n\t\t\t\t\t\t// For STRENGTH workouts: parse raw_data into exercise summaries\n\t\t\t\t\t\tif (w.activity_type === \"STRENGTH\" && w.raw_data) {\n\t\t\t\t\t\t\tconst exerciseSummaries = summarizeStrengthWorkout(w.raw_data);\n\t\t\t\t\t\t\tconst rawExercises = (w.raw_data as Record<string, unknown>)?.exercises as\n\t\t\t\t\t\t\t\t| ExerciseData[]\n\t\t\t\t\t\t\t\t| undefined;\n\n\t\t\t\t\t\t\treturn {\n\t\t\t\t\t\t\t\t...base,\n\t\t\t\t\t\t\t\texercises: exerciseSummaries,\n\t\t\t\t\t\t\t\tsessionVolume_kg: rawExercises ? computeSessionVolume(rawExercises) : null,\n\t\t\t\t\t\t\t\tavgRPE: rawExercises ? computeAverageRPE(rawExercises) : null,\n\t\t\t\t\t\t\t};\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\t// For cardio/other workouts: return standard metrics\n\t\t\t\t\t\treturn {\n\t\t\t\t\t\t\t...base,\n\t\t\t\t\t\t\tdistanceKm: w.distance_m ? +(w.distance_m / 1000).toFixed(2) : null,\n\t\t\t\t\t\t\tavgHr: w.avg_hr,\n\t\t\t\t\t\t\tmaxHr: w.max_hr,\n\t\t\t\t\t\t\tavgPower: w.avg_power_w,\n\t\t\t\t\t\t\ttss: w.tss,\n\t\t\t\t\t\t};\n\t\t\t\t\t}),\n\t\t\t\t);\n\t\t\t} catch (error) {\n\t\t\t\tconst msg = error instanceof Error ? error.message : \"Unknown error\";\n\t\t\t\treturn `Error fetching workout history: ${msg}. Please check parameters and try again.`;\n\t\t\t}\n\t\t},\n\t\t{\n\t\t\tname: \"get_workout_history\",\n\t\t\tdescription:\n\t\t\t\t\"Retrieves recent workouts for the athlete. For STRENGTH workouts returns exercise details including top sets, volume, and estimated 1RM. Use to compare sessions and track progressive overload.\",\n\t\t\tschema: z.object({\n\t\t\t\tactivityType: z\n\t\t\t\t\t.string()\n\t\t\t\t\t.optional()\n\t\t\t\t\t.describe(\"Filter by activity type: SWIM, BIKE, RUN, STRENGTH, YOGA, OTHER\"),\n\t\t\t\tfromDate: z.string().optional().describe(\"Start date filter (YYYY-MM-DD)\"),\n\t\t\t\ttoDate: z.string().optional().describe(\"End date filter (YYYY-MM-DD)\"),\n\t\t\t\tlimit: z.number().optional().describe(\"Max workouts to return (default 10, max 50)\"),\n\t\t\t}),\n\t\t},\n\t);\n}\n", "// ============================================================\n// Strength Training Utility Functions\n// Pure functions for 1RM estimation, volume computation,\n// and workout summarization.\n// Moved from apps/api/src/services/ai/utils/strength-utils.ts\n// ============================================================\n\n// \u2500\u2500 Types \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\n\nexport interface SetData {\n\treps: number;\n\tweight_kg: number;\n\trpe?: number;\n\trir?: number;\n\ttempo?: string;\n\tset_type?: \"working\" | \"warmup\" | \"dropset\" | \"backoff\" | \"amrap\" | \"cluster\";\n}\n\nexport interface ExerciseData {\n\tname: string;\n\tsets: SetData[];\n\tgroup_id?: number;\n\tgroup_type?: \"superset\" | \"circuit\" | \"giant_set\";\n\tnotes?: string;\n}\n\nexport interface ExerciseSummary {\n\tname: string;\n\tworkingSets: number;\n\ttopSet: { weight_kg: number; reps: number; rpe?: number } | null;\n\ttotalVolume_kg: number;\n\testimated1RM_kg: number | null;\n\tgroup_id?: number;\n\tgroup_type?: string;\n}\n\n// \u2500\u2500 1RM Estimation \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\n\n/**\n * Rep-range-adaptive 1RM estimation.\n *\n * Formula selection based on research accuracy:\n *   - 1 rep   -> identity (actual 1RM)\n *   - <=6 reps -> Brzycki (most accurate for heavy loads)\n *   - 7-10    -> Epley (best for moderate rep ranges)\n *   - >10     -> Lombardi (most conservative, avoids overestimation)\n *\n * Returns the estimated 1RM in the same unit as weight, rounded to 1 decimal.\n */\nexport function estimate1RM(weight: number, reps: number): number | null {\n\tif (weight <= 0 || reps <= 0) return null;\n\tif (reps === 1) return weight;\n\n\tlet estimate: number;\n\n\tif (reps <= 6) {\n\t\t// Brzycki: 1RM = W / (1.0278 - 0.0278 x R)\n\t\tconst denominator = 1.0278 - 0.0278 * reps;\n\t\tif (denominator <= 0) return null;\n\t\testimate = weight / denominator;\n\t} else if (reps <= 10) {\n\t\t// Epley: 1RM = W x (1 + R / 30)\n\t\testimate = weight * (1 + reps / 30);\n\t} else {\n\t\t// Lombardi: 1RM = W x R^0.10\n\t\testimate = weight * reps ** 0.1;\n\t}\n\n\treturn Math.round(estimate * 10) / 10;\n}\n\n// \u2500\u2500 Volume Computation \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\n\n/** Compute total volume (weight x reps) from working sets only. Excludes warmup sets. */\nexport function computeVolume(sets: SetData[]): number {\n\treturn sets\n\t\t.filter((s) => s.set_type !== \"warmup\")\n\t\t.reduce((sum, s) => sum + s.weight_kg * s.reps, 0);\n}\n\n/** Find the \"top set\" \u2014 the working set with the highest estimated 1RM. */\nexport function findTopSet(sets: SetData[]): SetData | null {\n\tconst workingSets = sets.filter((s) => s.set_type !== \"warmup\");\n\tif (workingSets.length === 0) return null;\n\n\tlet best: SetData | null = null;\n\tlet bestE1RM = 0;\n\n\tfor (const s of workingSets) {\n\t\tconst e1rm = estimate1RM(s.weight_kg, s.reps);\n\t\tif (e1rm !== null && e1rm > bestE1RM) {\n\t\t\tbestE1RM = e1rm;\n\t\t\tbest = s;\n\t\t}\n\t}\n\n\treturn best;\n}\n\n// \u2500\u2500 Workout Summarization \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\n\n/** Parse raw_data from a STRENGTH workout into a compact summary. */\nexport function summarizeStrengthWorkout(rawData: unknown): ExerciseSummary[] {\n\tif (!rawData || typeof rawData !== \"object\") return [];\n\n\tconst data = rawData as Record<string, unknown>;\n\tconst exercises = data.exercises as ExerciseData[] | undefined;\n\tif (!Array.isArray(exercises)) return [];\n\n\treturn exercises.map((ex) => {\n\t\tconst workingSets = ex.sets.filter((s) => s.set_type !== \"warmup\");\n\t\tconst topSet = findTopSet(ex.sets);\n\t\tconst totalVolume = computeVolume(ex.sets);\n\t\tconst e1rm = topSet ? estimate1RM(topSet.weight_kg, topSet.reps) : null;\n\n\t\treturn {\n\t\t\tname: ex.name,\n\t\t\tworkingSets: workingSets.length,\n\t\t\ttopSet: topSet ? { weight_kg: topSet.weight_kg, reps: topSet.reps, rpe: topSet.rpe } : null,\n\t\t\ttotalVolume_kg: totalVolume,\n\t\t\testimated1RM_kg: e1rm,\n\t\t\t...(ex.group_id !== undefined && { group_id: ex.group_id }),\n\t\t\t...(ex.group_type && { group_type: ex.group_type }),\n\t\t};\n\t});\n}\n\n/** Compute the average RPE across all working sets in a workout's exercises. */\nexport function computeAverageRPE(exercises: ExerciseData[]): number | null {\n\tconst rpeValues: number[] = [];\n\tfor (const ex of exercises) {\n\t\tfor (const s of ex.sets) {\n\t\t\tif (s.set_type !== \"warmup\" && s.rpe !== undefined) {\n\t\t\t\trpeValues.push(s.rpe);\n\t\t\t}\n\t\t}\n\t}\n\tif (rpeValues.length === 0) return null;\n\treturn Math.round((rpeValues.reduce((a, b) => a + b, 0) / rpeValues.length) * 10) / 10;\n}\n\n/** Compute total session volume across all exercises. */\nexport function computeSessionVolume(exercises: ExerciseData[]): number {\n\treturn exercises.reduce((sum, ex) => sum + computeVolume(ex.sets), 0);\n}\n\n// \u2500\u2500 Frontend Strength Metrics \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\n\nimport type { StrengthSessionData } from \"@triathlon/types\";\n\nexport type StrengthMetrics = {\n\tweeklyVolumeLoad: number;\n\tavgDensity: number;\n\tmuscleSplit: Record<string, number>;\n};\n\n/** Minimal workout shape for strength metric computation. */\nexport type StrengthWorkoutLike = {\n\tactivityType: string;\n\tstartedAt: string;\n\tdurationSec: number;\n\trawData?: unknown;\n};\n\n/** Compute aggregate strength metrics for the last 7 days. */\nexport function computeStrengthMetrics(workouts: StrengthWorkoutLike[]): StrengthMetrics {\n\tconst now = Date.now();\n\tconst weekAgo = now - 7 * 24 * 60 * 60 * 1000;\n\tconst thisWeek = workouts\n\t\t.filter((w) => new Date(w.startedAt).getTime() >= weekAgo)\n\t\t.filter((w) => w.activityType === \"STRENGTH\");\n\n\tlet totalVolume = 0;\n\tlet totalDensity = 0;\n\tconst muscleSplit: Record<string, number> = {};\n\n\tfor (const w of thisWeek) {\n\t\tconst data = w.rawData as StrengthSessionData | undefined;\n\t\tif (!data?.exercises) continue;\n\n\t\tlet sessionVolume = 0;\n\t\tfor (const ex of data.exercises) {\n\t\t\tmuscleSplit[ex.muscleGroup] = (muscleSplit[ex.muscleGroup] || 0) + ex.sets.length;\n\t\t\tfor (const set of ex.sets) {\n\t\t\t\tsessionVolume += set.weightKg * set.reps;\n\t\t\t}\n\t\t}\n\n\t\ttotalVolume += sessionVolume;\n\t\tif (w.durationSec > 0) {\n\t\t\ttotalDensity += sessionVolume / (w.durationSec / 60);\n\t\t}\n\t}\n\n\treturn {\n\t\tweeklyVolumeLoad: totalVolume,\n\t\tavgDensity: thisWeek.length > 0 ? Math.round(totalDensity / thisWeek.length) : 0,\n\t\tmuscleSplit,\n\t};\n}\n", "import { tool } from \"@langchain/core/tools\";\nimport type { SupabaseClient } from \"@supabase/supabase-js\";\nimport { z } from \"zod\";\nimport { insertInjury } from \"../supabase.js\";\n\nexport function createLogInjuryTool(client: SupabaseClient, userId: string) {\n\treturn tool(\n\t\tasync ({ bodyPart, severity, date, notes }) => {\n\t\t\ttry {\n\t\t\t\tconst reportedAt = date ?? new Date().toISOString().split(\"T\")[0];\n\n\t\t\t\tconst injury = await insertInjury(client, {\n\t\t\t\t\tathlete_id: userId,\n\t\t\t\t\tbody_part: bodyPart,\n\t\t\t\t\tseverity,\n\t\t\t\t\treported_at: reportedAt,\n\t\t\t\t\tnotes,\n\t\t\t\t});\n\n\t\t\t\treturn `Injury logged successfully for ${injury.body_part} with severity ${injury.severity}/100. Let the athlete know you've noted it down and remind them to take it easy if the severity is high.`;\n\t\t\t} catch (error) {\n\t\t\t\tconst msg = error instanceof Error ? error.message : \"Unknown error\";\n\t\t\t\treturn `Error logging injury: ${msg}. Please try again.`;\n\t\t\t}\n\t\t},\n\t\t{\n\t\t\tname: \"log_injury\",\n\t\t\tdescription:\n\t\t\t\t\"Logs a new physical issue, pain, or injury for the athlete. Severity is 1-100 (100 being extreme pain/unable to train). Use when the athlete mentions soreness or pain in a specific body part.\",\n\t\t\tschema: z.object({\n\t\t\t\tbodyPart: z\n\t\t\t\t\t.string()\n\t\t\t\t\t.describe(\n\t\t\t\t\t\t\"The specific muscle or joint affected (e.g., 'Left Knee', 'Lower Back', 'Hamstrings')\",\n\t\t\t\t\t),\n\t\t\t\tseverity: z.number().min(1).max(100).describe(\"Severity score from 1-100\"),\n\t\t\t\tdate: z.string().optional().describe(\"Date reported (YYYY-MM-DD), defaults to today\"),\n\t\t\t\tnotes: z.string().optional().describe(\"Additional context about the injury or pain\"),\n\t\t\t}),\n\t\t},\n\t);\n}\n", "// ============================================================\n// Tool: Log Workout\n// Inserts a new workout record for the athlete.\n// For STRENGTH workouts, stores structured exercise data\n// (exercises \u2192 sets \u2192 reps/weight/RPE) in the raw_data JSONB column.\n// ============================================================\n\nimport { tool } from \"@langchain/core/tools\";\nimport { AzureOpenAIEmbeddings } from \"@langchain/openai\";\nimport type { SupabaseClient } from \"@supabase/supabase-js\";\nimport { z } from \"zod\";\nimport { AI_CONFIG } from \"../../../config/ai.js\";\nimport { createLogger } from \"../../../lib/logger.js\";\nimport { insertWorkout } from \"../supabase.js\";\n\nconst log = createLogger({ module: \"tool-log-workout\" });\n\n// \u2500\u2500 Zod schemas for structured strength data \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\n\nconst setSchema = z.object({\n\treps: z.number().describe(\"Number of reps performed\"),\n\tweight_kg: z.number().describe(\"Weight in kg\"),\n\trpe: z\n\t\t.number()\n\t\t.min(1)\n\t\t.max(10)\n\t\t.optional()\n\t\t.describe(\"Rate of Perceived Exertion (1-10). 10 = absolute max effort\"),\n\trir: z.number().min(0).max(5).optional().describe(\"Reps In Reserve (0-5). 0 = failure\"),\n\ttempo: z\n\t\t.string()\n\t\t.optional()\n\t\t.describe('Tempo notation e.g. \"3-1-2-0\" (eccentric-pause-concentric-pause in seconds)'),\n\tset_type: z\n\t\t.enum([\"working\", \"warmup\", \"dropset\", \"backoff\", \"amrap\", \"cluster\"])\n\t\t.optional()\n\t\t.default(\"working\")\n\t\t.describe('Type of this set. Default is \"working\"'),\n});\n\nconst exerciseSchema = z.object({\n\tname: z.string().describe('Exercise name e.g. \"Barbell Back Squat\", \"Dumbbell Bench Press\"'),\n\tsets: z.array(setSchema).describe(\"Array of sets performed for this exercise\"),\n\tgroup_id: z\n\t\t.number()\n\t\t.optional()\n\t\t.describe(\n\t\t\t\"Group number for supersets/circuits. Exercises with the same group_id are grouped together\",\n\t\t),\n\tgroup_type: z\n\t\t.enum([\"superset\", \"circuit\", \"giant_set\"])\n\t\t.optional()\n\t\t.describe(\"Type of exercise grouping, if this exercise is part of a group\"),\n\tnotes: z\n\t\t.string()\n\t\t.optional()\n\t\t.describe('Exercise-specific notes e.g. \"felt tight in left shoulder\"'),\n});\n\nconst workoutLogSchema = z.object({\n\tactivityType: z.string().describe(\"Activity type: SWIM, BIKE, RUN, STRENGTH, YOGA, OTHER\"),\n\tstartedAt: z.string().optional().describe(\"Start date/time in ISO 8601 (defaults to now)\"),\n\tdurationMin: z.number().optional().describe(\"Total workout duration in minutes\"),\n\tdistanceKm: z.number().optional().describe(\"Distance in kilometers (for cardio workouts)\"),\n\tavgHr: z.number().optional().describe(\"Average heart rate\"),\n\ttss: z.number().optional().describe(\"Training Stress Score\"),\n\tnotes: z.string().optional().describe(\"General workout notes\"),\n\texercises: z\n\t\t.array(exerciseSchema)\n\t\t.optional()\n\t\t.describe(\n\t\t\t\"Structured exercise data for STRENGTH workouts. Include exercises with their sets, reps, and weights.\",\n\t\t),\n});\n\n// \u2500\u2500 Tool factory \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\n\nexport function createLogWorkoutTool(client: SupabaseClient, userId: string, clubId: string) {\n\treturn tool(\n\t\tasync (input) => {\n\t\t\ttry {\n\t\t\t\tconst startedAt = input.startedAt ?? new Date().toISOString();\n\n\t\t\t\t// Build raw_data for strength workouts\n\t\t\t\tconst rawData =\n\t\t\t\t\tinput.exercises && input.exercises.length > 0\n\t\t\t\t\t\t? {\n\t\t\t\t\t\t\t\texercises: input.exercises,\n\t\t\t\t\t\t\t\tmetadata: { source: \"COACH\", schema_version: 2 },\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t: null;\n\n\t\t\t\t// Generate embedding for natural language search\n\t\t\t\tlet embedding: number[] | undefined;\n\t\t\t\tif (input.notes || rawData?.exercises) {\n\t\t\t\t\ttry {\n\t\t\t\t\t\tconst textToEmbed = `Activity: ${input.activityType}. Notes: ${input.notes ?? \"None\"}. Ex: ${\n\t\t\t\t\t\t\trawData?.exercises ? JSON.stringify(rawData.exercises) : \"None\"\n\t\t\t\t\t\t}`;\n\t\t\t\t\t\tconst embeddingsModel = new AzureOpenAIEmbeddings({\n\t\t\t\t\t\t\tazureOpenAIApiKey: AI_CONFIG.azure.apiKey,\n\t\t\t\t\t\t\tazureOpenAIApiInstanceName: AI_CONFIG.azure.endpoint\n\t\t\t\t\t\t\t\t.split(\".\")[0]\n\t\t\t\t\t\t\t\t.replace(\"https://\", \"\"),\n\t\t\t\t\t\t\tazureOpenAIApiDeploymentName: AI_CONFIG.azure.embeddingsDeployment,\n\t\t\t\t\t\t\tazureOpenAIApiVersion: AI_CONFIG.azure.apiVersion,\n\t\t\t\t\t\t});\n\t\t\t\t\t\tembedding = await embeddingsModel.embedQuery(textToEmbed);\n\t\t\t\t\t} catch (err) {\n\t\t\t\t\t\tlog.error({ err }, \"Failed to generate embedding for workout\");\n\t\t\t\t\t}\n\t\t\t\t}\n\n\t\t\t\tconst workout = await insertWorkout(client, {\n\t\t\t\t\tathlete_id: userId,\n\t\t\t\t\tclub_id: clubId,\n\t\t\t\t\tactivity_type: input.activityType,\n\t\t\t\t\tsource: \"MANUAL\",\n\t\t\t\t\tstarted_at: startedAt,\n\t\t\t\t\tduration_s: input.durationMin ? input.durationMin * 60 : null,\n\t\t\t\t\tdistance_m: input.distanceKm ? input.distanceKm * 1000 : null,\n\t\t\t\t\tavg_hr: input.avgHr ?? null,\n\t\t\t\t\tmax_hr: null,\n\t\t\t\t\tavg_pace_s_km: null,\n\t\t\t\t\tavg_power_w: null,\n\t\t\t\t\tcalories: null,\n\t\t\t\t\ttss: input.tss ?? null,\n\t\t\t\t\traw_data: rawData,\n\t\t\t\t\tnotes: input.notes ?? null,\n\t\t\t\t\tembedding: embedding,\n\t\t\t\t});\n\n\t\t\t\t// Build response with exercise summary for STRENGTH workouts\n\t\t\t\tif (rawData?.exercises) {\n\t\t\t\t\tconst exerciseLines = rawData.exercises.map((ex) => {\n\t\t\t\t\t\tconst workingSets = ex.sets.filter((s) => s.set_type !== \"warmup\");\n\t\t\t\t\t\tconst totalVol = workingSets.reduce((sum, s) => sum + s.weight_kg * s.reps, 0);\n\t\t\t\t\t\treturn `  - ${ex.name}: ${workingSets.length} working sets, ${totalVol} kg total volume`;\n\t\t\t\t\t});\n\t\t\t\t\treturn `Workout logged successfully (ID: ${workout.id}).\\nActivity: ${workout.activity_type}, Date: ${workout.started_at}\\n\\nExercises logged:\\n${exerciseLines.join(\"\\n\")}\\n\\nNow retrieve workout history to compare this session against recent ones.`;\n\t\t\t\t}\n\n\t\t\t\treturn `Workout logged successfully (ID: ${workout.id}). Activity: ${workout.activity_type}, Date: ${workout.started_at}`;\n\t\t\t} catch (error) {\n\t\t\t\tconst msg = error instanceof Error ? error.message : \"Unknown error\";\n\t\t\t\treturn `Error logging workout: ${msg}. Please double check the input and try again.`;\n\t\t\t}\n\t\t},\n\t\t{\n\t\t\tname: \"log_workout\",\n\t\t\tdescription:\n\t\t\t\t\"Logs a new workout for the athlete. For STRENGTH workouts, include structured exercise data (exercises with sets, reps, weight, RPE). Always confirm details with the athlete before calling this tool.\",\n\t\t\tschema: workoutLogSchema,\n\t\t},\n\t);\n}\n", "// ============================================================\n// Tool: Match Documents (Vector Search)\n// Performs semantic search over the athlete's club knowledge base\n// ============================================================\n\nimport { tool } from \"@langchain/core/tools\";\nimport { AzureOpenAIEmbeddings } from \"@langchain/openai\";\nimport type { SupabaseClient } from \"@supabase/supabase-js\";\nimport { z } from \"zod\";\nimport { AI_CONFIG } from \"../../../config/ai.js\";\n\nexport function createMatchDocumentsTool(client: SupabaseClient, clubId: string) {\n\treturn tool(\n\t\tasync ({ query, threshold = 0.7, limit = 5 }) => {\n\t\t\ttry {\n\t\t\t\t// Initialize embeddings\n\t\t\t\tconst embeddings = new AzureOpenAIEmbeddings({\n\t\t\t\t\tazureOpenAIApiKey: AI_CONFIG.azure.apiKey,\n\t\t\t\t\tazureOpenAIApiInstanceName: AI_CONFIG.azure.endpoint\n\t\t\t\t\t\t.split(\".\")[0]\n\t\t\t\t\t\t.replace(\"https://\", \"\"),\n\t\t\t\t\tazureOpenAIApiDeploymentName: AI_CONFIG.azure.embeddingsDeployment,\n\t\t\t\t\tazureOpenAIApiVersion: AI_CONFIG.azure.apiVersion,\n\t\t\t\t});\n\n\t\t\t\t// Generate vector for the query\n\t\t\t\tconst query_embedding = await embeddings.embedQuery(query);\n\n\t\t\t\t// Call the Supabase RPC match_documents\n\t\t\t\tconst { data, error } = await client.rpc(\"match_documents\", {\n\t\t\t\t\tquery_embedding,\n\t\t\t\t\tmatch_threshold: threshold,\n\t\t\t\t\tmatch_count: limit,\n\t\t\t\t\tfilter_club_id: clubId,\n\t\t\t\t});\n\n\t\t\t\tif (error) {\n\t\t\t\t\treturn `Error searching documents: ${error.message}`;\n\t\t\t\t}\n\n\t\t\t\tif (!data || data.length === 0) {\n\t\t\t\t\treturn \"No highly relevant documents found for that query.\";\n\t\t\t\t}\n\n\t\t\t\treturn JSON.stringify(\n\t\t\t\t\tdata.map((d: any) => ({\n\t\t\t\t\t\ttitle: d.title,\n\t\t\t\t\t\tcontent: d.content,\n\t\t\t\t\t\tsimilarity: d.similarity,\n\t\t\t\t\t})),\n\t\t\t\t);\n\t\t\t} catch (error) {\n\t\t\t\tconst msg = error instanceof Error ? error.message : \"Unknown error\";\n\t\t\t\treturn `Error searching documents: ${msg}. Please try again.`;\n\t\t\t}\n\t\t},\n\t\t{\n\t\t\tname: \"match_documents\",\n\t\t\tdescription:\n\t\t\t\t\"Performs semantic search to find knowledge base documents (e.g. PDFs, articles) uploaded by the club. Useful for answering general fitness, nutrition, or club-specific policy questions.\",\n\t\t\tschema: z.object({\n\t\t\t\tquery: z.string().describe(\"The search query or question\"),\n\t\t\t\tthreshold: z\n\t\t\t\t\t.number()\n\t\t\t\t\t.optional()\n\t\t\t\t\t.describe(\"Minimum similarity threshold (0-1). Default 0.7\"),\n\t\t\t\tlimit: z.number().optional().describe(\"Maximum number of documents to return. Default 5\"),\n\t\t\t}),\n\t\t},\n\t);\n}\n", "// ============================================================\n// Tool: Modify Training Plan\n// Updates an existing training plan's data or status\n// ============================================================\n\nimport { tool } from \"@langchain/core/tools\";\nimport type { SupabaseClient } from \"@supabase/supabase-js\";\nimport { z } from \"zod\";\nimport { getTrainingPlan, updateTrainingPlan } from \"../supabase.js\";\n\nexport function createModifyTrainingPlanTool(client: SupabaseClient, userId: string) {\n\treturn tool(\n\t\tasync (input) => {\n\t\t\tconst { planData, status } = input;\n\n\t\t\tconst currentPlan = await getTrainingPlan(client, userId);\n\t\t\tif (!currentPlan) return \"No active training plan found. Cannot modify.\";\n\n\t\t\tconst updates: Record<string, unknown> = {};\n\t\t\tif (planData !== undefined) updates.plan_data = planData;\n\t\t\tif (status !== undefined) updates.status = status;\n\n\t\t\tif (Object.keys(updates).length === 0) return \"No changes specified.\";\n\n\t\t\tconst updated = await updateTrainingPlan(client, currentPlan.id, updates);\n\t\t\treturn `Training plan \"${updated.name}\" updated successfully. Status: ${updated.status}`;\n\t\t},\n\t\t{\n\t\t\tname: \"modify_training_plan\",\n\t\t\tdescription:\n\t\t\t\t\"Modifies the active training plan. Can update plan data (sessions, schedule) or status. Always confirm changes with the athlete first.\",\n\t\t\tschema: z.object({\n\t\t\t\tplanData: z\n\t\t\t\t\t.record(z.string(), z.unknown())\n\t\t\t\t\t.optional()\n\t\t\t\t\t.describe(\"Updated plan data object (sessions, schedule, notes)\"),\n\t\t\t\tstatus: z\n\t\t\t\t\t.string()\n\t\t\t\t\t.optional()\n\t\t\t\t\t.describe(\"New plan status: ACTIVE, PAUSED, COMPLETED, CANCELLED\"),\n\t\t\t}),\n\t\t},\n\t);\n}\n", "import { tool } from \"@langchain/core/tools\";\nimport type { SupabaseClient } from \"@supabase/supabase-js\";\nimport { z } from \"zod\";\n\nexport function createPassBatonTool(client: SupabaseClient, userId: string) {\n\treturn tool(\n\t\tasync ({ toAthleteId, distanceMeters, notes }) => {\n\t\t\t// 1. Find user's squads\n\t\t\tconst { data: squadMemberships, error: squadErr } = await client\n\t\t\t\t.from(\"squad_members\")\n\t\t\t\t.select(\"squad_id\")\n\t\t\t\t.eq(\"athlete_id\", userId);\n\n\t\t\tif (squadErr || !squadMemberships || squadMemberships.length === 0) {\n\t\t\t\treturn \"User is not currently in any squads.\";\n\t\t\t}\n\n\t\t\tconst squadIds = squadMemberships.map((m) => m.squad_id);\n\n\t\t\t// 2. Find an active relay event for these squads\n\t\t\tconst { data: activeRelays, error: relayErr } = await client\n\t\t\t\t.from(\"relay_events\")\n\t\t\t\t.select(\"*\")\n\t\t\t\t.in(\"squad_id\", squadIds)\n\t\t\t\t.eq(\"status\", \"active\")\n\t\t\t\t.limit(1);\n\n\t\t\tif (relayErr || !activeRelays || activeRelays.length === 0) {\n\t\t\t\treturn \"No active relay events found for the user's squads.\";\n\t\t\t}\n\n\t\t\tconst relay = activeRelays[0];\n\n\t\t\t// 3. Insert baton pass\n\t\t\tconst { error: insertErr } = await client.from(\"baton_passes\").insert({\n\t\t\t\trelay_id: relay.id,\n\t\t\t\tfrom_athlete_id: userId,\n\t\t\t\tto_athlete_id: toAthleteId,\n\t\t\t\tdistance_m: distanceMeters,\n\t\t\t\tpassed_at: new Date().toISOString(),\n\t\t\t});\n\n\t\t\tif (insertErr) {\n\t\t\t\treturn `Failed to pass the baton: ${insertErr.message}`;\n\t\t\t}\n\n\t\t\t// 4. Update relay distance\n\t\t\t// Normally we'd use an RPC for atomic increment, but for MVP we can just calculate it in JS\n\t\t\tconst newTotal = (relay.total_distance_m || 0) + distanceMeters;\n\t\t\tconst isCompleted = newTotal >= relay.goal_distance_m;\n\n\t\t\tconst updatePayload: Record<string, unknown> = {\n\t\t\t\ttotal_distance_m: newTotal,\n\t\t\t};\n\n\t\t\tif (isCompleted) {\n\t\t\t\tupdatePayload.status = \"completed\";\n\t\t\t\tupdatePayload.ended_at = new Date().toISOString();\n\t\t\t}\n\n\t\t\tconst { error: updateErr } = await client\n\t\t\t\t.from(\"relay_events\")\n\t\t\t\t.update(updatePayload)\n\t\t\t\t.eq(\"id\", relay.id);\n\n\t\t\tif (updateErr) {\n\t\t\t\treturn `Baton passed, but failed to update relay total distance: ${updateErr.message}`;\n\t\t\t}\n\n\t\t\treturn JSON.stringify({\n\t\t\t\tsuccess: true,\n\t\t\t\tmessage: `Successfully passed the baton to athlete ${toAthleteId} for ${distanceMeters}m!`,\n\t\t\t\trelayEvent: {\n\t\t\t\t\tid: relay.id,\n\t\t\t\t\ttotalDistanceM: newTotal,\n\t\t\t\t\tgoalDistanceM: relay.goal_distance_m,\n\t\t\t\t\tstatus: isCompleted ? \"completed\" : \"active\",\n\t\t\t\t},\n\t\t\t\tnotes: notes || null,\n\t\t\t});\n\t\t},\n\t\t{\n\t\t\tname: \"pass_baton\",\n\t\t\tdescription:\n\t\t\t\t\"Pass the baton in an active squad relay event. This creates a baton pass record to another squad member and adds distance to the relay total.\",\n\t\t\tschema: z.object({\n\t\t\t\ttoAthleteId: z\n\t\t\t\t\t.string()\n\t\t\t\t\t.describe(\n\t\t\t\t\t\t\"The ID of the squad member to pass the baton to. You can get this ID from the get_squad_leaderboard tool.\",\n\t\t\t\t\t),\n\t\t\t\tdistanceMeters: z\n\t\t\t\t\t.number()\n\t\t\t\t\t.describe(\"The distance in meters contributed to the relay leg by this pass.\"),\n\t\t\t\tnotes: z\n\t\t\t\t\t.string()\n\t\t\t\t\t.optional()\n\t\t\t\t\t.describe(\"Optional message or cheer to send to the next athlete.\"),\n\t\t\t}),\n\t\t},\n\t);\n}\n", "// ============================================================\n// Tool: Predict Injury Risk (ACWR Calculator)\n// Calculates Acute:Chronic Workload Ratio to predict overtraining\n// ============================================================\n\nimport { tool } from \"@langchain/core/tools\";\nimport type { SupabaseClient } from \"@supabase/supabase-js\";\nimport { z } from \"zod\";\nimport { getWorkouts } from \"../supabase.js\";\n\nexport function createPredictInjuryRiskTool(client: SupabaseClient, userId: string) {\n\treturn tool(\n\t\tasync () => {\n\t\t\tconst today = new Date();\n\t\t\tconst fourWeeksAgo = new Date();\n\t\t\tfourWeeksAgo.setDate(today.getDate() - 28);\n\n\t\t\t// Fetch last 28 days of workouts\n\t\t\tconst workouts = await getWorkouts(client, userId, {\n\t\t\t\tfromDate: fourWeeksAgo.toISOString().split(\"T\")[0],\n\t\t\t\ttoDate: today.toISOString().split(\"T\")[0],\n\t\t\t});\n\n\t\t\tif (workouts.length === 0) {\n\t\t\t\treturn \"Not enough workout data in the last 28 days to calculate injury risk.\";\n\t\t\t}\n\n\t\t\t// Calculate daily loads\n\t\t\t// Load = TSS. If no TSS, estimate: (duration_s / 60) * (avg_hr / 150) * 1.5\n\t\t\tconst dailyLoads: Record<string, number> = {};\n\n\t\t\tworkouts.forEach((w) => {\n\t\t\t\tconst dateKey = w.started_at.split(\"T\")[0];\n\t\t\t\tlet sessionLoad = 0;\n\t\t\t\tif (w.tss != null) {\n\t\t\t\t\tsessionLoad = w.tss;\n\t\t\t\t} else if (w.duration_s != null && w.avg_hr != null) {\n\t\t\t\t\tsessionLoad = (w.duration_s / 60) * (w.avg_hr / 150) * 1.5;\n\t\t\t\t} else if (w.duration_s != null) {\n\t\t\t\t\t// Fallback using moderate RPE equivalent\n\t\t\t\t\tsessionLoad = (w.duration_s / 60) * 1.0;\n\t\t\t\t}\n\t\t\t\tdailyLoads[dateKey] = (dailyLoads[dateKey] || 0) + sessionLoad;\n\t\t\t});\n\n\t\t\t// Calculate Acute Load (last 7 days) and Chronic Load (last 28 days)\n\t\t\tlet acuteLoad = 0;\n\t\t\tlet chronicLoad = 0;\n\n\t\t\tconst sevenDaysAgo = new Date();\n\t\t\tsevenDaysAgo.setDate(today.getDate() - 7);\n\t\t\tconst sevenDaysStr = sevenDaysAgo.toISOString().split(\"T\")[0];\n\n\t\t\tfor (const [date, load] of Object.entries(dailyLoads)) {\n\t\t\t\tchronicLoad += load;\n\t\t\t\tif (date >= sevenDaysStr) {\n\t\t\t\t\tacuteLoad += load;\n\t\t\t\t}\n\t\t\t}\n\n\t\t\tconst avgAcute = acuteLoad / 7;\n\t\t\tconst avgChronic = chronicLoad / 28;\n\n\t\t\tif (avgChronic === 0) {\n\t\t\t\treturn \"Chronic training load is zero. Cannot calculate ACWR. Athlete is likely undertrained or returning from a long break.\";\n\t\t\t}\n\n\t\t\tconst acwr = avgAcute / avgChronic;\n\n\t\t\tlet riskAssessment = \"\";\n\t\t\tlet recommendations = \"\";\n\n\t\t\tif (acwr < 0.8) {\n\t\t\t\triskAssessment = \"LOW (Undertraining)\";\n\t\t\t\trecommendations =\n\t\t\t\t\t\"Athlete is losing fitness. Safe to increase training volume and intensity.\";\n\t\t\t} else if (acwr >= 0.8 && acwr <= 1.3) {\n\t\t\t\triskAssessment = \"OPTIMAL (Sweet Spot)\";\n\t\t\t\trecommendations =\n\t\t\t\t\t\"Excellent training progression. Injury risk is minimized. Maintain current progressive overload.\";\n\t\t\t} else if (acwr > 1.3 && acwr <= 1.5) {\n\t\t\t\triskAssessment = \"CAUTION (Zone of Danger)\";\n\t\t\t\trecommendations =\n\t\t\t\t\t\"Training load is ramping up quickly. Monitor biometrics closely. Consider a recovery day.\";\n\t\t\t} else {\n\t\t\t\triskAssessment = \"HIGH (Danger Zone)\";\n\t\t\t\trecommendations =\n\t\t\t\t\t\"Acute load is significantly higher than chronic load. Athlete is at HIGH RISK of injury or illness. Immediately reduce volume or intensity.\";\n\t\t\t}\n\n\t\t\tconst report = `**Injury Risk Forecast (ACWR Model)**\n            \n- **Acute Load (7-day avg):** ${Math.round(avgAcute)} / day\n- **Chronic Load (28-day avg):** ${Math.round(avgChronic)} / day\n- **Acute:Chronic Workload Ratio (ACWR):** ${acwr.toFixed(2)}\n\n**Risk Assessment:** ${riskAssessment}\n**Recommendation:** ${recommendations}\n\n*Coaching Instruction:* Explain this ratio simply to the athlete. If they are in the danger zone, proactively suggest modifying their upcoming workouts to be lighter.`;\n\n\t\t\treturn report;\n\t\t},\n\t\t{\n\t\t\tname: \"predict_injury_risk\",\n\t\t\tdescription:\n\t\t\t\t\"Forecasts the athlete's injury risk by calculating the Acute:Chronic Workload Ratio (ACWR) over the last 28 days. Use this when the athlete asks if they are overtraining, or if you want to verify a training plan is safe.\",\n\t\t\tschema: z.object({}), // No required parameters\n\t\t},\n\t);\n}\n", "// ============================================================\n// Tool: Save Memory (Long-term Context)\n// Saves a fact, preference, or goal to the athlete's memory\n// ============================================================\n\nimport { tool } from \"@langchain/core/tools\";\nimport { AzureOpenAIEmbeddings } from \"@langchain/openai\";\nimport type { SupabaseClient } from \"@supabase/supabase-js\";\nimport { z } from \"zod\";\nimport { AI_CONFIG } from \"../../../config/ai.js\";\nimport { createLogger } from \"../../../lib/logger.js\";\nimport { insertMemory } from \"../supabase.js\";\n\nconst log = createLogger({ module: \"tool-save-memory\" });\n\nexport function createSaveMemoryTool(client: SupabaseClient, userId: string) {\n\treturn tool(\n\t\tasync ({ category, content, importance = 3 }) => {\n\t\t\ttry {\n\t\t\t\t// Generate embedding for natural language search scaling later\n\t\t\t\tlet embedding: number[] | undefined;\n\t\t\t\ttry {\n\t\t\t\t\tconst embeddingsModel = new AzureOpenAIEmbeddings({\n\t\t\t\t\t\tazureOpenAIApiKey: AI_CONFIG.azure.apiKey,\n\t\t\t\t\t\tazureOpenAIApiInstanceName: AI_CONFIG.azure.endpoint\n\t\t\t\t\t\t\t.split(\".\")[0]\n\t\t\t\t\t\t\t.replace(\"https://\", \"\"),\n\t\t\t\t\t\tazureOpenAIApiDeploymentName: AI_CONFIG.azure.embeddingsDeployment,\n\t\t\t\t\t\tazureOpenAIApiVersion: AI_CONFIG.azure.apiVersion,\n\t\t\t\t\t});\n\t\t\t\t\tembedding = await embeddingsModel.embedQuery(content);\n\t\t\t\t} catch (err) {\n\t\t\t\t\tlog.error({ err }, \"Failed to generate embedding for athlete memory\");\n\t\t\t\t}\n\n\t\t\t\tconst memory = await insertMemory(client, {\n\t\t\t\t\tathlete_id: userId,\n\t\t\t\t\tcategory,\n\t\t\t\t\tcontent,\n\t\t\t\t\timportance,\n\t\t\t\t\tembedding,\n\t\t\t\t});\n\n\t\t\t\treturn `Memory saved successfully (ID: ${memory.id}). The agent will now remember this fact in future conversations.`;\n\t\t\t} catch (error) {\n\t\t\t\tconst msg = error instanceof Error ? error.message : \"Unknown error\";\n\t\t\t\treturn `Error saving memory: ${msg}. Please try again.`;\n\t\t\t}\n\t\t},\n\t\t{\n\t\t\tname: \"save_memory\",\n\t\t\tdescription:\n\t\t\t\t'Saves a long-term memory about the athlete. Use this proactively when the athlete mentions a preference, a continuous goal, a constraint (e.g., \"I hate mornings\", \"I am training for an Ironman\", \"My knee always hurts on long runs\").',\n\t\t\tschema: z.object({\n\t\t\t\tcategory: z\n\t\t\t\t\t.enum([\"preference\", \"goal\", \"constraint\", \"pattern\", \"medical_note\", \"other\"])\n\t\t\t\t\t.describe(\"The category of the memory\"),\n\t\t\t\tcontent: z\n\t\t\t\t\t.string()\n\t\t\t\t\t.describe('The standalone fact to remember (e.g. \"Athlete prefers evening workouts\")'),\n\t\t\t\timportance: z\n\t\t\t\t\t.number()\n\t\t\t\t\t.min(1)\n\t\t\t\t\t.max(5)\n\t\t\t\t\t.optional()\n\t\t\t\t\t.describe(\"Importance of the memory from 1 (trivial) to 5 (critical)\"),\n\t\t\t}),\n\t\t},\n\t);\n}\n", "/**\n * schedule-workout \u2014 AI tool for scheduling a single workout session.\n *\n * Handles quick requests like \"add a run tomorrow\" or\n * \"schedule a 45-min strength session on Friday\".\n */\n\nimport { tool } from \"@langchain/core/tools\";\nimport type { SupabaseClient } from \"@supabase/supabase-js\";\nimport { z } from \"zod\";\nimport { createLogger } from \"../../../lib/logger.js\";\n\nconst log = createLogger({ module: \"tool-schedule-workout\" });\n\nconst scheduleWorkoutSchema = z.object({\n\tplannedDate: z.string().describe(\"ISO date (YYYY-MM-DD) for the workout\"),\n\tplannedTime: z.string().optional().describe(\"Optional start time (HH:MM)\"),\n\tactivityType: z\n\t\t.enum([\"SWIM\", \"BIKE\", \"RUN\", \"STRENGTH\", \"YOGA\", \"OTHER\"])\n\t\t.describe(\"Type of workout\"),\n\ttitle: z.string().describe('Short title, e.g. \"Easy Zone 2 Run\"'),\n\tdescription: z.string().optional().describe(\"Detailed session instructions\"),\n\tdurationMin: z.number().int().min(5).optional().describe(\"Duration in minutes\"),\n\tdistanceKm: z.number().optional().describe(\"Target distance in km\"),\n\tintensity: z\n\t\t.enum([\"RECOVERY\", \"EASY\", \"MODERATE\", \"HARD\", \"MAX\"])\n\t\t.optional()\n\t\t.describe(\"Target intensity level\"),\n\ttargetRpe: z.number().int().min(1).max(10).optional().describe(\"Target RPE (1-10)\"),\n\tnotes: z.string().optional().describe(\"Any additional notes\"),\n});\n\nexport function createScheduleWorkoutTool(client: SupabaseClient, userId: string, clubId: string) {\n\treturn tool(\n\t\tasync (input) => {\n\t\t\ttry {\n\t\t\t\t// Optionally link to active training plan\n\t\t\t\tconst { data: activePlan } = await client\n\t\t\t\t\t.from(\"training_plans\")\n\t\t\t\t\t.select(\"id\")\n\t\t\t\t\t.eq(\"athlete_id\", userId)\n\t\t\t\t\t.eq(\"status\", \"active\")\n\t\t\t\t\t.order(\"created_at\", { ascending: false })\n\t\t\t\t\t.limit(1)\n\t\t\t\t\t.maybeSingle();\n\n\t\t\t\tlog.debug({ activePlanId: activePlan?.id ?? null, userId, clubId }, \"Scheduling workout\");\n\n\t\t\t\tconst { data, error } = await client\n\t\t\t\t\t.from(\"planned_workouts\")\n\t\t\t\t\t.insert({\n\t\t\t\t\t\tathlete_id: userId,\n\t\t\t\t\t\tclub_id: clubId,\n\t\t\t\t\t\tplan_id: activePlan?.id || null,\n\t\t\t\t\t\tplanned_date: input.plannedDate,\n\t\t\t\t\t\tplanned_time: input.plannedTime || null,\n\t\t\t\t\t\tactivity_type: input.activityType,\n\t\t\t\t\t\ttitle: input.title,\n\t\t\t\t\t\tdescription: input.description || null,\n\t\t\t\t\t\tduration_min: input.durationMin || null,\n\t\t\t\t\t\tdistance_km: input.distanceKm || null,\n\t\t\t\t\t\tintensity: input.intensity || null,\n\t\t\t\t\t\ttarget_rpe: input.targetRpe || null,\n\t\t\t\t\t\tnotes: input.notes || null,\n\t\t\t\t\t\tstatus: \"planned\",\n\t\t\t\t\t\tsource: \"AI\",\n\t\t\t\t\t})\n\t\t\t\t\t.select()\n\t\t\t\t\t.single();\n\n\t\t\t\tlog.debug({ workoutId: data?.id, error }, \"Insert result\");\n\t\t\t\tif (error) throw new Error(error.message);\n\n\t\t\t\tconst emoji = {\n\t\t\t\t\tSWIM: \"\uD83C\uDFCA\",\n\t\t\t\t\tBIKE: \"\uD83D\uDEB4\",\n\t\t\t\t\tRUN: \"\uD83C\uDFC3\",\n\t\t\t\t\tSTRENGTH: \"\uD83C\uDFCB\uFE0F\",\n\t\t\t\t\tYOGA: \"\uD83E\uDDD8\",\n\t\t\t\t\tOTHER: \"\u26A1\",\n\t\t\t\t}[input.activityType];\n\n\t\t\t\treturn `${emoji} Scheduled \"${input.title}\" on ${input.plannedDate}${input.plannedTime ? ` at ${input.plannedTime}` : \"\"}${input.durationMin ? ` (${input.durationMin} min)` : \"\"}${input.intensity ? ` \u2014 ${input.intensity}` : \"\"}. Check your training calendar!`;\n\t\t\t} catch (error) {\n\t\t\t\tlog.error({ err: error }, \"Failed to schedule workout\");\n\t\t\t\tconst msg = error instanceof Error ? error.message : \"Unknown error\";\n\t\t\t\treturn `\u274C Failed to schedule workout: ${msg}`;\n\t\t\t}\n\t\t},\n\t\t{\n\t\t\tname: \"schedule_workout\",\n\t\t\tdescription:\n\t\t\t\t'Schedules a single workout session on a specific date. Use for quick requests like \"add a run tomorrow\" or \"schedule strength on Friday\". For full multi-week plans, use generate_workout_plan instead.',\n\t\t\tschema: scheduleWorkoutSchema,\n\t\t},\n\t);\n}\n", "// ============================================================\n// Tool: Search Workouts (Semantic Search)\n// Finds past workouts matching natural language descriptions\n// ============================================================\n\nimport { tool } from \"@langchain/core/tools\";\nimport { AzureOpenAIEmbeddings } from \"@langchain/openai\";\nimport type { SupabaseClient } from \"@supabase/supabase-js\";\nimport { z } from \"zod\";\nimport { AI_CONFIG } from \"../../../config/ai.js\";\n\nexport function createSearchWorkoutsTool(client: SupabaseClient, userId: string) {\n\treturn tool(\n\t\tasync ({ query, threshold = 0.6, limit = 5 }) => {\n\t\t\ttry {\n\t\t\t\t// Initialize embeddings\n\t\t\t\tconst embeddings = new AzureOpenAIEmbeddings({\n\t\t\t\t\tazureOpenAIApiKey: AI_CONFIG.azure.apiKey,\n\t\t\t\t\tazureOpenAIApiInstanceName: AI_CONFIG.azure.endpoint\n\t\t\t\t\t\t.split(\".\")[0]\n\t\t\t\t\t\t.replace(\"https://\", \"\"),\n\t\t\t\t\tazureOpenAIApiDeploymentName: AI_CONFIG.azure.embeddingsDeployment,\n\t\t\t\t\tazureOpenAIApiVersion: AI_CONFIG.azure.apiVersion,\n\t\t\t\t});\n\n\t\t\t\t// Generate vector for the query\n\t\t\t\tconst query_embedding = await embeddings.embedQuery(query);\n\n\t\t\t\t// Call the Supabase RPC match_workouts\n\t\t\t\tconst { data, error } = await client.rpc(\"match_workouts\", {\n\t\t\t\t\tp_athlete_id: userId,\n\t\t\t\t\tquery_embedding,\n\t\t\t\t\tmatch_threshold: threshold,\n\t\t\t\t\tmatch_count: limit,\n\t\t\t\t});\n\n\t\t\t\tif (error) {\n\t\t\t\t\treturn `Error searching workouts: ${error.message}`;\n\t\t\t\t}\n\n\t\t\t\tif (!data || data.length === 0) {\n\t\t\t\t\treturn \"No matching workouts found for that query.\";\n\t\t\t\t}\n\n\t\t\t\treturn JSON.stringify(\n\t\t\t\t\tdata.map((w: any) => ({\n\t\t\t\t\t\tid: w.id,\n\t\t\t\t\t\tactivityType: w.activity_type,\n\t\t\t\t\t\tdate: w.started_at,\n\t\t\t\t\t\tdistanceMeters: w.distance_m,\n\t\t\t\t\t\tdurationSeconds: w.duration_s,\n\t\t\t\t\t\tnotes: w.notes,\n\t\t\t\t\t\tsimilarity: w.similarity,\n\t\t\t\t\t})),\n\t\t\t\t);\n\t\t\t} catch (error) {\n\t\t\t\tconst msg = error instanceof Error ? error.message : \"Unknown error\";\n\t\t\t\treturn `Error searching workouts: ${msg}. Please try again.`;\n\t\t\t}\n\t\t},\n\t\t{\n\t\t\tname: \"search_workouts\",\n\t\t\tdescription:\n\t\t\t\t'Performs a natural language semantic search over the athlete\\'s past workouts based on their notes. Use this when the user asks vague questions like \"find the run where it was raining\" or \"when did I last do 400m repeats?\".',\n\t\t\tschema: z.object({\n\t\t\t\tquery: z\n\t\t\t\t\t.string()\n\t\t\t\t\t.describe('The natural language search query (e.g. \"rainy run\", \"felt great\")'),\n\t\t\t\tthreshold: z\n\t\t\t\t\t.number()\n\t\t\t\t\t.optional()\n\t\t\t\t\t.describe(\"Minimum similarity threshold (0-1). Default 0.6\"),\n\t\t\t\tlimit: z.number().optional().describe(\"Maximum number of workouts to return. Default 5\"),\n\t\t\t}),\n\t\t},\n\t);\n}\n", "// ============================================================\n// Tool: Traverse Athlete Graph\n// Explores the athlete's knowledge graph (gear, peers, coaches)\n// ============================================================\n\nimport { tool } from \"@langchain/core/tools\";\nimport type { SupabaseClient } from \"@supabase/supabase-js\";\nimport { z } from \"zod\";\n\nexport function createTraverseGraphTool(client: SupabaseClient, userId: string) {\n\treturn tool(\n\t\tasync ({ maxDepth = 2, edgeTypes }) => {\n\t\t\ttry {\n\t\t\t\t// The starting node is the athlete's user profile ID\n\t\t\t\t// Make sure the graph has matching nodes\n\t\t\t\tconst { data, error } = await client.rpc(\"traverse_athlete_graph\", {\n\t\t\t\t\tstart_node_id: userId,\n\t\t\t\t\tmax_depth: maxDepth,\n\t\t\t\t\tedge_types: edgeTypes ?? null,\n\t\t\t\t});\n\n\t\t\t\tif (error) {\n\t\t\t\t\treturn `Error traversing memory graph: ${error.message}`;\n\t\t\t\t}\n\n\t\t\t\tif (!data || data.length === 0) {\n\t\t\t\t\treturn \"No relationships found in the athlete graph.\";\n\t\t\t\t}\n\n\t\t\t\treturn JSON.stringify(\n\t\t\t\t\tdata.map((d: any) => ({\n\t\t\t\t\t\tid: d.node_id,\n\t\t\t\t\t\tlabel: d.node_label,\n\t\t\t\t\t\ttype: d.node_type,\n\t\t\t\t\t\tpath: d.path_names.join(\" -> \"),\n\t\t\t\t\t\tdepth: d.depth,\n\t\t\t\t\t})),\n\t\t\t\t);\n\t\t\t} catch (error) {\n\t\t\t\tconst msg = error instanceof Error ? error.message : \"Unknown error\";\n\t\t\t\treturn `Error traversing memory graph: ${msg}. Please try again.`;\n\t\t\t}\n\t\t},\n\t\t{\n\t\t\tname: \"traverse_athlete_graph\",\n\t\t\tdescription:\n\t\t\t\t\"Traverses the knowledge graph to find relationships for the athlete, such as their coach, teammates, preferred gear (bikes, shoes), and historic achievements.\",\n\t\t\tschema: z.object({\n\t\t\t\tmaxDepth: z.number().optional().describe(\"How many hops to traverse (default 2)\"),\n\t\t\t\tedgeTypes: z\n\t\t\t\t\t.array(z.string())\n\t\t\t\t\t.optional()\n\t\t\t\t\t.describe('Optional array of edge labels to follow (e.g. [\"uses_gear\", \"coached_by\"])'),\n\t\t\t}),\n\t\t},\n\t);\n}\n", "// ============================================================\n// Tool: Update Daily Log\n// Upserts a daily wellness log entry for the athlete\n// ============================================================\n\nimport { tool } from \"@langchain/core/tools\";\nimport type { SupabaseClient } from \"@supabase/supabase-js\";\nimport { z } from \"zod\";\nimport { upsertDailyLog } from \"../supabase.js\";\n\nexport function createUpdateSorenessTool(client: SupabaseClient, userId: string, clubId: string) {\n\treturn tool(\n\t\tasync (input) => {\n\t\t\ttry {\n\t\t\t\tconst { date, rpe, mood, sleepHours, sleepQuality, hrv, restingHr, weightKg, notes } =\n\t\t\t\t\tinput;\n\t\t\t\tconst logDate = date ?? new Date().toISOString().split(\"T\")[0];\n\n\t\t\t\tconst log = await upsertDailyLog(client, {\n\t\t\t\t\tathlete_id: userId,\n\t\t\t\t\tclub_id: clubId,\n\t\t\t\t\tlog_date: logDate,\n\t\t\t\t\trpe: rpe ?? null,\n\t\t\t\t\tmood: mood ?? null,\n\t\t\t\t\tsleep_hours: sleepHours ?? null,\n\t\t\t\t\tsleep_quality: sleepQuality ?? null,\n\t\t\t\t\thrv: hrv ?? null,\n\t\t\t\t\tresting_hr: restingHr ?? null,\n\t\t\t\t\tweight_kg: weightKg ?? null,\n\t\t\t\t\tnotes: notes ?? null,\n\t\t\t\t});\n\n\t\t\t\treturn `Daily log updated for ${log.log_date}. Fields set: ${\n\t\t\t\t\tObject.entries({\n\t\t\t\t\t\trpe,\n\t\t\t\t\t\tmood,\n\t\t\t\t\t\tsleepHours,\n\t\t\t\t\t\tsleepQuality,\n\t\t\t\t\t\thrv,\n\t\t\t\t\t\trestingHr,\n\t\t\t\t\t\tweightKg,\n\t\t\t\t\t})\n\t\t\t\t\t\t.filter(([, v]) => v != null)\n\t\t\t\t\t\t.map(([k, v]) => `${k}=${v}`)\n\t\t\t\t\t\t.join(\", \") || \"notes only\"\n\t\t\t\t}`;\n\t\t\t} catch (error) {\n\t\t\t\tconst msg = error instanceof Error ? error.message : \"Unknown error\";\n\t\t\t\treturn `Error updating daily log: ${msg}. Please try again.`;\n\t\t\t}\n\t\t},\n\t\t{\n\t\t\tname: \"update_daily_log\",\n\t\t\tdescription:\n\t\t\t\t\"Updates or creates a daily wellness log entry. Use when the athlete reports sleep, mood, RPE, HRV, weight, or other daily metrics. Always confirm values before calling.\",\n\t\t\tschema: z.object({\n\t\t\t\tdate: z.string().optional().describe(\"Log date (YYYY-MM-DD), defaults to today\"),\n\t\t\t\trpe: z.number().optional().describe(\"Rate of Perceived Exertion (1-10)\"),\n\t\t\t\tmood: z.number().optional().describe(\"Mood rating (1-5)\"),\n\t\t\t\tsleepHours: z.number().optional().describe(\"Hours of sleep\"),\n\t\t\t\tsleepQuality: z.number().optional().describe(\"Sleep quality (1-5)\"),\n\t\t\t\thrv: z.number().optional().describe(\"Heart rate variability\"),\n\t\t\t\trestingHr: z.number().optional().describe(\"Resting heart rate\"),\n\t\t\t\tweightKg: z.number().optional().describe(\"Body weight in kg\"),\n\t\t\t\tnotes: z.string().optional().describe(\"Additional notes\"),\n\t\t\t}),\n\t\t},\n\t);\n}\n", "// ============================================================\n// Tool Barrel Export\n// Creates all tools bound to a specific user context\n// ============================================================\n\nimport type { SupabaseClient } from \"@supabase/supabase-js\";\nimport { createAnalyzeBiometricTrendsTool } from \"./analyze-biometric-trends.js\";\nimport { analyzeForm } from \"./analyze-form.js\";\nimport { createAnalyzeWorkoutsTool } from \"./analyze-workouts.js\";\nimport { createGenerateWorkoutPlanTool } from \"./generate-workout-plan.js\";\nimport { createGetAthleteProfileTool } from \"./get-athlete-profile.js\";\nimport { createGetHealthMetricsTool } from \"./get-health-metrics.js\";\nimport { createGetProgressReportTool } from \"./get-progress-report.js\";\nimport { createGetSquadLeaderboardTool } from \"./get-squad-leaderboard.js\";\nimport { createGetTrainingPlanTool } from \"./get-training-plan.js\";\nimport { createGetWorkoutHistoryTool } from \"./get-workout-history.js\";\nimport { createLogInjuryTool } from \"./log-injury.js\";\nimport { createLogWorkoutTool } from \"./log-workout.js\";\nimport { createMatchDocumentsTool } from \"./match-documents.js\";\nimport { createModifyTrainingPlanTool } from \"./modify-training-plan.js\";\nimport { createPassBatonTool } from \"./pass-baton.js\";\nimport { createPredictInjuryRiskTool } from \"./predict-injury-risk.js\";\nimport { createSaveMemoryTool } from \"./save-memory.js\";\nimport { createScheduleWorkoutTool } from \"./schedule-workout.js\";\nimport { createSearchWorkoutsTool } from \"./search-workouts.js\";\nimport { createTraverseGraphTool } from \"./traverse-graph.js\";\nimport { createUpdateSorenessTool } from \"./update-soreness.js\";\n\n/**\n * Creates all agent tools bound to a specific user's auth context.\n * Each tool wraps the shared service layer, enabling future\n * exposure via REST/MCP for external agents.\n */\nexport function createAllTools(client: SupabaseClient, userId: string, clubId: string) {\n\treturn [\n\t\t// Read tools\n\t\tcreateGetAthleteProfileTool(client, userId),\n\t\tcreateGetWorkoutHistoryTool(client, userId),\n\t\tcreateGetHealthMetricsTool(client, userId),\n\t\tcreateGetTrainingPlanTool(client, userId),\n\t\tcreateGetProgressReportTool(client, userId),\n\t\t// Gamification tools\n\t\tcreateGetSquadLeaderboardTool(client, userId),\n\t\tcreatePassBatonTool(client, userId),\n\t\t// Write tools (require user confirmation via prompt)\n\t\tcreateLogWorkoutTool(client, userId, clubId),\n\t\tcreateUpdateSorenessTool(client, userId, clubId),\n\t\tcreateLogInjuryTool(client, userId),\n\t\tcreateModifyTrainingPlanTool(client, userId),\n\t\t// Training plan & scheduling tools\n\t\tcreateGenerateWorkoutPlanTool(client, userId, clubId),\n\t\tcreateScheduleWorkoutTool(client, userId, clubId),\n\t\t// GraphRAG & Knowledge Graph tools\n\t\tcreateMatchDocumentsTool(client, clubId),\n\t\tcreateTraverseGraphTool(client, userId),\n\t\tcreateSearchWorkoutsTool(client, userId),\n\t\tcreateSaveMemoryTool(client, userId),\n\t\tcreateAnalyzeBiometricTrendsTool(client, userId),\n\t\tcreateAnalyzeWorkoutsTool(client, userId),\n\t\tcreatePredictInjuryRiskTool(client, userId),\n\t\tanalyzeForm,\n\t];\n}\n", "// ============================================================\n// Memory Extractor \u2014 Automatic Background Memory Extraction\n// Analyzes conversation turns and extracts noteworthy facts,\n// preferences, goals, and patterns into athlete_memories.\n// Runs fire-and-forget after each AI response.\n// ============================================================\n\nimport { AzureChatOpenAI, AzureOpenAIEmbeddings } from \"@langchain/openai\";\nimport type { SupabaseClient } from \"@supabase/supabase-js\";\nimport { AI_CONFIG } from \"../../config/ai.js\";\nimport { createLogger } from \"../../lib/logger.js\";\nimport { getRecentMemories, insertMemory } from \"./supabase.js\";\n\nconst log = createLogger({ module: \"memory-extractor\" });\n\n/** Shape of a candidate memory from the extraction LLM */\ninterface CandidateMemory {\n\tcategory: \"preference\" | \"goal\" | \"constraint\" | \"pattern\" | \"medical_note\" | \"other\";\n\tcontent: string;\n\timportance: number;\n}\n\nconst EXTRACTION_PROMPT = `You are a memory extraction system for an AI fitness coach.\nAnalyze the following conversation snippet and extract any NEW facts worth remembering about the athlete.\n\nFocus on:\n- **Preferences**: communication style, workout timing, equipment, exercise likes/dislikes\n- **Goals**: races, PRs, body composition, skill targets\n- **Constraints**: injuries, schedule limitations, equipment access\n- **Patterns**: typical routines, habits, training frequency\n- **Medical notes**: chronic conditions, medications, allergies\n\nRules:\n- Only extract genuinely new, useful facts \u2014 not things already in existing memories\n- Each memory should be a standalone sentence (e.g., \"Athlete prefers evening workouts\")\n- Set importance 1-5: 1=trivial preference, 3=useful context, 5=critical constraint/medical\n- Return an empty array [] if nothing new is worth remembering\n- Maximum 3 extractions per turn \u2014 quality over quantity\n- Do NOT extract transient information (e.g., \"just did a 5k today\" \u2014 that's workout data, not a memory)\n\nRespond ONLY with a JSON array. No markdown, no explanation.`;\n\n/**\n * Extracts memories from a conversation turn and saves them.\n * Designed to run fire-and-forget (no await needed by caller).\n */\nexport async function extractMemories(\n\tclient: SupabaseClient,\n\tuserId: string,\n\tuserMessage: string,\n\tassistantResponse: string,\n): Promise<void> {\n\ttry {\n\t\t// Load existing memories for deduplication context\n\t\tconst existingMemories = await getRecentMemories(client, userId, 20);\n\t\tconst existingContext =\n\t\t\texistingMemories.length > 0\n\t\t\t\t? `\\n\\nExisting memories (DO NOT re-extract these):\\n${existingMemories.map((m) => `- ${m.content}`).join(\"\\n\")}`\n\t\t\t\t: \"\";\n\n\t\t// Use a separate, cheap LLM call for extraction\n\t\tconst llm = new AzureChatOpenAI({\n\t\t\tazureOpenAIEndpoint: AI_CONFIG.azure.endpoint,\n\t\t\tazureOpenAIApiKey: AI_CONFIG.azure.apiKey,\n\t\t\tazureOpenAIApiDeploymentName: AI_CONFIG.azure.deploymentName,\n\t\t\tazureOpenAIApiVersion: AI_CONFIG.azure.apiVersion,\n\t\t\ttemperature: 0, // Deterministic extraction\n\t\t\tmodelKwargs: { max_completion_tokens: 512 },\n\t\t});\n\n\t\tconst response = await llm.invoke([\n\t\t\t{ type: \"system\", content: EXTRACTION_PROMPT + existingContext },\n\t\t\t{\n\t\t\t\ttype: \"human\",\n\t\t\t\tcontent: `User: ${userMessage}\\n\\nAssistant: ${assistantResponse}`,\n\t\t\t},\n\t\t]);\n\n\t\tconst content = typeof response.content === \"string\" ? response.content.trim() : \"\";\n\n\t\tif (!content || content === \"[]\") return;\n\n\t\t// Parse the JSON array\n\t\tlet candidates: CandidateMemory[];\n\t\ttry {\n\t\t\tcandidates = JSON.parse(content);\n\t\t\tif (!Array.isArray(candidates)) return;\n\t\t} catch {\n\t\t\tlog.warn({ content }, \"Memory extractor: failed to parse JSON\");\n\t\t\treturn;\n\t\t}\n\n\t\t// Validate and limit\n\t\tcandidates = candidates\n\t\t\t.filter(\n\t\t\t\t(c) =>\n\t\t\t\t\tc.content &&\n\t\t\t\t\ttypeof c.content === \"string\" &&\n\t\t\t\t\tc.category &&\n\t\t\t\t\ttypeof c.importance === \"number\",\n\t\t\t)\n\t\t\t.slice(0, 3);\n\n\t\tif (candidates.length === 0) return;\n\n\t\t// Deduplicate via embeddings \u2014 skip if too similar to existing memories\n\t\tconst embeddingsModel = new AzureOpenAIEmbeddings({\n\t\t\tazureOpenAIApiKey: AI_CONFIG.azure.apiKey,\n\t\t\tazureOpenAIApiInstanceName: AI_CONFIG.azure.endpoint.split(\".\")[0].replace(\"https://\", \"\"),\n\t\t\tazureOpenAIApiDeploymentName: AI_CONFIG.azure.embeddingsDeployment,\n\t\t\tazureOpenAIApiVersion: AI_CONFIG.azure.apiVersion,\n\t\t});\n\n\t\t// Get embeddings for existing memories that have them\n\t\tconst existingEmbeddings = existingMemories\n\t\t\t.filter((m) => m.embedding && m.embedding.length > 0)\n\t\t\t.map((m) => ({ content: m.content, embedding: m.embedding! }));\n\n\t\tfor (const candidate of candidates) {\n\t\t\ttry {\n\t\t\t\tconst candidateEmbedding = await embeddingsModel.embedQuery(candidate.content);\n\n\t\t\t\t// Check cosine similarity against existing memories\n\t\t\t\tconst isDuplicate = existingEmbeddings.some((existing) => {\n\t\t\t\t\tconst similarity = cosineSimilarity(candidateEmbedding, existing.embedding);\n\t\t\t\t\treturn similarity > 0.88; // High threshold \u2014 only skip near-duplicates\n\t\t\t\t});\n\n\t\t\t\tif (isDuplicate) {\n\t\t\t\t\tcontinue;\n\t\t\t\t}\n\n\t\t\t\t// Save the new memory\n\t\t\t\tawait insertMemory(client, {\n\t\t\t\t\tathlete_id: userId,\n\t\t\t\t\tcategory: candidate.category,\n\t\t\t\t\tcontent: candidate.content,\n\t\t\t\t\timportance: Math.min(5, Math.max(1, Math.round(candidate.importance))),\n\t\t\t\t\tembedding: candidateEmbedding,\n\t\t\t\t});\n\n\t\t\t\tlog.info({ category: candidate.category, content: candidate.content }, \"Memory extracted\");\n\t\t\t} catch (err) {\n\t\t\t\tlog.warn({ err }, \"Memory extractor: failed to process candidate\");\n\t\t\t}\n\t\t}\n\t} catch (err) {\n\t\t// Never throw \u2014 this is fire-and-forget\n\t\tlog.error({ err }, \"Memory extractor error\");\n\t}\n}\n\n/** Cosine similarity between two vectors */\nfunction cosineSimilarity(a: number[], b: number[]): number {\n\tif (a.length !== b.length) return 0;\n\tlet dotProduct = 0;\n\tlet normA = 0;\n\tlet normB = 0;\n\tfor (let i = 0; i < a.length; i++) {\n\t\tdotProduct += a[i] * b[i];\n\t\tnormA += a[i] * a[i];\n\t\tnormB += b[i] * b[i];\n\t}\n\tconst denominator = Math.sqrt(normA) * Math.sqrt(normB);\n\treturn denominator === 0 ? 0 : dotProduct / denominator;\n}\n", "/**\n * AI Safety Guard \u2014 Multi-layer safety checks for the AI Coach\n *\n * Implements:\n * 1. Emergency/crisis detection \u2192 helpline info + hard stop\n * 2. Medical disclaimer injection\n * 3. Input length validation\n * 4. PII pattern redaction in output\n * 5. Confidence gating\n *\n * @see LangGraph v1.1+ content moderation middleware for deeper integration\n */\n\n// \u2500\u2500 Constants \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\n\nconst MAX_INPUT_LENGTH = 4000;\n\nconst EMERGENCY_KEYWORDS = [\n\t\"suicide\",\n\t\"suicidal\",\n\t\"kill myself\",\n\t\"end my life\",\n\t\"want to die\",\n\t\"self-harm\",\n\t\"self harm\",\n\t\"cutting myself\",\n\t\"hurt myself\",\n\t\"overdose\",\n\t\"no reason to live\",\n\t\"better off dead\",\n] as const;\n\nconst MEDICAL_TRIGGER_KEYWORDS = [\n\t\"diagnosis\",\n\t\"diagnose\",\n\t\"prescription\",\n\t\"medication\",\n\t\"medicine\",\n\t\"treatment\",\n\t\"disease\",\n\t\"disorder\",\n\t\"symptom\",\n\t\"injury\",\n\t\"nutrition\",\n\t\"supplement\",\n\t\"diet\",\n\t\"calorie\",\n\t\"macro\",\n\t\"pain\",\n\t\"chronic\",\n\t\"acute\",\n\t\"condition\",\n\t\"surgery\",\n\t\"heart rate\",\n\t\"blood pressure\",\n\t\"spo2\",\n\t\"vo2max\",\n] as const;\n\nconst EMERGENCY_RESPONSE = `\uD83D\uDEA8 **I'm concerned about your wellbeing.**\n\nIf you're experiencing a crisis or having thoughts of self-harm, please reach out to professionals who can help:\n\n\uD83C\uDDF8\uD83C\uDDEA **Sweden**: Mind Sj\u00E4lvmordslinjen \u2014 **90101** (call or text)\n\uD83C\uDDEA\uD83C\uDDFA **EU**: 112 (emergency)\n\uD83C\uDF0D **International**: Crisis Text Line \u2014 text **HELLO** to **741741**\n\uD83C\uDF0D **International**: Befrienders Worldwide \u2014 [befrienders.org](https://www.befrienders.org)\n\nYou are not alone, and there are people who care about you. \uD83D\uDC99\n\n*I'm an AI coaching assistant and cannot provide crisis support. Please contact a professional or someone you trust.*`;\n\nconst MEDICAL_DISCLAIMER = `\\n\\n---\\n\u2695\uFE0F *This is AI-generated guidance for informational purposes only. It is not medical advice. Always consult a qualified healthcare professional before making health decisions.*`;\n\nconst LOW_CONFIDENCE_DISCLAIMER = `\\n\\n---\\n\u26A0\uFE0F *I have limited data to support this recommendation. Please verify with your coach or healthcare provider.*`;\n\n// \u2500\u2500 Interfaces \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\n\nexport interface SafetyCheckResult {\n\tpassed: boolean;\n\tblocked: boolean;\n\treason?: string;\n\tresponse?: string;\n}\n\nexport interface SafetyProcessedOutput {\n\tcontent: string;\n\tdisclaimerAdded: boolean;\n\tlowConfidence: boolean;\n}\n\n// \u2500\u2500 Input Safety Check \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\n\n/**\n * Checks user input before sending to the AI model.\n * Returns a block response if emergency content is detected.\n */\nexport function checkInput(message: string): SafetyCheckResult {\n\t// Length validation\n\tif (message.length > MAX_INPUT_LENGTH) {\n\t\treturn {\n\t\t\tpassed: false,\n\t\t\tblocked: true,\n\t\t\treason: \"input_too_long\",\n\t\t\tresponse: `Your message is too long (${message.length} characters). Please keep messages under ${MAX_INPUT_LENGTH} characters.`,\n\t\t};\n\t}\n\n\tif (message.trim().length === 0) {\n\t\treturn {\n\t\t\tpassed: false,\n\t\t\tblocked: true,\n\t\t\treason: \"empty_input\",\n\t\t\tresponse: \"Please enter a message.\",\n\t\t};\n\t}\n\n\t// Emergency keyword detection\n\tconst lowered = message.toLowerCase();\n\tconst isEmergency = EMERGENCY_KEYWORDS.some((kw) => lowered.includes(kw));\n\n\tif (isEmergency) {\n\t\treturn {\n\t\t\tpassed: false,\n\t\t\tblocked: true,\n\t\t\treason: \"emergency_detected\",\n\t\t\tresponse: EMERGENCY_RESPONSE,\n\t\t};\n\t}\n\n\treturn { passed: true, blocked: false };\n}\n\n// \u2500\u2500 Output Safety Processing \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\n\n/**\n * Processes AI model output before sending to the user.\n * Adds disclaimers and redacts PII.\n */\nexport function processOutput(\n\tcontent: string,\n\toptions: {\n\t\tconfidence?: number;\n\t\thasMedicalContent?: boolean;\n\t} = {},\n): SafetyProcessedOutput {\n\tlet processed = content;\n\tlet disclaimerAdded = false;\n\n\t// Detect medical content in output\n\tconst outputLower = processed.toLowerCase();\n\tconst hasMedical =\n\t\toptions.hasMedicalContent ?? MEDICAL_TRIGGER_KEYWORDS.some((kw) => outputLower.includes(kw));\n\n\tif (hasMedical) {\n\t\tprocessed += MEDICAL_DISCLAIMER;\n\t\tdisclaimerAdded = true;\n\t}\n\n\t// Low confidence warning\n\tconst lowConfidence = (options.confidence ?? 1.0) < 0.6;\n\tif (lowConfidence) {\n\t\tprocessed += LOW_CONFIDENCE_DISCLAIMER;\n\t\tdisclaimerAdded = true;\n\t}\n\n\treturn {\n\t\tcontent: processed,\n\t\tdisclaimerAdded,\n\t\tlowConfidence,\n\t};\n}\n\n// \u2500\u2500 Content Classification \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\n\n/**\n * Classifies user input intent for routing and safety decisions.\n */\nexport function classifyIntent(message: string): \"training\" | \"medical\" | \"emergency\" | \"general\" {\n\tconst lower = message.toLowerCase();\n\n\tif (EMERGENCY_KEYWORDS.some((kw) => lower.includes(kw))) {\n\t\treturn \"emergency\";\n\t}\n\n\tif (MEDICAL_TRIGGER_KEYWORDS.some((kw) => lower.includes(kw))) {\n\t\treturn \"medical\";\n\t}\n\n\tconst trainingKeywords = [\n\t\t\"training\",\n\t\t\"workout\",\n\t\t\"swim\",\n\t\t\"bike\",\n\t\t\"run\",\n\t\t\"pace\",\n\t\t\"interval\",\n\t\t\"tempo\",\n\t\t\"threshold\",\n\t\t\"taper\",\n\t\t\"race\",\n\t\t\"plan\",\n\t\t\"tss\",\n\t\t\"ftp\",\n\t\t\"zone\",\n\t\t\"recovery\",\n\t\t\"rest day\",\n\t];\n\n\tif (trainingKeywords.some((kw) => lower.includes(kw))) {\n\t\treturn \"training\";\n\t}\n\n\treturn \"general\";\n}\n", "// ============================================================\n// AI SDK Streaming Endpoint \u2014 LangGraph \u2192 AI SDK bridge\n// Uses @ai-sdk/langchain adapter for standard UI message streaming\n// ============================================================\n\nimport { toUIMessageStream } from \"@ai-sdk/langchain\";\nimport { HumanMessage } from \"@langchain/core/messages\";\nimport { ChatMessageInput } from \"@triathlon/types\";\nimport { createUIMessageStreamResponse, type UIMessage } from \"ai\";\nimport { Hono } from \"hono\";\nimport { AI_CONFIG, validateAIConfig } from \"../../config/ai.js\";\nimport { createLogger } from \"../../lib/logger.js\";\nimport { getAuth } from \"../../middleware/auth.js\";\nimport {\n\tgetOrCreateConversation,\n\tloadHistory,\n\tsaveMessages,\n\tupdateConversationTitle,\n} from \"../../services/ai/conversation.js\";\nimport { createAgent, toBaseMessages } from \"../../services/ai/graph.js\";\nimport { extractMemories } from \"../../services/ai/memory-extractor.js\";\nimport { checkInput, classifyIntent, processOutput } from \"../../services/ai/safety.js\";\nimport { createUserClient } from \"../../services/ai/supabase.js\";\n\nconst log = createLogger({ module: \"ai-stream\" });\n\nexport const aiStreamRoutes = new Hono();\n\n// \u2500\u2500 AI Coach streaming endpoint (AI SDK protocol) \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\naiStreamRoutes.post(\"/stream\", async (c) => {\n\tconst body = await c.req.json();\n\n\t// Extract last user message from AI SDK UIMessage format\n\tconst uiMessages: UIMessage[] = body.messages ?? [];\n\tconst lastUserMsg = uiMessages.filter((m) => m.role === \"user\").pop();\n\n\tconst messageText =\n\t\tlastUserMsg?.parts\n\t\t\t?.filter((p: { type: string }): p is { type: \"text\"; text: string } => p.type === \"text\")\n\t\t\t.map((p) => p.text)\n\t\t\t.join(\"\\n\") || \"\";\n\n\tconst reqConversationId: string | undefined = body.conversationId;\n\n\t// Extract image URLs from file parts (AI SDK uses FileUIPart with type: 'file')\n\tconst imageUrls: string[] =\n\t\tlastUserMsg?.parts\n\t\t\t?.filter(\n\t\t\t\t(p: { type: string }): p is { type: \"file\"; mediaType: string; url: string } =>\n\t\t\t\t\tp.type === \"file\" &&\n\t\t\t\t\t\"mediaType\" in p &&\n\t\t\t\t\t(p as { mediaType: string }).mediaType.startsWith(\"image/\"),\n\t\t\t)\n\t\t\t.map((p) => p.url) ?? [];\n\n\t// \u2500\u2500 Input validation \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\n\tconst parsed = ChatMessageInput.safeParse({\n\t\tmessage: messageText,\n\t\tconversationId: reqConversationId,\n\t\t...(imageUrls.length > 0 && { imageUrls }),\n\t});\n\n\tif (!parsed.success) {\n\t\treturn c.json(\n\t\t\t{\n\t\t\t\terror: \"Validation failed\",\n\t\t\t\tissues: parsed.error.issues.map((i) => ({\n\t\t\t\t\tpath: i.path.join(\".\"),\n\t\t\t\t\tmessage: i.message,\n\t\t\t\t})),\n\t\t\t},\n\t\t\t400,\n\t\t);\n\t}\n\n\tconst { message, conversationId } = parsed.data;\n\n\t// \u2500\u2500 Safety check \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\n\tconst safetyCheck = checkInput(message);\n\tif (safetyCheck.blocked) {\n\t\treturn c.json({\n\t\t\trole: \"assistant\",\n\t\t\tcontent: safetyCheck.response,\n\t\t\tconversationId: conversationId || crypto.randomUUID(),\n\t\t\tmetadata: { model: \"safety-guard\", blocked: true, reason: safetyCheck.reason },\n\t\t});\n\t}\n\n\t// \u2500\u2500 Validate AI config \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\n\tconst configCheck = validateAIConfig();\n\tif (!configCheck.valid) {\n\t\treturn c.json({\n\t\t\trole: \"assistant\",\n\t\t\tcontent: \"AI Coach is not yet configured. Please set up the required environment variables.\",\n\t\t\tmetadata: { model: \"none\", error: \"missing_config\", missing: configCheck.missing },\n\t\t});\n\t}\n\n\t// \u2500\u2500 Auth & Supabase client \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\n\tconst auth = getAuth(c);\n\tconst jwt = c.req.header(\"Authorization\")?.replace(\"Bearer \", \"\") || \"\";\n\tconst client = createUserClient(jwt);\n\n\t// \u2500\u2500 Conversation persistence \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\n\tconst conversation = await getOrCreateConversation(\n\t\tclient,\n\t\tauth.userId,\n\t\tauth.clubId,\n\t\tconversationId,\n\t);\n\tconst history = await loadHistory(client, conversation.id, AI_CONFIG.model.historyLimit);\n\n\t// Save user message and conditionally update title concurrently\n\tconst userMsgMetadata = imageUrls.length > 0 ? { imageUrls } : undefined;\n\tawait Promise.all([\n\t\tsaveMessages(client, conversation.id, [\n\t\t\t{ role: \"user\", content: message, metadata: userMsgMetadata },\n\t\t]),\n\t\thistory.length === 0\n\t\t\t? updateConversationTitle(client, conversation.id, message)\n\t\t\t: Promise.resolve(),\n\t]);\n\n\t// \u2500\u2500 Intent classification \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\n\tconst intent = classifyIntent(message);\n\n\t// \u2500\u2500 Create agent and prepare messages \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\n\tconst agent = await createAgent(client, auth.userId, auth.clubId, message);\n\tconst historyMessages = toBaseMessages(history);\n\n\t// Build multimodal user content if images attached\n\tconst userContent =\n\t\timageUrls.length > 0\n\t\t\t? [\n\t\t\t\t\t{ type: \"text\" as const, text: message },\n\t\t\t\t\t...imageUrls.map((url) => ({\n\t\t\t\t\t\ttype: \"image_url\" as const,\n\t\t\t\t\t\timage_url: { url },\n\t\t\t\t\t})),\n\t\t\t\t]\n\t\t\t: message;\n\n\tconst inputMessages = [...historyMessages, new HumanMessage({ content: userContent })];\n\n\t// \u2500\u2500 Stream with AI SDK adapter \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\n\tconst graphStream = await agent.stream(\n\t\t{ messages: inputMessages },\n\t\t{ streamMode: [\"values\", \"messages\"] as const },\n\t);\n\n\treturn createUIMessageStreamResponse({\n\t\tstream: toUIMessageStream(graphStream, {\n\t\t\tonFinal: async (completion) => {\n\t\t\t\t// Post-processing: save the assistant response and extract memories\n\t\t\t\tif (!completion) return;\n\t\t\t\ttry {\n\t\t\t\t\tconst processed = processOutput(completion, {\n\t\t\t\t\t\tconfidence: 0.85,\n\t\t\t\t\t\thasMedicalContent: intent === \"medical\",\n\t\t\t\t\t});\n\n\t\t\t\t\tawait saveMessages(client, conversation.id, [\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\trole: \"assistant\",\n\t\t\t\t\t\t\tcontent: processed.content,\n\t\t\t\t\t\t\tmetadata: {\n\t\t\t\t\t\t\t\tmodel: AI_CONFIG.azure.deploymentName,\n\t\t\t\t\t\t\t\tintent,\n\t\t\t\t\t\t\t\tdisclaimerAdded: processed.disclaimerAdded,\n\t\t\t\t\t\t\t},\n\t\t\t\t\t\t},\n\t\t\t\t\t]);\n\n\t\t\t\t\textractMemories(client, auth.userId, message, processed.content).catch((err) =>\n\t\t\t\t\t\tlog.warn({ err }, \"Background memory extraction failed\"),\n\t\t\t\t\t);\n\t\t\t\t} catch (err) {\n\t\t\t\t\tlog.error({ err }, \"Post-stream processing failed\");\n\t\t\t\t}\n\t\t\t},\n\t\t}),\n\t\theaders: {\n\t\t\t\"X-Accel-Buffering\": \"no\",\n\t\t\t\"Cache-Control\": \"no-cache, no-transform\",\n\t\t\t\"X-Conversation-Id\": conversation.id,\n\t\t},\n\t});\n});\n", "// ============================================================\n// Integration Routes \u2014 Hono Sub-App\n// Mounts per-provider OAuth routes under /api/integrations/*.\n// Also provides:\n//   GET /api/integrations/status \u2014 all connected accounts\n//   GET /api/integrations/sync-history \u2014 recent sync operations\n// ============================================================\n\nimport { Hono } from \"hono\";\nimport { getAuth } from \"../../middleware/auth.js\";\nimport { createAdminClient } from \"../../services/ai/supabase.js\";\nimport { getAllProviderNames } from \"../../services/integrations/registry.js\";\nimport { getConnectedAccounts } from \"../../services/integrations/token-manager.js\";\nimport { garminRoutes } from \"./garmin.js\";\nimport { polarRoutes } from \"./polar.js\";\nimport { stravaRoutes } from \"./strava.js\";\nimport { wahooRoutes } from \"./wahoo.js\";\n\nexport const integrationRoutes = new Hono();\n\n// \u2500\u2500 Per-provider routes \u2500\u2500\nintegrationRoutes.route(\"/strava\", stravaRoutes);\nintegrationRoutes.route(\"/garmin\", garminRoutes);\nintegrationRoutes.route(\"/polar\", polarRoutes);\nintegrationRoutes.route(\"/wahoo\", wahooRoutes);\n\n// \u2500\u2500 Status endpoint (for Settings page) \u2500\u2500\nintegrationRoutes.get(\"/status\", async (c) => {\n\tconst auth = getAuth(c);\n\tconst client = createAdminClient();\n\tconst connected = await getConnectedAccounts(auth.userId, client);\n\n\tconst allProviders = getAllProviderNames();\n\tconst status = allProviders.map((name) => {\n\t\tconst conn = connected.find((item) => item.provider === name);\n\t\treturn {\n\t\t\tprovider: name,\n\t\t\tconnected: !!conn,\n\t\t\tlastSyncAt: conn?.lastSyncAt || null,\n\t\t\tproviderUid: conn?.providerUid || null,\n\t\t};\n\t});\n\n\t// Get pending queue size from DB\n\tconst { count } = await client\n\t\t.from(\"webhook_queue\")\n\t\t.select(\"*\", { count: \"exact\", head: true })\n\t\t.in(\"status\", [\"pending\", \"processing\"]);\n\n\treturn c.json({\n\t\tintegrations: status,\n\t\twebhookQueueSize: count ?? 0,\n\t});\n});\n\n// \u2500\u2500 Sync history endpoint \u2500\u2500\nintegrationRoutes.get(\"/sync-history\", async (c) => {\n\tconst auth = getAuth(c);\n\tconst limit = parseInt(c.req.query(\"limit\") || \"20\", 10);\n\tconst provider = c.req.query(\"provider\");\n\n\tconst client = createAdminClient();\n\tlet query = client\n\t\t.from(\"sync_history\")\n\t\t.select(\"*\")\n\t\t.eq(\"athlete_id\", auth.userId)\n\t\t.order(\"created_at\", { ascending: false })\n\t\t.limit(Math.min(limit, 100));\n\n\tif (provider) {\n\t\tquery = query.eq(\"provider\", provider);\n\t}\n\n\tconst { data, error } = await query;\n\n\tif (error) {\n\t\treturn c.json({ error: \"Failed to fetch sync history\" }, 500);\n\t}\n\n\treturn c.json({ history: data || [] });\n});\n", "// ============================================================\n// Integration Configuration\n// Centralised env-var access for all fitness platform providers.\n// Add new providers here as the integration library expands.\n// ============================================================\n\nfunction env(key: string, fallback = \"\"): string {\n\treturn process.env[key] || fallback;\n}\n\nexport const INTEGRATION_CONFIG = {\n\t/** Base URL for this API (used to build OAuth callback URLs) */\n\tapiBaseUrl: env(\"API_URL\", \"http://localhost:8787\"),\n\n\t/** Base URL for the web frontend (used for OAuth redirects) */\n\twebUrl: env(\"WEB_URL\", \"http://localhost:3000\"),\n\n\t/** Minimum interval between manual sync requests per athlete (ms) */\n\tsyncCooldownMs: 5 * 60 * 1000,\n\n\tSTRAVA: {\n\t\tclientId: env(\"STRAVA_CLIENT_ID\"),\n\t\tclientSecret: env(\"STRAVA_CLIENT_SECRET\"),\n\t\tverifyToken: env(\"STRAVA_VERIFY_TOKEN\"),\n\t},\n\n\tGARMIN: {\n\t\tconsumerKey: env(\"GARMIN_CONSUMER_KEY\"),\n\t\tconsumerSecret: env(\"GARMIN_CONSUMER_SECRET\"),\n\t},\n\n\tPOLAR: {\n\t\tclientId: env(\"POLAR_CLIENT_ID\"),\n\t\tclientSecret: env(\"POLAR_CLIENT_SECRET\"),\n\t\twebhookSecret: env(\"POLAR_WEBHOOK_SECRET\"),\n\t},\n\n\tWAHOO: {\n\t\tclientId: env(\"WAHOO_CLIENT_ID\"),\n\t\tclientSecret: env(\"WAHOO_CLIENT_SECRET\"),\n\t\twebhookToken: env(\"WAHOO_WEBHOOK_TOKEN\"),\n\t},\n} as const;\n", "// ============================================================\n// Integration Errors \u2014 Structured Error Types\n// Typed errors for better debugging, logging, and handling.\n// ============================================================\n\n/** Base error for all integration operations */\nexport class IntegrationError extends Error {\n\tconstructor(\n\t\tpublic readonly provider: string,\n\t\tmessage: string,\n\t\tpublic readonly cause?: Error,\n\t) {\n\t\tsuper(`[${provider}] ${message}`);\n\t\tthis.name = \"IntegrationError\";\n\t}\n}\n\n/** Token has expired and refresh failed */\nexport class TokenExpiredError extends IntegrationError {\n\tconstructor(provider: string, cause?: Error) {\n\t\tsuper(provider, \"Access token expired and could not be refreshed\", cause);\n\t\tthis.name = \"TokenExpiredError\";\n\t}\n}\n\n/** Provider API returned 429 Too Many Requests */\nexport class RateLimitedError extends IntegrationError {\n\tconstructor(\n\t\tprovider: string,\n\t\tpublic readonly retryAfterMs: number,\n\t) {\n\t\tsuper(provider, `Rate limited \u2014 retry after ${Math.ceil(retryAfterMs / 1000)}s`);\n\t\tthis.name = \"RateLimitedError\";\n\t}\n}\n\n/** Webhook signature verification failed */\nexport class WebhookVerificationError extends IntegrationError {\n\tconstructor(provider: string) {\n\t\tsuper(provider, \"Webhook signature verification failed\");\n\t\tthis.name = \"WebhookVerificationError\";\n\t}\n}\n\n/** Provider API returned an error response */\nexport class ProviderApiError extends IntegrationError {\n\tconstructor(\n\t\tprovider: string,\n\t\tpublic readonly statusCode: number,\n\t\tmessage: string,\n\t) {\n\t\tsuper(provider, `API error ${statusCode}: ${message}`);\n\t\tthis.name = \"ProviderApiError\";\n\t}\n}\n\n/** OAuth state parameter is invalid or expired */\nexport class OAuthStateError extends IntegrationError {\n\tconstructor(provider: string) {\n\t\tsuper(provider, \"Invalid or expired OAuth state \u2014 possible CSRF attack\");\n\t\tthis.name = \"OAuthStateError\";\n\t}\n}\n\n/** Provider is not yet available (e.g. Garmin pending approval) */\nexport class ProviderUnavailableError extends IntegrationError {\n\tconstructor(provider: string, reason: string) {\n\t\tsuper(provider, `Provider unavailable: ${reason}`);\n\t\tthis.name = \"ProviderUnavailableError\";\n\t}\n}\n", "// ============================================================\n// HTTP Client \u2014 Retry with Exponential Backoff\n// Generic fetch wrapper for all provider API calls.\n// Retries on transient errors, respects Retry-After headers.\n// ============================================================\n\nimport { createLogger } from \"../../lib/logger.js\";\n\nconst log = createLogger({ module: \"http-client\" });\n\nexport interface RetryConfig {\n\t/** Max number of retries (default: 3) */\n\tmaxRetries?: number;\n\t/** Base delay in ms (default: 1000) \u2014 doubles on each retry */\n\tbaseDelayMs?: number;\n\t/** Timeout per request in ms (default: 15000) */\n\ttimeoutMs?: number;\n}\n\nconst DEFAULT_CONFIG: Required<RetryConfig> = {\n\tmaxRetries: 3,\n\tbaseDelayMs: 1000,\n\ttimeoutMs: 15000,\n};\n\n/** HTTP status codes that warrant a retry */\nconst RETRYABLE_STATUS = new Set([429, 500, 502, 503, 504]);\n\n/** Status codes that should NOT be retried */\nconst NON_RETRYABLE_STATUS = new Set([400, 401, 403, 404, 409, 422]);\n\n/**\n * Fetch with automatic retry and exponential backoff.\n * Retries on network errors and 5xx/429 responses.\n * Respects Retry-After header from the server.\n */\nexport async function fetchWithRetry(\n\turl: string,\n\toptions: RequestInit = {},\n\tconfig: RetryConfig = {},\n): Promise<Response> {\n\tconst { maxRetries, baseDelayMs, timeoutMs } = {\n\t\t...DEFAULT_CONFIG,\n\t\t...config,\n\t};\n\n\tlet lastError: Error | null = null;\n\n\tfor (let attempt = 0; attempt <= maxRetries; attempt++) {\n\t\ttry {\n\t\t\t// Add timeout via AbortController\n\t\t\tconst controller = new AbortController();\n\t\t\tconst timeout = setTimeout(() => controller.abort(), timeoutMs);\n\n\t\t\tconst res = await fetch(url, {\n\t\t\t\t...options,\n\t\t\t\tsignal: controller.signal,\n\t\t\t});\n\n\t\t\tclearTimeout(timeout);\n\n\t\t\t// Success \u2014 return immediately\n\t\t\tif (res.ok) return res;\n\n\t\t\t// Non-retryable status \u2014 fail fast\n\t\t\tif (NON_RETRYABLE_STATUS.has(res.status)) return res;\n\n\t\t\t// Retryable status \u2014 wait and retry\n\t\t\tif (RETRYABLE_STATUS.has(res.status) && attempt < maxRetries) {\n\t\t\t\tconst delay = getDelay(res, attempt, baseDelayMs);\n\t\t\t\tlog.warn(\n\t\t\t\t\t{ status: res.status, url, attempt: attempt + 1, maxRetries, delayMs: delay },\n\t\t\t\t\t\"Retryable HTTP status\",\n\t\t\t\t);\n\t\t\t\tawait sleep(delay);\n\t\t\t\tcontinue;\n\t\t\t}\n\n\t\t\t// Max retries exhausted \u2014 return the last response\n\t\t\treturn res;\n\t\t} catch (err) {\n\t\t\tlastError = err instanceof Error ? err : new Error(String(err));\n\n\t\t\t// AbortError = timeout\n\t\t\tif (attempt < maxRetries) {\n\t\t\t\tconst delay = baseDelayMs * 2 ** attempt;\n\t\t\t\tlog.warn(\n\t\t\t\t\t{ url, error: lastError.message, attempt: attempt + 1, maxRetries, delayMs: delay },\n\t\t\t\t\t\"HTTP fetch error, retrying\",\n\t\t\t\t);\n\t\t\t\tawait sleep(delay);\n\t\t\t}\n\t\t}\n\t}\n\n\tthrow lastError || new Error(`Failed to fetch ${url} after ${maxRetries} retries`);\n}\n\n/**\n * Calculate delay, respecting Retry-After header.\n */\nfunction getDelay(response: Response, attempt: number, baseDelayMs: number): number {\n\tconst retryAfter = response.headers.get(\"Retry-After\");\n\n\tif (retryAfter) {\n\t\t// Retry-After can be seconds or HTTP-date\n\t\tconst seconds = parseInt(retryAfter, 10);\n\t\tif (!Number.isNaN(seconds)) {\n\t\t\treturn seconds * 1000;\n\t\t}\n\t\t// Try HTTP-date\n\t\tconst date = new Date(retryAfter).getTime();\n\t\tif (!Number.isNaN(date)) {\n\t\t\treturn Math.max(0, date - Date.now());\n\t\t}\n\t}\n\n\t// Exponential backoff with jitter\n\tconst exponential = baseDelayMs * 2 ** attempt;\n\tconst jitter = Math.random() * baseDelayMs * 0.5;\n\treturn exponential + jitter;\n}\n\nfunction sleep(ms: number): Promise<void> {\n\treturn new Promise((resolve) => setTimeout(resolve, ms));\n}\n", "// ============================================================\n// Garmin Provider\n// Implements IntegrationProvider for Garmin Health API.\n// Note: Garmin uses OAuth 1.0a and requires business approval.\n// Docs: https://developer.garmin.com/gc-developer-program/\n// ============================================================\n\nimport { INTEGRATION_CONFIG } from \"../../../config/integrations.js\";\nimport { createLogger } from \"../../../lib/logger.js\";\nimport { ProviderApiError, ProviderUnavailableError } from \"../errors.js\";\nimport { fetchWithRetry } from \"../http.js\";\nimport type {\n\tActivityType,\n\tIntegrationProvider,\n\tNormalizedMetric,\n\tNormalizedWorkout,\n\tOAuthConfig,\n\tOAuthTokens,\n} from \"../types.js\";\n\nconst log = createLogger({ module: \"garmin-provider\" });\n\nexport class GarminProvider implements IntegrationProvider {\n\treadonly name = \"GARMIN\" as const;\n\n\treadonly oauthConfig: OAuthConfig = {\n\t\t// Garmin uses OAuth 1.0a \u2014 these URLs are placeholders\n\t\t// until business API access is approved\n\t\tauthorizeUrl: \"https://connect.garmin.com/oauthConfirm\",\n\t\ttokenUrl: \"https://connectapi.garmin.com/oauth-service/oauth/access_token\",\n\t\trevokeUrl: undefined,\n\t\tclientId: INTEGRATION_CONFIG.GARMIN.consumerKey,\n\t\tclientSecret: INTEGRATION_CONFIG.GARMIN.consumerSecret,\n\t\tscopes: [],\n\t\tcallbackPath: \"/api/integrations/garmin/callback\",\n\t\toauthVersion: \"1.0a\",\n\t};\n\n\t// \u2500\u2500 Activity type mapping \u2500\u2500\n\tprivate static readonly ACTIVITY_MAP: Record<string, ActivityType> = {\n\t\trunning: \"RUN\",\n\t\ttrail_running: \"RUN\",\n\t\ttreadmill_running: \"RUN\",\n\t\tcycling: \"BIKE\",\n\t\tmountain_biking: \"BIKE\",\n\t\tindoor_cycling: \"BIKE\",\n\t\tvirtual_ride: \"BIKE\",\n\t\tlap_swimming: \"SWIM\",\n\t\topen_water_swimming: \"SWIM\",\n\t\tstrength_training: \"STRENGTH\",\n\t\tyoga: \"YOGA\",\n\t\tmulti_sport: \"OTHER\", // Triathlon \u2014 could be split\n\t};\n\n\t// \u2500\u2500 OAuth (stub \u2014 requires OAuth 1.0a implementation) \u2500\u2500\n\n\tbuildAuthUrl(_state: string): string {\n\t\t// TODO: Implement OAuth 1.0a request token flow\n\t\t// Garmin requires: request token \u2192 user authorize \u2192 access token\n\t\tlog.warn(\"OAuth 1.0a not yet implemented \u2014 requires business API approval\");\n\t\tconst params = new URLSearchParams({\n\t\t\toauth_callback: `${INTEGRATION_CONFIG.apiBaseUrl}${this.oauthConfig.callbackPath}`,\n\t\t});\n\t\treturn `${this.oauthConfig.authorizeUrl}?${params}`;\n\t}\n\n\tasync exchangeCode(_code: string): Promise<OAuthTokens> {\n\t\t// TODO: Implement OAuth 1.0a token exchange (uses oauth_verifier, not code)\n\t\tthrow new ProviderUnavailableError(\n\t\t\t\"GARMIN\",\n\t\t\t\"OAuth 1.0a token exchange not yet implemented \u2014 awaiting API approval\",\n\t\t);\n\t}\n\n\tasync refreshToken(_refreshToken: string): Promise<OAuthTokens> {\n\t\t// Garmin OAuth 1.0a tokens don't expire \u2014 no refresh needed\n\t\tthrow new Error(\"[Garmin] OAuth 1.0a tokens do not expire\");\n\t}\n\n\tasync revokeAccess(_accessToken: string): Promise<void> {\n\t\t// TODO: Call Garmin deregistration endpoint\n\t\tlog.warn(\"Access revocation not yet implemented\");\n\t}\n\n\t// \u2500\u2500 Webhooks \u2500\u2500\n\n\tverifyWebhook(_headers: Record<string, string>, _body: string): boolean {\n\t\t// Garmin webhook signature verification requires business API approval.\n\t\t// Once granted, verify using consumer secret + OAuth 1.0a signature.\n\t\tlog.warn(\"Garmin webhook signature verification not yet implemented \u2014 accepting all\");\n\t\treturn true;\n\t}\n\n\textractOwnerIdFromWebhook(event: Record<string, unknown>): string {\n\t\t// Garmin uses userAccessToken or userId in webhook payloads\n\t\treturn String(event.userId || event.userAccessToken || \"\");\n\t}\n\n\textractActivityIdFromWebhook(event: Record<string, unknown>): string {\n\t\treturn String(event.activityId || event.summaryId || \"\");\n\t}\n\n\t// \u2500\u2500 Data Fetching \u2500\u2500\n\n\tasync fetchActivity(accessToken: string, activityId: string): Promise<NormalizedWorkout> {\n\t\t// Garmin pushes data via webhooks \u2014 this fetches on demand\n\t\tconst res = await fetchWithRetry(\n\t\t\t`https://apis.garmin.com/wellness-api/rest/activities/${activityId}`,\n\t\t\t{\n\t\t\t\theaders: { Authorization: `Bearer ${accessToken}` },\n\t\t\t},\n\t\t);\n\n\t\tif (!res.ok) {\n\t\t\tthrow new ProviderApiError(\"GARMIN\", res.status, `fetchActivity failed`);\n\t\t}\n\n\t\tconst a = (await res.json()) as Record<string, unknown>;\n\t\treturn this.normalizeActivity(a);\n\t}\n\n\tasync fetchActivities(\n\t\taccessToken: string,\n\t\tsince: Date,\n\t\tlimit = 50,\n\t): Promise<NormalizedWorkout[]> {\n\t\tconst params = new URLSearchParams({\n\t\t\tuploadStartTimeInSeconds: String(Math.floor(since.getTime() / 1000)),\n\t\t\tuploadEndTimeInSeconds: String(Math.floor(Date.now() / 1000)),\n\t\t});\n\n\t\tconst res = await fetchWithRetry(\n\t\t\t`https://apis.garmin.com/wellness-api/rest/activities?${params}`,\n\t\t\t{\n\t\t\t\theaders: { Authorization: `Bearer ${accessToken}` },\n\t\t\t},\n\t\t);\n\n\t\tif (!res.ok) {\n\t\t\tthrow new ProviderApiError(\"GARMIN\", res.status, \"fetchActivities failed\");\n\t\t}\n\n\t\tconst activities = (await res.json()) as Record<string, unknown>[];\n\t\treturn activities.slice(0, limit).map((a) => this.normalizeActivity(a));\n\t}\n\n\tasync fetchHealthData(accessToken: string, date: Date): Promise<NormalizedMetric[]> {\n\t\tconst dateStr = date.toISOString().split(\"T\")[0];\n\t\tconst metrics: NormalizedMetric[] = [];\n\n\t\ttry {\n\t\t\t// Fetch daily summary\n\t\t\tconst res = await fetchWithRetry(\n\t\t\t\t`https://apis.garmin.com/wellness-api/rest/dailies?calendarDate=${dateStr}`,\n\t\t\t\t{ headers: { Authorization: `Bearer ${accessToken}` } },\n\t\t\t);\n\n\t\t\tif (res.ok) {\n\t\t\t\tconst summaries = (await res.json()) as Record<string, unknown>[];\n\t\t\t\tfor (const s of summaries) {\n\t\t\t\t\tif (s.restingHeartRateInBeatsPerMinute) {\n\t\t\t\t\t\tmetrics.push({\n\t\t\t\t\t\t\tmetricType: \"RESTING_HR\",\n\t\t\t\t\t\t\tvalue: Number(s.restingHeartRateInBeatsPerMinute),\n\t\t\t\t\t\t\tunit: \"bpm\",\n\t\t\t\t\t\t\trecordedAt: new Date(dateStr),\n\t\t\t\t\t\t\tsource: \"GARMIN\",\n\t\t\t\t\t\t\trawData: s,\n\t\t\t\t\t\t});\n\t\t\t\t\t}\n\t\t\t\t\tif (s.steps) {\n\t\t\t\t\t\tmetrics.push({\n\t\t\t\t\t\t\tmetricType: \"STEPS\",\n\t\t\t\t\t\t\tvalue: Number(s.steps),\n\t\t\t\t\t\t\tunit: \"count\",\n\t\t\t\t\t\t\trecordedAt: new Date(dateStr),\n\t\t\t\t\t\t\tsource: \"GARMIN\",\n\t\t\t\t\t\t\trawData: s,\n\t\t\t\t\t\t});\n\t\t\t\t\t}\n\t\t\t\t\tif (s.activeKilocalories) {\n\t\t\t\t\t\tmetrics.push({\n\t\t\t\t\t\t\tmetricType: \"ACTIVE_CALORIES\",\n\t\t\t\t\t\t\tvalue: Number(s.activeKilocalories),\n\t\t\t\t\t\t\tunit: \"kcal\",\n\t\t\t\t\t\t\trecordedAt: new Date(dateStr),\n\t\t\t\t\t\t\tsource: \"GARMIN\",\n\t\t\t\t\t\t\trawData: s,\n\t\t\t\t\t\t});\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t} catch (err) {\n\t\t\tlog.error({ err }, \"fetchHealthData error\");\n\t\t}\n\n\t\treturn metrics;\n\t}\n\n\t// \u2500\u2500 Mapping \u2500\u2500\n\n\tmapActivityType(garminType: string): ActivityType {\n\t\treturn GarminProvider.ACTIVITY_MAP[garminType.toLowerCase()] || \"OTHER\";\n\t}\n\n\tprivate normalizeActivity(a: Record<string, unknown>): NormalizedWorkout {\n\t\tconst activityType = String(a.activityType || a.sportType || \"other\");\n\t\tconst durationS = Number(a.durationInSeconds || a.elapsedDurationInSeconds || 0);\n\t\tconst distanceM = Number(a.distanceInMeters || 0);\n\n\t\treturn {\n\t\t\tactivityType: this.mapActivityType(activityType),\n\t\t\tsource: \"GARMIN\",\n\t\t\tstartedAt: new Date(Number(a.startTimeInSeconds || 0) * 1000),\n\t\t\tdurationS: durationS || null,\n\t\t\tdistanceM: distanceM || null,\n\t\t\tavgHr: (a.averageHeartRateInBeatsPerMinute as number) || null,\n\t\t\tmaxHr: (a.maxHeartRateInBeatsPerMinute as number) || null,\n\t\t\tavgPaceSKm: distanceM > 0 ? Math.round(durationS / (distanceM / 1000)) : null,\n\t\t\tavgPowerW: (a.averagePowerInWatts as number) || null,\n\t\t\tcalories: (a.activeKilocalories as number) || null,\n\t\t\ttss: null, // Garmin uses Training Effect, not TSS\n\t\t\trawData: a,\n\t\t\tnotes: null,\n\t\t};\n\t}\n}\n", "// ============================================================\n// Polar Provider\n// Implements IntegrationProvider for Polar AccessLink API.\n// Docs: https://www.polar.com/accesslink-api/\n// Note: Polar uses a transactional model \u2014 webhook notifies\n// data is ready, then you pull + commit.\n// ============================================================\n\nimport { createHmac, timingSafeEqual } from \"node:crypto\";\nimport { INTEGRATION_CONFIG } from \"../../../config/integrations.js\";\nimport { createLogger } from \"../../../lib/logger.js\";\nimport { ProviderApiError } from \"../errors.js\";\nimport { fetchWithRetry } from \"../http.js\";\nimport type {\n\tActivityType,\n\tIntegrationProvider,\n\tNormalizedMetric,\n\tNormalizedWorkout,\n\tOAuthConfig,\n\tOAuthTokens,\n} from \"../types.js\";\n\nconst log = createLogger({ module: \"polar-provider\" });\n\nconst POLAR_API = \"https://www.polaraccesslink.com/v3\";\n\nexport class PolarProvider implements IntegrationProvider {\n\treadonly name = \"POLAR\" as const;\n\n\treadonly oauthConfig: OAuthConfig = {\n\t\tauthorizeUrl: \"https://flow.polar.com/oauth2/authorization\",\n\t\ttokenUrl: \"https://polarremote.com/v2/oauth2/token\",\n\t\trevokeUrl: undefined,\n\t\tclientId: INTEGRATION_CONFIG.POLAR.clientId,\n\t\tclientSecret: INTEGRATION_CONFIG.POLAR.clientSecret,\n\t\tscopes: [\"accesslink.read_all\"],\n\t\tcallbackPath: \"/api/integrations/polar/callback\",\n\t\toauthVersion: \"2.0\",\n\t};\n\n\tprivate static readonly ACTIVITY_MAP: Record<string, ActivityType> = {\n\t\tRUNNING: \"RUN\",\n\t\tJOGGING: \"RUN\",\n\t\tROAD_RUNNING: \"RUN\",\n\t\tTRAIL_RUNNING: \"RUN\",\n\t\tTREADMILL_RUNNING: \"RUN\",\n\t\tCYCLING: \"BIKE\",\n\t\tROAD_BIKING: \"BIKE\",\n\t\tMOUNTAIN_BIKING: \"BIKE\",\n\t\tINDOOR_CYCLING: \"BIKE\",\n\t\tSWIMMING: \"SWIM\",\n\t\tPOOL_SWIMMING: \"SWIM\",\n\t\tOPEN_WATER_SWIMMING: \"SWIM\",\n\t\tSTRENGTH_TRAINING: \"STRENGTH\",\n\t\tYOGA: \"YOGA\",\n\t\tTRIATHLON: \"OTHER\", // Multi-sport\n\t};\n\n\t// \u2500\u2500 OAuth \u2500\u2500\n\n\tbuildAuthUrl(state: string): string {\n\t\tconst params = new URLSearchParams({\n\t\t\tclient_id: this.oauthConfig.clientId,\n\t\t\tresponse_type: \"code\",\n\t\t\tredirect_uri: `${INTEGRATION_CONFIG.apiBaseUrl}${this.oauthConfig.callbackPath}`,\n\t\t\tscope: this.oauthConfig.scopes.join(\" \"),\n\t\t\tstate,\n\t\t});\n\t\treturn `${this.oauthConfig.authorizeUrl}?${params}`;\n\t}\n\n\tasync exchangeCode(code: string): Promise<OAuthTokens> {\n\t\tconst credentials = Buffer.from(\n\t\t\t`${this.oauthConfig.clientId}:${this.oauthConfig.clientSecret}`,\n\t\t).toString(\"base64\");\n\n\t\tconst res = await fetchWithRetry(this.oauthConfig.tokenUrl, {\n\t\t\tmethod: \"POST\",\n\t\t\theaders: {\n\t\t\t\t\"Content-Type\": \"application/x-www-form-urlencoded\",\n\t\t\t\tAuthorization: `Basic ${credentials}`,\n\t\t\t\tAccept: \"application/json\",\n\t\t\t},\n\t\t\tbody: new URLSearchParams({\n\t\t\t\tgrant_type: \"authorization_code\",\n\t\t\t\tcode,\n\t\t\t\tredirect_uri: `${INTEGRATION_CONFIG.apiBaseUrl}${this.oauthConfig.callbackPath}`,\n\t\t\t}),\n\t\t});\n\n\t\tif (!res.ok) {\n\t\t\tthrow new ProviderApiError(\"POLAR\", res.status, \"Code exchange failed\");\n\t\t}\n\n\t\tconst data = (await res.json()) as {\n\t\t\taccess_token: string;\n\t\t\ttoken_type: string;\n\t\t\tx_user_id: number;\n\t\t};\n\n\t\t// Polar tokens don't expire (no refresh token)\n\t\treturn {\n\t\t\taccessToken: data.access_token,\n\t\t\trefreshToken: \"\", // Polar doesn't use refresh tokens\n\t\t\texpiresAt: new Date(Date.now() + 365 * 24 * 60 * 60 * 1000), // Far future\n\t\t\tproviderUserId: String(data.x_user_id),\n\t\t\tscopes: this.oauthConfig.scopes,\n\t\t};\n\t}\n\n\tasync refreshToken(_refreshToken: string): Promise<OAuthTokens> {\n\t\t// Polar tokens don't expire\n\t\tthrow new Error(\"[Polar] Tokens do not expire \u2014 no refresh needed\");\n\t}\n\n\tasync revokeAccess(accessToken: string): Promise<void> {\n\t\t// Delete user registration from AccessLink\n\t\tawait fetch(`${POLAR_API}/users/current`, {\n\t\t\tmethod: \"DELETE\",\n\t\t\theaders: { Authorization: `Bearer ${accessToken}` },\n\t\t});\n\t}\n\n\t// \u2500\u2500 Webhooks \u2500\u2500\n\n\tverifyWebhook(headers: Record<string, string>, body: string): boolean {\n\t\tconst secret = INTEGRATION_CONFIG.POLAR.webhookSecret;\n\t\tif (!secret) {\n\t\t\tlog.warn(\"POLAR_WEBHOOK_SECRET not configured \u2014 skipping signature verification\");\n\t\t\treturn true;\n\t\t}\n\n\t\tconst signature = headers[\"polar-webhook-signature\"] || headers[\"Polar-Webhook-Signature\"];\n\t\tif (!signature) {\n\t\t\tlog.warn(\"Missing Polar-Webhook-Signature header\");\n\t\t\treturn false;\n\t\t}\n\n\t\tconst expected = createHmac(\"sha256\", secret).update(body).digest(\"hex\");\n\t\ttry {\n\t\t\treturn timingSafeEqual(Buffer.from(signature, \"utf8\"), Buffer.from(expected, \"utf8\"));\n\t\t} catch {\n\t\t\treturn false;\n\t\t}\n\t}\n\n\textractOwnerIdFromWebhook(event: Record<string, unknown>): string {\n\t\treturn String(event.user_id || \"\");\n\t}\n\n\textractActivityIdFromWebhook(event: Record<string, unknown>): string {\n\t\treturn String(event.entity_id || event.exercise_id || \"\");\n\t}\n\n\t// \u2500\u2500 Data Fetching \u2500\u2500\n\n\tasync fetchActivity(accessToken: string, activityId: string): Promise<NormalizedWorkout> {\n\t\tconst res = await fetchWithRetry(`${POLAR_API}/exercises/${activityId}`, {\n\t\t\theaders: {\n\t\t\t\tAuthorization: `Bearer ${accessToken}`,\n\t\t\t\tAccept: \"application/json\",\n\t\t\t},\n\t\t});\n\n\t\tif (!res.ok) {\n\t\t\tthrow new ProviderApiError(\"POLAR\", res.status, \"fetchActivity failed\");\n\t\t}\n\n\t\tconst a = (await res.json()) as Record<string, unknown>;\n\t\treturn this.normalizeActivity(a);\n\t}\n\n\tasync fetchActivities(\n\t\taccessToken: string,\n\t\t_since: Date,\n\t\tlimit = 50,\n\t): Promise<NormalizedWorkout[]> {\n\t\t// Polar uses transactional pull \u2014 create transaction, list, commit\n\t\tconst txRes = await fetchWithRetry(`${POLAR_API}/exercises`, {\n\t\t\theaders: {\n\t\t\t\tAuthorization: `Bearer ${accessToken}`,\n\t\t\t\tAccept: \"application/json\",\n\t\t\t},\n\t\t});\n\n\t\tif (!txRes.ok) return [];\n\n\t\tconst exercises = (await txRes.json()) as Record<string, unknown>[];\n\t\treturn exercises.slice(0, limit).map((a) => this.normalizeActivity(a));\n\t}\n\n\tasync fetchHealthData(accessToken: string, _date: Date): Promise<NormalizedMetric[]> {\n\t\tconst metrics: NormalizedMetric[] = [];\n\n\t\ttry {\n\t\t\t// Fetch sleep data (Nightly Recharge)\n\t\t\tconst sleepRes = await fetchWithRetry(`${POLAR_API}/users/sleep`, {\n\t\t\t\theaders: {\n\t\t\t\t\tAuthorization: `Bearer ${accessToken}`,\n\t\t\t\t\tAccept: \"application/json\",\n\t\t\t\t},\n\t\t\t});\n\n\t\t\tif (sleepRes.ok) {\n\t\t\t\tconst sleepData = (await sleepRes.json()) as Record<string, unknown>;\n\t\t\t\tif (sleepData.sleep_duration) {\n\t\t\t\t\tmetrics.push({\n\t\t\t\t\t\tmetricType: \"SLEEP_HOURS\",\n\t\t\t\t\t\tvalue: Number(sleepData.sleep_duration) / 3600, // seconds \u2192 hours\n\t\t\t\t\t\tunit: \"hours\",\n\t\t\t\t\t\trecordedAt: new Date(),\n\t\t\t\t\t\tsource: \"POLAR\",\n\t\t\t\t\t\trawData: sleepData,\n\t\t\t\t\t});\n\t\t\t\t}\n\t\t\t}\n\t\t} catch (err) {\n\t\t\tlog.error({ err }, \"fetchHealthData error\");\n\t\t}\n\n\t\treturn metrics;\n\t}\n\n\t// \u2500\u2500 Mapping \u2500\u2500\n\n\tmapActivityType(polarType: string): ActivityType {\n\t\treturn PolarProvider.ACTIVITY_MAP[polarType.toUpperCase()] || \"OTHER\";\n\t}\n\n\tprivate normalizeActivity(a: Record<string, unknown>): NormalizedWorkout {\n\t\tconst sport = String(a.sport || a.detailed_sport_info || \"OTHER\");\n\t\tconst durationStr = String(a.duration || \"PT0S\");\n\t\tconst durationS = this.parseDuration(durationStr);\n\t\tconst distanceM = Number(a.distance || 0);\n\n\t\treturn {\n\t\t\tactivityType: this.mapActivityType(sport),\n\t\t\tsource: \"POLAR\",\n\t\t\tstartedAt: new Date(String(a.start_time || new Date().toISOString())),\n\t\t\tdurationS: durationS || null,\n\t\t\tdistanceM: distanceM || null,\n\t\t\tavgHr: (a.heart_rate as { average?: number })?.average || null,\n\t\t\tmaxHr: (a.heart_rate as { maximum?: number })?.maximum || null,\n\t\t\tavgPaceSKm: distanceM > 0 ? Math.round(durationS / (distanceM / 1000)) : null,\n\t\t\tavgPowerW: null, // Available in detailed data\n\t\t\tcalories: (a.calories as number) || null,\n\t\t\ttss: (a.training_load as number) || null,\n\t\t\trawData: a,\n\t\t\tnotes: null,\n\t\t};\n\t}\n\n\t/** Parse ISO 8601 duration (PT1H30M45S) to seconds */\n\tprivate parseDuration(iso: string): number {\n\t\tconst match = iso.match(/PT(?:(\\d+)H)?(?:(\\d+)M)?(?:(\\d+(?:\\.\\d+)?)S)?/);\n\t\tif (!match) return 0;\n\t\tconst h = parseInt(match[1] || \"0\", 10);\n\t\tconst m = parseInt(match[2] || \"0\", 10);\n\t\tconst s = parseFloat(match[3] || \"0\");\n\t\treturn h * 3600 + m * 60 + Math.round(s);\n\t}\n}\n", "// ============================================================\n// Strava Provider\n// Implements IntegrationProvider for Strava API v3.\n// Docs: https://developers.strava.com/docs/reference/\n// ============================================================\n\nimport { INTEGRATION_CONFIG } from \"../../../config/integrations.js\";\nimport { ProviderApiError } from \"../errors.js\";\nimport { fetchWithRetry } from \"../http.js\";\nimport type {\n\tActivityType,\n\tIntegrationProvider,\n\tNormalizedWorkout,\n\tOAuthConfig,\n\tOAuthTokens,\n} from \"../types.js\";\n\nconst STRAVA_API = \"https://www.strava.com/api/v3\";\n\nexport class StravaProvider implements IntegrationProvider {\n\treadonly name = \"STRAVA\" as const;\n\n\treadonly oauthConfig: OAuthConfig = {\n\t\tauthorizeUrl: \"https://www.strava.com/oauth/authorize\",\n\t\ttokenUrl: \"https://www.strava.com/oauth/token\",\n\t\trevokeUrl: \"https://www.strava.com/oauth/deauthorize\",\n\t\tclientId: INTEGRATION_CONFIG.STRAVA.clientId,\n\t\tclientSecret: INTEGRATION_CONFIG.STRAVA.clientSecret,\n\t\tscopes: [\"read\", \"activity:read_all\"],\n\t\tcallbackPath: \"/api/integrations/strava/callback\",\n\t\toauthVersion: \"2.0\",\n\t};\n\n\t// \u2500\u2500 Activity type mapping \u2500\u2500\n\tprivate static readonly ACTIVITY_MAP: Record<string, ActivityType> = {\n\t\tRun: \"RUN\",\n\t\tVirtualRun: \"RUN\",\n\t\tTrailRun: \"RUN\",\n\t\tRide: \"BIKE\",\n\t\tVirtualRide: \"BIKE\",\n\t\tGravelRide: \"BIKE\",\n\t\tMountainBikeRide: \"BIKE\",\n\t\tEBikeRide: \"BIKE\",\n\t\tSwim: \"SWIM\",\n\t\tWeightTraining: \"STRENGTH\",\n\t\tYoga: \"YOGA\",\n\t};\n\n\t// \u2500\u2500 OAuth \u2500\u2500\n\n\tbuildAuthUrl(state: string): string {\n\t\tconst params = new URLSearchParams({\n\t\t\tclient_id: this.oauthConfig.clientId,\n\t\t\tresponse_type: \"code\",\n\t\t\tredirect_uri: `${INTEGRATION_CONFIG.apiBaseUrl}${this.oauthConfig.callbackPath}`,\n\t\t\tapproval_prompt: \"auto\",\n\t\t\tscope: this.oauthConfig.scopes.join(\",\"),\n\t\t\tstate,\n\t\t});\n\t\treturn `${this.oauthConfig.authorizeUrl}?${params}`;\n\t}\n\n\tasync exchangeCode(code: string): Promise<OAuthTokens> {\n\t\tconst res = await fetchWithRetry(this.oauthConfig.tokenUrl, {\n\t\t\tmethod: \"POST\",\n\t\t\theaders: { \"Content-Type\": \"application/json\" },\n\t\t\tbody: JSON.stringify({\n\t\t\t\tclient_id: this.oauthConfig.clientId,\n\t\t\t\tclient_secret: this.oauthConfig.clientSecret,\n\t\t\t\tcode,\n\t\t\t\tgrant_type: \"authorization_code\",\n\t\t\t}),\n\t\t});\n\n\t\tif (!res.ok) {\n\t\t\tconst err = await res.text();\n\t\t\tthrow new ProviderApiError(\"STRAVA\", res.status, `Code exchange failed: ${err}`);\n\t\t}\n\n\t\tconst data = (await res.json()) as {\n\t\t\taccess_token: string;\n\t\t\trefresh_token: string;\n\t\t\texpires_at: number;\n\t\t\tathlete: { id: number };\n\t\t};\n\n\t\treturn {\n\t\t\taccessToken: data.access_token,\n\t\t\trefreshToken: data.refresh_token,\n\t\t\texpiresAt: new Date(data.expires_at * 1000),\n\t\t\tproviderUserId: String(data.athlete.id),\n\t\t\tscopes: this.oauthConfig.scopes,\n\t\t};\n\t}\n\n\tasync refreshToken(refreshToken: string): Promise<OAuthTokens> {\n\t\tconst res = await fetchWithRetry(this.oauthConfig.tokenUrl, {\n\t\t\tmethod: \"POST\",\n\t\t\theaders: { \"Content-Type\": \"application/json\" },\n\t\t\tbody: JSON.stringify({\n\t\t\t\tclient_id: this.oauthConfig.clientId,\n\t\t\t\tclient_secret: this.oauthConfig.clientSecret,\n\t\t\t\trefresh_token: refreshToken,\n\t\t\t\tgrant_type: \"refresh_token\",\n\t\t\t}),\n\t\t});\n\n\t\tif (!res.ok) {\n\t\t\tthrow new ProviderApiError(\"STRAVA\", res.status, \"Token refresh failed\");\n\t\t}\n\n\t\tconst data = (await res.json()) as {\n\t\t\taccess_token: string;\n\t\t\trefresh_token: string;\n\t\t\texpires_at: number;\n\t\t};\n\n\t\treturn {\n\t\t\taccessToken: data.access_token,\n\t\t\trefreshToken: data.refresh_token,\n\t\t\texpiresAt: new Date(data.expires_at * 1000),\n\t\t\tproviderUserId: \"\", // Not returned on refresh\n\t\t\tscopes: this.oauthConfig.scopes,\n\t\t};\n\t}\n\n\tasync revokeAccess(accessToken: string): Promise<void> {\n\t\tawait fetch(this.oauthConfig.revokeUrl!, {\n\t\t\tmethod: \"POST\",\n\t\t\theaders: {\n\t\t\t\tAuthorization: `Bearer ${accessToken}`,\n\t\t\t},\n\t\t});\n\t}\n\n\t// \u2500\u2500 Webhooks \u2500\u2500\n\n\tverifyWebhook(_headers: Record<string, string>, body: string): boolean {\n\t\t// Strava verifies webhooks via subscription validation (GET challenge-response).\n\t\t// Per-event payloads are not signed. We validate the body is well-formed JSON\n\t\t// with expected fields (object_type, aspect_type, owner_id) to reject garbage.\n\t\ttry {\n\t\t\tconst event = JSON.parse(body) as Record<string, unknown>;\n\t\t\treturn (\n\t\t\t\ttypeof event.object_type === \"string\" &&\n\t\t\t\ttypeof event.aspect_type === \"string\" &&\n\t\t\t\tevent.owner_id !== undefined\n\t\t\t);\n\t\t} catch {\n\t\t\treturn false;\n\t\t}\n\t}\n\n\textractOwnerIdFromWebhook(event: Record<string, unknown>): string {\n\t\treturn String(event.owner_id);\n\t}\n\n\textractActivityIdFromWebhook(event: Record<string, unknown>): string {\n\t\treturn String(event.object_id);\n\t}\n\n\t// \u2500\u2500 Data Fetching \u2500\u2500\n\n\tasync fetchActivity(accessToken: string, activityId: string): Promise<NormalizedWorkout> {\n\t\tconst res = await fetchWithRetry(`${STRAVA_API}/activities/${activityId}`, {\n\t\t\theaders: { Authorization: `Bearer ${accessToken}` },\n\t\t});\n\n\t\tif (!res.ok) {\n\t\t\tthrow new ProviderApiError(\"STRAVA\", res.status, `fetchActivity ${activityId} failed`);\n\t\t}\n\n\t\tconst a = (await res.json()) as Record<string, unknown>;\n\t\treturn this.normalizeActivity(a);\n\t}\n\n\tasync fetchActivities(\n\t\taccessToken: string,\n\t\tsince: Date,\n\t\tlimit = 50,\n\t): Promise<NormalizedWorkout[]> {\n\t\tconst after = Math.floor(since.getTime() / 1000);\n\t\tconst params = new URLSearchParams({\n\t\t\tafter: String(after),\n\t\t\tper_page: String(Math.min(limit, 200)),\n\t\t});\n\n\t\tconst res = await fetchWithRetry(`${STRAVA_API}/athlete/activities?${params}`, {\n\t\t\theaders: { Authorization: `Bearer ${accessToken}` },\n\t\t});\n\n\t\tif (!res.ok) {\n\t\t\tthrow new ProviderApiError(\"STRAVA\", res.status, \"fetchActivities failed\");\n\t\t}\n\n\t\tconst activities = (await res.json()) as Record<string, unknown>[];\n\t\treturn activities.map((a) => this.normalizeActivity(a));\n\t}\n\n\t// \u2500\u2500 Mapping \u2500\u2500\n\n\tmapActivityType(stravaType: string): ActivityType {\n\t\treturn StravaProvider.ACTIVITY_MAP[stravaType] || \"OTHER\";\n\t}\n\n\tprivate normalizeActivity(a: Record<string, unknown>): NormalizedWorkout {\n\t\tconst type = String(a.type || \"Other\");\n\t\tconst elapsedTime = Number(a.elapsed_time || 0);\n\t\tconst distance = Number(a.distance || 0);\n\n\t\treturn {\n\t\t\tactivityType: this.mapActivityType(type),\n\t\t\tsource: \"STRAVA\",\n\t\t\tstartedAt: new Date(String(a.start_date)),\n\t\t\tdurationS: elapsedTime || null,\n\t\t\tdistanceM: distance || null,\n\t\t\tavgHr: (a.average_heartrate as number) || null,\n\t\t\tmaxHr: (a.max_heartrate as number) || null,\n\t\t\tavgPaceSKm: distance > 0 ? Math.round(elapsedTime / (distance / 1000)) : null,\n\t\t\tavgPowerW: (a.average_watts as number) || null,\n\t\t\tcalories: (a.calories as number) || null,\n\t\t\ttss: (a.suffer_score as number) || null,\n\t\t\trawData: a,\n\t\t\tnotes: (a.description as string) || null,\n\t\t};\n\t}\n}\n", "// ============================================================\n// Wahoo Provider\n// Implements IntegrationProvider for Wahoo Cloud API.\n// Docs: https://developers.wahooligan.com/\n// ============================================================\n\nimport { timingSafeEqual } from \"node:crypto\";\nimport { INTEGRATION_CONFIG } from \"../../../config/integrations.js\";\nimport { createLogger } from \"../../../lib/logger.js\";\nimport { ProviderApiError } from \"../errors.js\";\nimport { fetchWithRetry } from \"../http.js\";\nimport type {\n\tActivityType,\n\tIntegrationProvider,\n\tNormalizedWorkout,\n\tOAuthConfig,\n\tOAuthTokens,\n} from \"../types.js\";\n\nconst log = createLogger({ module: \"wahoo-provider\" });\nconst WAHOO_API = \"https://api.wahooligan.com/v1\";\n\nexport class WahooProvider implements IntegrationProvider {\n\treadonly name = \"WAHOO\" as const;\n\n\treadonly oauthConfig: OAuthConfig = {\n\t\tauthorizeUrl: \"https://api.wahooligan.com/oauth/authorize\",\n\t\ttokenUrl: \"https://api.wahooligan.com/oauth/token\",\n\t\trevokeUrl: \"https://api.wahooligan.com/oauth/revoke\",\n\t\tclientId: INTEGRATION_CONFIG.WAHOO.clientId,\n\t\tclientSecret: INTEGRATION_CONFIG.WAHOO.clientSecret,\n\t\tscopes: [\"user_read\", \"workouts_read\", \"offline_data\"],\n\t\tcallbackPath: \"/api/integrations/wahoo/callback\",\n\t\toauthVersion: \"2.0\",\n\t};\n\n\tprivate static readonly ACTIVITY_MAP: Record<string, ActivityType> = {\n\t\trunning: \"RUN\",\n\t\tcycling: \"BIKE\",\n\t\tswimming: \"SWIM\",\n\t\tstrength: \"STRENGTH\",\n\t\tyoga: \"YOGA\",\n\t};\n\n\t// \u2500\u2500 OAuth \u2500\u2500\n\n\tbuildAuthUrl(state: string): string {\n\t\tconst params = new URLSearchParams({\n\t\t\tclient_id: this.oauthConfig.clientId,\n\t\t\tresponse_type: \"code\",\n\t\t\tredirect_uri: `${INTEGRATION_CONFIG.apiBaseUrl}${this.oauthConfig.callbackPath}`,\n\t\t\tscope: this.oauthConfig.scopes.join(\" \"),\n\t\t\tstate,\n\t\t});\n\t\treturn `${this.oauthConfig.authorizeUrl}?${params}`;\n\t}\n\n\tasync exchangeCode(code: string): Promise<OAuthTokens> {\n\t\tconst res = await fetchWithRetry(this.oauthConfig.tokenUrl, {\n\t\t\tmethod: \"POST\",\n\t\t\theaders: { \"Content-Type\": \"application/x-www-form-urlencoded\" },\n\t\t\tbody: new URLSearchParams({\n\t\t\t\tclient_id: this.oauthConfig.clientId,\n\t\t\t\tclient_secret: this.oauthConfig.clientSecret,\n\t\t\t\tcode,\n\t\t\t\tgrant_type: \"authorization_code\",\n\t\t\t\tredirect_uri: `${INTEGRATION_CONFIG.apiBaseUrl}${this.oauthConfig.callbackPath}`,\n\t\t\t}),\n\t\t});\n\n\t\tif (!res.ok) {\n\t\t\tthrow new ProviderApiError(\"WAHOO\", res.status, \"Code exchange failed\");\n\t\t}\n\n\t\tconst data = (await res.json()) as {\n\t\t\taccess_token: string;\n\t\t\trefresh_token: string;\n\t\t\texpires_in: number;\n\t\t\tcreated_at: number;\n\t\t};\n\n\t\t// Fetch user ID\n\t\tconst userRes = await fetch(`${WAHOO_API}/user`, {\n\t\t\theaders: { Authorization: `Bearer ${data.access_token}` },\n\t\t});\n\t\tconst user = (await userRes.json()) as { id: number };\n\n\t\treturn {\n\t\t\taccessToken: data.access_token,\n\t\t\trefreshToken: data.refresh_token,\n\t\t\texpiresAt: new Date((data.created_at + data.expires_in) * 1000),\n\t\t\tproviderUserId: String(user.id),\n\t\t\tscopes: this.oauthConfig.scopes,\n\t\t};\n\t}\n\n\tasync refreshToken(refreshToken: string): Promise<OAuthTokens> {\n\t\tconst res = await fetchWithRetry(this.oauthConfig.tokenUrl, {\n\t\t\tmethod: \"POST\",\n\t\t\theaders: { \"Content-Type\": \"application/x-www-form-urlencoded\" },\n\t\t\tbody: new URLSearchParams({\n\t\t\t\tclient_id: this.oauthConfig.clientId,\n\t\t\t\tclient_secret: this.oauthConfig.clientSecret,\n\t\t\t\trefresh_token: refreshToken,\n\t\t\t\tgrant_type: \"refresh_token\",\n\t\t\t}),\n\t\t});\n\n\t\tif (!res.ok) {\n\t\t\tthrow new ProviderApiError(\"WAHOO\", res.status, \"Token refresh failed\");\n\t\t}\n\n\t\tconst data = (await res.json()) as {\n\t\t\taccess_token: string;\n\t\t\trefresh_token: string;\n\t\t\texpires_in: number;\n\t\t\tcreated_at: number;\n\t\t};\n\n\t\treturn {\n\t\t\taccessToken: data.access_token,\n\t\t\trefreshToken: data.refresh_token,\n\t\t\texpiresAt: new Date((data.created_at + data.expires_in) * 1000),\n\t\t\tproviderUserId: \"\",\n\t\t\tscopes: this.oauthConfig.scopes,\n\t\t};\n\t}\n\n\tasync revokeAccess(accessToken: string): Promise<void> {\n\t\tawait fetch(this.oauthConfig.revokeUrl!, {\n\t\t\tmethod: \"POST\",\n\t\t\theaders: { \"Content-Type\": \"application/x-www-form-urlencoded\" },\n\t\t\tbody: new URLSearchParams({\n\t\t\t\ttoken: accessToken,\n\t\t\t\tclient_id: this.oauthConfig.clientId,\n\t\t\t\tclient_secret: this.oauthConfig.clientSecret,\n\t\t\t}),\n\t\t});\n\t}\n\n\t// \u2500\u2500 Webhooks \u2500\u2500\n\n\tverifyWebhook(headers: Record<string, string>, _body: string): boolean {\n\t\tconst expectedToken = INTEGRATION_CONFIG.WAHOO.webhookToken;\n\t\tif (!expectedToken) {\n\t\t\tlog.warn(\"WAHOO_WEBHOOK_TOKEN not configured \u2014 skipping verification\");\n\t\t\treturn true;\n\t\t}\n\n\t\tconst receivedToken = headers[\"webhook-token\"] || headers[\"Webhook-Token\"];\n\t\tif (!receivedToken) {\n\t\t\tlog.warn(\"Missing Webhook-Token header\");\n\t\t\treturn false;\n\t\t}\n\n\t\ttry {\n\t\t\treturn timingSafeEqual(\n\t\t\t\tBuffer.from(receivedToken, \"utf8\"),\n\t\t\t\tBuffer.from(expectedToken, \"utf8\"),\n\t\t\t);\n\t\t} catch {\n\t\t\treturn false;\n\t\t}\n\t}\n\n\textractOwnerIdFromWebhook(event: Record<string, unknown>): string {\n\t\tconst user = event.user as { id?: number } | undefined;\n\t\treturn String(user?.id || \"\");\n\t}\n\n\textractActivityIdFromWebhook(event: Record<string, unknown>): string {\n\t\tconst workout = event.workout_summary as { id?: number } | undefined;\n\t\treturn String(workout?.id || event.id || \"\");\n\t}\n\n\t// \u2500\u2500 Data Fetching \u2500\u2500\n\n\tasync fetchActivity(accessToken: string, activityId: string): Promise<NormalizedWorkout> {\n\t\tconst res = await fetchWithRetry(`${WAHOO_API}/workouts/${activityId}`, {\n\t\t\theaders: { Authorization: `Bearer ${accessToken}` },\n\t\t});\n\n\t\tif (!res.ok) {\n\t\t\tthrow new ProviderApiError(\"WAHOO\", res.status, \"fetchActivity failed\");\n\t\t}\n\n\t\tconst data = (await res.json()) as Record<string, unknown>;\n\t\treturn this.normalizeActivity(data);\n\t}\n\n\tasync fetchActivities(\n\t\taccessToken: string,\n\t\t_since: Date,\n\t\tlimit = 50,\n\t): Promise<NormalizedWorkout[]> {\n\t\tconst res = await fetchWithRetry(`${WAHOO_API}/workouts?per_page=${limit}`, {\n\t\t\theaders: { Authorization: `Bearer ${accessToken}` },\n\t\t});\n\n\t\tif (!res.ok) return [];\n\n\t\tconst data = (await res.json()) as {\n\t\t\tworkouts: Record<string, unknown>[];\n\t\t};\n\t\treturn (data.workouts || []).slice(0, limit).map((w) => this.normalizeActivity(w));\n\t}\n\n\t// \u2500\u2500 Mapping \u2500\u2500\n\n\tmapActivityType(wahooType: string): ActivityType {\n\t\treturn WahooProvider.ACTIVITY_MAP[wahooType.toLowerCase()] || \"OTHER\";\n\t}\n\n\tprivate normalizeActivity(a: Record<string, unknown>): NormalizedWorkout {\n\t\tconst summary = (a.workout_summary || a) as Record<string, unknown>;\n\t\tconst workout = (a.workout || a) as Record<string, unknown>;\n\n\t\tconst durationS = Number(summary.duration_active_accum || workout.duration_active_accum || 0);\n\t\tconst distanceM = Number(summary.distance_accum || workout.distance_accum || 0);\n\t\tconst sport = String(workout.workout_type || workout.name || \"other\");\n\n\t\treturn {\n\t\t\tactivityType: this.mapActivityType(sport),\n\t\t\tsource: \"WAHOO\",\n\t\t\tstartedAt: new Date(String(workout.starts || workout.created_at || new Date().toISOString())),\n\t\t\tdurationS: durationS || null,\n\t\t\tdistanceM: distanceM || null,\n\t\t\tavgHr: (summary.heart_rate_avg as number) || null,\n\t\t\tmaxHr: null, // Not always in summary\n\t\t\tavgPaceSKm: distanceM > 0 ? Math.round(durationS / (distanceM / 1000)) : null,\n\t\t\tavgPowerW: (summary.power_avg as number) || null,\n\t\t\tcalories: (summary.calories_accum as number) || null,\n\t\t\ttss: null,\n\t\t\trawData: a,\n\t\t\tnotes: (workout.description as string) || null,\n\t\t};\n\t}\n}\n", "// ============================================================\n// Provider Registry\n// Central lookup of all registered integration providers.\n// Adding a new provider: implement IntegrationProvider, import\n// it here, and add one line to the `providers` map.\n// ============================================================\n\nimport { GarminProvider } from \"./providers/garmin.js\";\nimport { PolarProvider } from \"./providers/polar.js\";\nimport { StravaProvider } from \"./providers/strava.js\";\nimport { WahooProvider } from \"./providers/wahoo.js\";\nimport type { IntegrationProvider, ProviderName } from \"./types.js\";\n\nconst providers = new Map<ProviderName, IntegrationProvider>([\n\t[\"STRAVA\", new StravaProvider()],\n\t[\"GARMIN\", new GarminProvider()],\n\t[\"POLAR\", new PolarProvider()],\n\t[\"WAHOO\", new WahooProvider()],\n]);\n\n/** Get a specific provider by name. Throws if unknown. */\nexport function getProvider(name: ProviderName): IntegrationProvider {\n\tconst p = providers.get(name);\n\tif (!p) throw new Error(`Unknown integration provider: ${name}`);\n\treturn p;\n}\n\n/** Get all registered providers (for Settings page listing). */\nexport function getAllProviders(): IntegrationProvider[] {\n\treturn [...providers.values()];\n}\n\n/** Get all registered provider names. */\nexport function getAllProviderNames(): ProviderName[] {\n\treturn [...providers.keys()];\n}\n", "// ============================================================\n// Token Encryption \u2014 AES-256-GCM at Rest\n// Encrypts OAuth tokens before DB storage.\n// Uses 12-byte IV + 16-byte auth tag per best practices.\n// ============================================================\n\nimport { createCipheriv, createDecipheriv, createHash, randomBytes } from \"node:crypto\";\n\nconst ALGORITHM = \"aes-256-gcm\";\nconst IV_LENGTH = 12; // 96-bit IV for GCM (NIST recommended)\nconst TAG_LENGTH = 16; // 128-bit auth tag\n\nfunction getEncryptionKey(): Buffer {\n\tconst keyHex = process.env.INTEGRATION_ENCRYPTION_KEY;\n\tif (!keyHex || keyHex.length !== 64) {\n\t\t// In development, derive a key from JWT_SECRET\n\t\tconst fallback = process.env.SUPABASE_JWT_SECRET || process.env.JWT_SECRET || \"dev-key\";\n\t\t// SHA-256 of the secret gives us exactly 32 bytes\n\t\treturn createHash(\"sha256\").update(fallback).digest();\n\t}\n\treturn Buffer.from(keyHex, \"hex\");\n}\n\n/**\n * Encrypt a plaintext token for storage.\n * Output format: base64(iv + ciphertext + tag)\n */\nexport function encryptToken(plaintext: string): string {\n\tconst key = getEncryptionKey();\n\tconst iv = randomBytes(IV_LENGTH);\n\n\tconst cipher = createCipheriv(ALGORITHM, key, iv, {\n\t\tauthTagLength: TAG_LENGTH,\n\t});\n\n\tconst encrypted = Buffer.concat([cipher.update(plaintext, \"utf8\"), cipher.final()]);\n\n\tconst tag = cipher.getAuthTag();\n\n\t// Concatenate: iv(12) + ciphertext(variable) + tag(16)\n\tconst combined = Buffer.concat([iv, encrypted, tag]);\n\treturn combined.toString(\"base64\");\n}\n\n/**\n * Decrypt an encrypted token from storage.\n * Throws if tampered or wrong key.\n */\nexport function decryptToken(encrypted: string): string {\n\tconst key = getEncryptionKey();\n\tconst combined = Buffer.from(encrypted, \"base64\");\n\n\t// Extract components\n\tconst iv = combined.subarray(0, IV_LENGTH);\n\tconst tag = combined.subarray(combined.length - TAG_LENGTH);\n\tconst ciphertext = combined.subarray(IV_LENGTH, combined.length - TAG_LENGTH);\n\n\tconst decipher = createDecipheriv(ALGORITHM, key, iv, {\n\t\tauthTagLength: TAG_LENGTH,\n\t});\n\tdecipher.setAuthTag(tag);\n\n\tconst decrypted = Buffer.concat([decipher.update(ciphertext), decipher.final()]);\n\n\treturn decrypted.toString(\"utf8\");\n}\n\n/**\n * Check if a value looks like an encrypted token (base64 of iv+ct+tag).\n * Used for migration: if token is already encrypted, don't double-encrypt.\n */\nexport function isEncrypted(value: string): boolean {\n\ttry {\n\t\tconst buf = Buffer.from(value, \"base64\");\n\t\t// Minimum: 12 (iv) + 1 (ciphertext) + 16 (tag) = 29 bytes\n\t\treturn buf.length >= 29 && value === buf.toString(\"base64\");\n\t} catch {\n\t\treturn false;\n\t}\n}\n", "// ============================================================\n// Token Manager\n// Ensures access tokens are fresh before making API calls.\n// Handles automatic refresh with a 5-minute buffer.\n//\n// Security: Decrypts tokens from DB, re-encrypts after refresh.\n// ============================================================\n\nimport type { SupabaseClient } from \"@supabase/supabase-js\";\nimport { createLogger } from \"../../lib/logger.js\";\nimport { decryptToken, encryptToken, isEncrypted } from \"./crypto.js\";\nimport { TokenExpiredError } from \"./errors.js\";\nimport { getProvider } from \"./registry.js\";\nimport type { ConnectedAccount, IntegrationProvider } from \"./types.js\";\n\nconst log = createLogger({ module: \"token-manager\" });\n\n/** Buffer before expiry to trigger a refresh (5 min) */\nconst REFRESH_BUFFER_MS = 5 * 60 * 1000;\n\n/**\n * Ensure the access token for a connected account is fresh.\n * Returns a **plaintext** access token, refreshing if needed.\n * Decrypt \u2192 check expiry \u2192 refresh if needed \u2192 re-encrypt + store.\n */\nexport async function ensureFreshToken(\n\tprovider: IntegrationProvider,\n\taccount: ConnectedAccount,\n\tclient: SupabaseClient,\n): Promise<string> {\n\t// Decrypt the stored token\n\tlet plainAccessToken: string;\n\ttry {\n\t\tplainAccessToken = isEncrypted(account.access_token)\n\t\t\t? decryptToken(account.access_token)\n\t\t\t: account.access_token;\n\t} catch {\n\t\t// If decryption fails, try using as-is (migration scenario)\n\t\tplainAccessToken = account.access_token;\n\t}\n\n\t// If no expiry set or token still valid, return as-is\n\tif (account.token_expires) {\n\t\tconst expiresAt = new Date(account.token_expires);\n\t\tif (expiresAt.getTime() > Date.now() + REFRESH_BUFFER_MS) {\n\t\t\treturn plainAccessToken;\n\t\t}\n\t} else {\n\t\t// No expiry info \u2014 assume token is valid (some providers don't expire)\n\t\treturn plainAccessToken;\n\t}\n\n\t// Token expired or about to expire \u2014 refresh it\n\tlet plainRefreshToken: string | null = null;\n\tif (account.refresh_token) {\n\t\ttry {\n\t\t\tplainRefreshToken = isEncrypted(account.refresh_token)\n\t\t\t\t? decryptToken(account.refresh_token)\n\t\t\t\t: account.refresh_token;\n\t\t} catch {\n\t\t\tplainRefreshToken = account.refresh_token;\n\t\t}\n\t}\n\n\tif (!plainRefreshToken) {\n\t\tthrow new TokenExpiredError(provider.name);\n\t}\n\n\tlog.info({ provider: provider.name, athleteId: account.athlete_id }, \"Refreshing token\");\n\n\tconst tokens = await provider.refreshToken(plainRefreshToken);\n\n\t// Re-encrypt and update stored tokens\n\tconst { error } = await client\n\t\t.from(\"connected_accounts\")\n\t\t.update({\n\t\t\taccess_token: encryptToken(tokens.accessToken),\n\t\t\trefresh_token: tokens.refreshToken\n\t\t\t\t? encryptToken(tokens.refreshToken)\n\t\t\t\t: account.refresh_token,\n\t\t\ttoken_expires: tokens.expiresAt.toISOString(),\n\t\t})\n\t\t.eq(\"id\", account.id);\n\n\tif (error) {\n\t\tlog.error({ err: error }, \"Failed to update tokens\");\n\t}\n\n\treturn tokens.accessToken;\n}\n\n/**\n * Get connected account + fresh token for a given provider and athlete.\n * Returns null if the athlete hasn't connected this provider.\n */\nexport async function getActiveConnection(\n\tproviderName: string,\n\tathleteId: string,\n\tclient: SupabaseClient,\n): Promise<{ account: ConnectedAccount; accessToken: string } | null> {\n\tconst { data: account } = await client\n\t\t.from(\"connected_accounts\")\n\t\t.select(\"*\")\n\t\t.eq(\"athlete_id\", athleteId)\n\t\t.eq(\"provider\", providerName)\n\t\t.single();\n\n\tif (!account) return null;\n\n\tconst provider = getProvider(providerName as import(\"./types.js\").ProviderName);\n\tconst accessToken = await ensureFreshToken(provider, account, client);\n\n\treturn { account, accessToken };\n}\n\n/**\n * Get all connected accounts for an athlete.\n * Useful for the Settings page.\n */\nexport async function getConnectedAccounts(\n\tathleteId: string,\n\tclient: SupabaseClient,\n): Promise<\n\tArray<{\n\t\tprovider: string;\n\t\tconnected: boolean;\n\t\tlastSyncAt: string | null;\n\t\tproviderUid: string | null;\n\t}>\n> {\n\tconst { data: accounts } = await client\n\t\t.from(\"connected_accounts\")\n\t\t.select(\"provider, last_sync_at, provider_uid\")\n\t\t.eq(\"athlete_id\", athleteId);\n\n\treturn (accounts || []).map((a) => ({\n\t\tprovider: a.provider,\n\t\tconnected: true,\n\t\tlastSyncAt: a.last_sync_at,\n\t\tproviderUid: a.provider_uid,\n\t}));\n}\n", "// ============================================================\n// Garmin OAuth Routes\n// Stub \u2014 OAuth 1.0a requires business API approval\n// ============================================================\n\nimport { Hono } from \"hono\";\nimport { getAuth } from \"../../middleware/auth.js\";\nimport { createAdminClient } from \"../../services/ai/supabase.js\";\nimport { disconnectProvider } from \"../../services/integrations/oauth.js\";\nimport { getProvider } from \"../../services/integrations/registry.js\";\n\nexport const garminRoutes = new Hono();\n\nconst provider = getProvider(\"GARMIN\");\n\ngarminRoutes.get(\"/connect\", (c) => {\n\tconst _auth = getAuth(c);\n\n\t// Garmin requires business API approval\n\treturn c.json(\n\t\t{\n\t\t\terror: \"Garmin integration requires business API approval\",\n\t\t\tstatus: \"pending_approval\",\n\t\t\tapplyAt: \"https://developer.garmin.com/gc-developer-program/\",\n\t\t},\n\t\t503,\n\t);\n});\n\ngarminRoutes.get(\"/callback\", async (c) => {\n\t// TODO: Implement OAuth 1.0a callback when API is approved\n\treturn c.json({ error: \"Not yet implemented\" }, 501);\n});\n\ngarminRoutes.post(\"/disconnect\", async (c) => {\n\tconst auth = getAuth(c);\n\tconst client = createAdminClient();\n\tawait disconnectProvider(provider, auth.userId, client);\n\treturn c.json({ status: \"disconnected\", provider: \"GARMIN\" });\n});\n", "// ============================================================\n// Data Normalizer\n// Maps provider-specific data \u2192 our schema, deduplicates, and\n// auto-populates daily_logs from biometric metrics.\n// Single pipeline shared by all providers.\n// ============================================================\n\nimport type { SupabaseClient } from \"@supabase/supabase-js\";\nimport { createLogger } from \"../../lib/logger.js\";\nimport type { NormalizedMetric, NormalizedWorkout, SyncResult } from \"./types.js\";\n\nconst log = createLogger({ module: \"normalizer\" });\n\n/** Time window for workout deduplication (ms) */\nconst DEDUP_WINDOW_MS = 5 * 60 * 1000; // 5 minutes\n\n/**\n * Normalize and store workouts + health metrics from any provider.\n * Handles deduplication and daily_log auto-population.\n */\nexport async function normalizeAndStore(\n\tworkouts: NormalizedWorkout[],\n\tmetrics: NormalizedMetric[],\n\tathleteId: string,\n\tclubId: string,\n\tclient: SupabaseClient,\n): Promise<SyncResult> {\n\tconst result: SyncResult = {\n\t\tworkoutsInserted: 0,\n\t\tworkoutsSkipped: 0,\n\t\tmetricsInserted: 0,\n\t\tmetricsSkipped: 0,\n\t};\n\n\t// \u2500\u2500 Insert workouts (dedup by athlete + source + started_at \u00B1 5min) \u2500\u2500\n\tfor (const w of workouts) {\n\t\ttry {\n\t\t\tconst windowStart = new Date(w.startedAt.getTime() - DEDUP_WINDOW_MS).toISOString();\n\t\t\tconst windowEnd = new Date(w.startedAt.getTime() + DEDUP_WINDOW_MS).toISOString();\n\n\t\t\tconst { data: existing } = await client\n\t\t\t\t.from(\"workouts\")\n\t\t\t\t.select(\"id\")\n\t\t\t\t.eq(\"athlete_id\", athleteId)\n\t\t\t\t.eq(\"source\", w.source)\n\t\t\t\t.gte(\"started_at\", windowStart)\n\t\t\t\t.lte(\"started_at\", windowEnd)\n\t\t\t\t.limit(1);\n\n\t\t\tif (existing?.length) {\n\t\t\t\tresult.workoutsSkipped++;\n\t\t\t\tcontinue;\n\t\t\t}\n\n\t\t\tconst { error } = await client.from(\"workouts\").insert({\n\t\t\t\tathlete_id: athleteId,\n\t\t\t\tclub_id: clubId,\n\t\t\t\tactivity_type: w.activityType,\n\t\t\t\tsource: w.source,\n\t\t\t\tstarted_at: w.startedAt.toISOString(),\n\t\t\t\tduration_s: w.durationS,\n\t\t\t\tdistance_m: w.distanceM,\n\t\t\t\tavg_hr: w.avgHr,\n\t\t\t\tmax_hr: w.maxHr,\n\t\t\t\tavg_pace_s_km: w.avgPaceSKm,\n\t\t\t\tavg_power_w: w.avgPowerW,\n\t\t\t\tcalories: w.calories,\n\t\t\t\ttss: w.tss,\n\t\t\t\traw_data: w.rawData,\n\t\t\t\tnotes: w.notes,\n\t\t\t});\n\n\t\t\tif (error) {\n\t\t\t\tlog.error({ err: error, source: w.source, athleteId }, \"Workout insert error\");\n\t\t\t\tresult.workoutsSkipped++;\n\t\t\t} else {\n\t\t\t\tresult.workoutsInserted++;\n\t\t\t}\n\t\t} catch (err) {\n\t\t\tlog.error({ err, athleteId }, \"Workout processing error\");\n\t\t\tresult.workoutsSkipped++;\n\t\t}\n\t}\n\n\t// \u2500\u2500 Insert health metrics (dedup by athlete + type + recorded_at) \u2500\u2500\n\tfor (const m of metrics) {\n\t\ttry {\n\t\t\tconst { data: existing } = await client\n\t\t\t\t.from(\"health_metrics\")\n\t\t\t\t.select(\"id\")\n\t\t\t\t.eq(\"athlete_id\", athleteId)\n\t\t\t\t.eq(\"metric_type\", m.metricType)\n\t\t\t\t.eq(\"recorded_at\", m.recordedAt.toISOString())\n\t\t\t\t.limit(1);\n\n\t\t\tif (existing?.length) {\n\t\t\t\tresult.metricsSkipped++;\n\t\t\t\tcontinue;\n\t\t\t}\n\n\t\t\tconst { error } = await client.from(\"health_metrics\").insert({\n\t\t\t\tathlete_id: athleteId,\n\t\t\t\tclub_id: clubId,\n\t\t\t\tmetric_type: m.metricType,\n\t\t\t\tvalue: m.value,\n\t\t\t\tunit: m.unit,\n\t\t\t\trecorded_at: m.recordedAt.toISOString(),\n\t\t\t\tsource: m.source,\n\t\t\t\traw_data: m.rawData || null,\n\t\t\t});\n\n\t\t\tif (error) {\n\t\t\t\tlog.error({ err: error, metricType: m.metricType, athleteId }, \"Metric insert error\");\n\t\t\t\tresult.metricsSkipped++;\n\t\t\t} else {\n\t\t\t\tresult.metricsInserted++;\n\t\t\t}\n\t\t} catch (err) {\n\t\t\tlog.error({ err, athleteId }, \"Metric processing error\");\n\t\t\tresult.metricsSkipped++;\n\t\t}\n\t}\n\n\t// \u2500\u2500 Auto-populate daily_logs from biometric metrics \u2500\u2500\n\tawait autoPopulateDailyLogs(metrics, athleteId, clubId, client);\n\n\treturn result;\n}\n\n/**\n * Auto-populate daily_logs from synced health metrics.\n * If a daily_log for today doesn't exist, creates one.\n * If it exists, updates only null fields (never overwrites manual entries).\n */\nasync function autoPopulateDailyLogs(\n\tmetrics: NormalizedMetric[],\n\tathleteId: string,\n\tclubId: string,\n\tclient: SupabaseClient,\n): Promise<void> {\n\t// Group metrics by date\n\tconst byDate = new Map<string, { hrv?: number; restingHr?: number; sleepHours?: number }>();\n\n\tfor (const m of metrics) {\n\t\tconst date = m.recordedAt.toISOString().split(\"T\")[0];\n\t\tconst existing = byDate.get(date) || {};\n\n\t\tswitch (m.metricType) {\n\t\t\tcase \"HRV\":\n\t\t\t\texisting.hrv = m.value;\n\t\t\t\tbreak;\n\t\t\tcase \"RESTING_HR\":\n\t\t\t\texisting.restingHr = m.value;\n\t\t\t\tbreak;\n\t\t\tcase \"SLEEP_HOURS\":\n\t\t\t\texisting.sleepHours = m.value;\n\t\t\t\tbreak;\n\t\t}\n\n\t\tbyDate.set(date, existing);\n\t}\n\n\t// Upsert daily_logs\n\tfor (const [date, data] of byDate) {\n\t\tconst { data: existing } = await client\n\t\t\t.from(\"daily_logs\")\n\t\t\t.select(\"id, hrv, resting_hr, sleep_hours\")\n\t\t\t.eq(\"athlete_id\", athleteId)\n\t\t\t.eq(\"log_date\", date)\n\t\t\t.single();\n\n\t\tif (existing) {\n\t\t\t// Update only null fields (don't overwrite manual entries)\n\t\t\tconst updates: Record<string, unknown> = {};\n\t\t\tif (existing.hrv === null && data.hrv !== undefined) updates.hrv = data.hrv;\n\t\t\tif (existing.resting_hr === null && data.restingHr !== undefined)\n\t\t\t\tupdates.resting_hr = data.restingHr;\n\t\t\tif (existing.sleep_hours === null && data.sleepHours !== undefined)\n\t\t\t\tupdates.sleep_hours = data.sleepHours;\n\n\t\t\tif (Object.keys(updates).length > 0) {\n\t\t\t\tawait client.from(\"daily_logs\").update(updates).eq(\"id\", existing.id);\n\t\t\t}\n\t\t} else {\n\t\t\t// Create new daily_log\n\t\t\tawait client.from(\"daily_logs\").insert({\n\t\t\t\tathlete_id: athleteId,\n\t\t\t\tclub_id: clubId,\n\t\t\t\tlog_date: date,\n\t\t\t\thrv: data.hrv || null,\n\t\t\t\tresting_hr: data.restingHr || null,\n\t\t\t\tsleep_hours: data.sleepHours || null,\n\t\t\t});\n\t\t}\n\t}\n}\n", "// ============================================================\n// OAuth State Security \u2014 CSRF Protection\n// Signs the state parameter with HMAC-SHA256 + expiry.\n// Prevents callback URL forgery attacks.\n// ============================================================\n\nimport { createHmac, timingSafeEqual } from \"node:crypto\";\nimport { createLogger } from \"../../lib/logger.js\";\n\nconst log = createLogger({ module: \"oauth-state\" });\n\n/** State expires after 10 minutes */\nconst STATE_TTL_MS = 10 * 60 * 1000;\n\nfunction getSigningKey(): string {\n\tconst key =\n\t\tprocess.env.SUPABASE_JWT_SECRET ||\n\t\tprocess.env.JWT_SECRET ||\n\t\t\"fallback-dev-key-change-in-production\";\n\treturn key;\n}\n\n/**\n * Create a signed OAuth state parameter.\n * Format: base64url(athleteId:timestamp:hmac)\n */\nexport function createOAuthState(athleteId: string): string {\n\tconst timestamp = Date.now().toString(36);\n\tconst payload = `${athleteId}:${timestamp}`;\n\tconst hmac = createHmac(\"sha256\", getSigningKey()).update(payload).digest(\"hex\").slice(0, 16); // 16 hex chars = 64 bits \u2014 sufficient for CSRF\n\n\tconst state = Buffer.from(`${payload}:${hmac}`).toString(\"base64url\");\n\treturn state;\n}\n\n/**\n * Verify and decode a signed OAuth state parameter.\n * Returns the athleteId if valid, null if tampered/expired.\n */\nexport function verifyOAuthState(state: string): { athleteId: string } | null {\n\ttry {\n\t\tconst decoded = Buffer.from(state, \"base64url\").toString(\"utf8\");\n\t\tconst parts = decoded.split(\":\");\n\n\t\tif (parts.length !== 3) return null;\n\n\t\tconst [athleteId, timestamp, receivedHmac] = parts;\n\n\t\t// Check expiry\n\t\tconst ts = parseInt(timestamp, 36);\n\t\tif (Date.now() - ts > STATE_TTL_MS) {\n\t\t\tlog.warn(\"OAuth state expired\");\n\t\t\treturn null;\n\t\t}\n\n\t\t// Verify HMAC\n\t\tconst expectedHmac = createHmac(\"sha256\", getSigningKey())\n\t\t\t.update(`${athleteId}:${timestamp}`)\n\t\t\t.digest(\"hex\")\n\t\t\t.slice(0, 16);\n\n\t\tconst a = Buffer.from(receivedHmac, \"utf8\");\n\t\tconst b = Buffer.from(expectedHmac, \"utf8\");\n\n\t\tif (a.length !== b.length || !timingSafeEqual(a, b)) {\n\t\t\tlog.warn(\"Invalid HMAC signature on OAuth state\");\n\t\t\treturn null;\n\t\t}\n\n\t\treturn { athleteId };\n\t} catch {\n\t\tlog.warn(\"Failed to decode OAuth state\");\n\t\treturn null;\n\t}\n}\n", "// ============================================================\n// OAuth Factory\n// Generic OAuth2 flow that works for all providers.\n// Handles: authorization URL, code exchange, token storage,\n// backfill on first connect.\n//\n// Security: HMAC-signed state (CSRF), AES-256-GCM token encryption\n// ============================================================\n\nimport type { SupabaseClient } from \"@supabase/supabase-js\";\nimport type { Context } from \"hono\";\nimport { INTEGRATION_CONFIG } from \"../../config/integrations.js\";\nimport { createLogger } from \"../../lib/logger.js\";\nimport { getAuth } from \"../../middleware/auth.js\";\nimport { createAdminClient } from \"../ai/supabase.js\";\nimport { decryptToken, encryptToken, isEncrypted } from \"./crypto.js\";\nimport { IntegrationError, OAuthStateError } from \"./errors.js\";\nimport { normalizeAndStore } from \"./normalizer.js\";\nimport { createOAuthState, verifyOAuthState } from \"./oauth-state.js\";\nimport { getActiveConnection } from \"./token-manager.js\";\nimport type { IntegrationProvider, ProviderName } from \"./types.js\";\n\nconst log = createLogger({ module: \"oauth\" });\n\n/**\n * Build the OAuth authorization redirect URL for a provider.\n * State is HMAC-signed with the athleteId + 10-min expiry.\n */\nexport function buildAuthorizationUrl(provider: IntegrationProvider, athleteId: string): string {\n\tconst state = createOAuthState(athleteId);\n\treturn provider.buildAuthUrl(state);\n}\n\n/**\n * Verify the OAuth callback state and extract the athlete ID.\n * Throws OAuthStateError if tampered or expired.\n */\nexport function verifyCallbackState(provider: IntegrationProvider, state: string): string {\n\tconst result = verifyOAuthState(state);\n\tif (!result) {\n\t\tthrow new OAuthStateError(provider.name);\n\t}\n\treturn result.athleteId;\n}\n\n/**\n * Handle the OAuth callback: exchange code \u2192 encrypt tokens \u2192 store \u2192 backfill.\n * Called from the provider-specific callback route.\n */\nexport async function handleOAuthCallback(\n\tprovider: IntegrationProvider,\n\tcode: string,\n\tathleteId: string,\n\tclubId: string,\n\tclient: SupabaseClient,\n): Promise<{ success: boolean; provider: string }> {\n\t// 1. Exchange authorization code for tokens\n\tconst tokens = await provider.exchangeCode(code);\n\n\t// 2. Encrypt tokens before storage\n\tconst encAccessToken = encryptToken(tokens.accessToken);\n\tconst encRefreshToken = tokens.refreshToken ? encryptToken(tokens.refreshToken) : null;\n\n\t// 3. Upsert connected account with encrypted tokens\n\tconst { error: upsertError } = await client.from(\"connected_accounts\").upsert(\n\t\t{\n\t\t\tathlete_id: athleteId,\n\t\t\tprovider: provider.name,\n\t\t\taccess_token: encAccessToken,\n\t\t\trefresh_token: encRefreshToken,\n\t\t\ttoken_expires: tokens.expiresAt.toISOString(),\n\t\t\tprovider_uid: tokens.providerUserId,\n\t\t\tscopes: tokens.scopes,\n\t\t\tlast_sync_at: null,\n\t\t},\n\t\t{ onConflict: \"athlete_id,provider\" },\n\t);\n\n\tif (upsertError) {\n\t\tlog.error({ err: upsertError, provider: provider.name }, \"Failed to store tokens\");\n\t\tthrow new IntegrationError(provider.name, `Failed to store connection: ${upsertError.message}`);\n\t}\n\n\tlog.info(\n\t\t{ provider: provider.name, athleteId, providerUid: tokens.providerUserId },\n\t\t\"Provider connected\",\n\t);\n\n\t// 4. Backfill last 30 days of activities (fire-and-forget)\n\tbackfillActivities(\n\t\tprovider,\n\t\ttokens.accessToken, // Use plaintext for immediate API calls\n\t\tathleteId,\n\t\tclubId,\n\t\tclient,\n\t)\n\t\t.then((result) => {\n\t\t\tlog.info(\n\t\t\t\t{\n\t\t\t\t\tprovider: provider.name,\n\t\t\t\t\tworkoutsInserted: result.workoutsInserted,\n\t\t\t\t\tmetricsInserted: result.metricsInserted,\n\t\t\t\t},\n\t\t\t\t\"Backfill complete\",\n\t\t\t);\n\t\t})\n\t\t.catch((err) => {\n\t\t\tlog.error({ err, provider: provider.name }, \"Backfill failed\");\n\t\t});\n\n\treturn { success: true, provider: provider.name };\n}\n\n/**\n * Backfill activities from a provider for the last N days.\n */\nasync function backfillActivities(\n\tprovider: IntegrationProvider,\n\taccessToken: string,\n\tathleteId: string,\n\tclubId: string,\n\tclient: SupabaseClient,\n\tdaysBack = 30,\n) {\n\tconst since = new Date(Date.now() - daysBack * 24 * 60 * 60 * 1000);\n\n\tconst activities = await provider.fetchActivities(accessToken, since);\n\n\tconst metrics: import(\"./types.js\").NormalizedMetric[] = [];\n\tif (provider.fetchHealthData) {\n\t\tconst todayMetrics = await provider.fetchHealthData(accessToken, new Date());\n\t\tmetrics.push(...todayMetrics);\n\t}\n\n\treturn normalizeAndStore(activities, metrics, athleteId, clubId, client);\n}\n\n// \u2500\u2500 Shared Route Handlers \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\n// Extracted from the near-identical strava/polar/wahoo route files.\n\n/**\n * Shared OAuth callback handler for all providers.\n * Verifies HMAC state, looks up club_id, exchanges code, redirects.\n */\nexport async function handleProviderOAuthCallback(\n\tprovider: IntegrationProvider,\n\tproviderSlug: string,\n\tc: Context,\n): Promise<Response> {\n\tconst code = c.req.query(\"code\");\n\tconst state = c.req.query(\"state\");\n\tconst error = c.req.query(\"error\");\n\tconst webUrl = INTEGRATION_CONFIG.webUrl;\n\n\tif (error || !code || !state) {\n\t\tlog.error({ error, provider: providerSlug }, \"OAuth callback error\");\n\t\treturn c.redirect(`${webUrl}/workout/settings?integration=${providerSlug}&error=denied`);\n\t}\n\n\ttry {\n\t\tconst athleteId = verifyCallbackState(provider, state);\n\t\tconst client = createAdminClient();\n\t\tconst { data: profile } = await client\n\t\t\t.from(\"profiles\")\n\t\t\t.select(\"club_id\")\n\t\t\t.eq(\"id\", athleteId)\n\t\t\t.single();\n\n\t\tif (!profile) {\n\t\t\treturn c.json({ error: \"Athlete not found\" }, 404);\n\t\t}\n\n\t\tawait handleOAuthCallback(provider, code, athleteId, profile.club_id, client);\n\t\treturn c.redirect(`${webUrl}/workout/settings?integration=${providerSlug}&status=connected`);\n\t} catch (err) {\n\t\tlog.error({ err, provider: providerSlug }, \"OAuth callback failed\");\n\t\treturn c.redirect(`${webUrl}/workout/settings?integration=${providerSlug}&error=failed`);\n\t}\n}\n\n/**\n * Shared manual sync handler for all providers.\n * Rate-limited via PostgreSQL `check_rate_limit()` (survives restarts).\n * Fetches activities (and health data if the provider supports it).\n */\nexport async function handleProviderSync(\n\tprovider: IntegrationProvider,\n\tproviderName: ProviderName,\n\tc: Context,\n): Promise<Response> {\n\tconst auth = getAuth(c);\n\tconst client = createAdminClient();\n\n\t// DB-backed rate limit: 1 sync per cooldown window per user+provider\n\tconst cooldownSec = Math.ceil(INTEGRATION_CONFIG.syncCooldownMs / 1000);\n\ttry {\n\t\tconst { data: remaining, error } = await client.rpc(\"check_rate_limit\", {\n\t\t\trate_key: `sync:${providerName}:${auth.userId}`,\n\t\t\tmax_requests: 1,\n\t\t\twindow_seconds: cooldownSec,\n\t\t});\n\n\t\tif (!error && (remaining as number) < 0) {\n\t\t\treturn c.json({ error: `Please wait before syncing again` }, 429);\n\t\t}\n\t} catch {\n\t\t// Fail open \u2014 allow sync if rate limit check fails\n\t}\n\n\tconst connection = await getActiveConnection(providerName, auth.userId, client);\n\n\tif (!connection) {\n\t\treturn c.json({ error: `${providerName} not connected` }, 400);\n\t}\n\n\tconst since = new Date(Date.now() - 7 * 24 * 60 * 60 * 1000);\n\tconst activities = await provider.fetchActivities(connection.accessToken, since);\n\n\tconst healthData = provider.fetchHealthData\n\t\t? await provider.fetchHealthData(connection.accessToken, new Date())\n\t\t: [];\n\n\tconst result = await normalizeAndStore(activities, healthData, auth.userId, auth.clubId, client);\n\n\tawait client\n\t\t.from(\"connected_accounts\")\n\t\t.update({ last_sync_at: new Date().toISOString() })\n\t\t.eq(\"id\", connection.account.id);\n\n\treturn c.json({\n\t\tstatus: \"synced\",\n\t\tworkoutsInserted: result.workoutsInserted,\n\t\tworkoutsSkipped: result.workoutsSkipped,\n\t\tmetricsInserted: result.metricsInserted,\n\t});\n}\n\n/**\n * Disconnect a provider: revoke access + delete stored tokens.\n */\nexport async function disconnectProvider(\n\tprovider: IntegrationProvider,\n\tathleteId: string,\n\tclient: SupabaseClient,\n): Promise<void> {\n\t// Get stored tokens\n\tconst { data: account } = await client\n\t\t.from(\"connected_accounts\")\n\t\t.select(\"*\")\n\t\t.eq(\"athlete_id\", athleteId)\n\t\t.eq(\"provider\", provider.name)\n\t\t.single();\n\n\tif (account) {\n\t\t// Decrypt token for revocation\n\t\tlet plainToken = account.access_token;\n\t\ttry {\n\t\t\tif (isEncrypted(account.access_token)) {\n\t\t\t\tplainToken = decryptToken(account.access_token);\n\t\t\t}\n\t\t} catch {\n\t\t\t// If decrypt fails, try revoking with stored value anyway\n\t\t}\n\n\t\t// Revoke on provider side (best effort)\n\t\ttry {\n\t\t\tawait provider.revokeAccess(plainToken);\n\t\t} catch (err) {\n\t\t\tlog.warn({ err, provider: provider.name }, \"Failed to revoke access (continuing)\");\n\t\t}\n\n\t\t// Delete from DB\n\t\tawait client\n\t\t\t.from(\"connected_accounts\")\n\t\t\t.delete()\n\t\t\t.eq(\"athlete_id\", athleteId)\n\t\t\t.eq(\"provider\", provider.name);\n\t}\n\n\tlog.info({ provider: provider.name, athleteId }, \"Provider disconnected\");\n}\n", "// ============================================================\n// Polar OAuth Routes\n// /api/integrations/polar/connect, /callback, /disconnect, /sync\n// ============================================================\n\nimport { Hono } from \"hono\";\nimport { getAuth } from \"../../middleware/auth.js\";\nimport { createAdminClient } from \"../../services/ai/supabase.js\";\nimport {\n\tbuildAuthorizationUrl,\n\tdisconnectProvider,\n\thandleProviderOAuthCallback,\n\thandleProviderSync,\n} from \"../../services/integrations/oauth.js\";\nimport { getProvider } from \"../../services/integrations/registry.js\";\n\nexport const polarRoutes = new Hono();\n\nconst provider = getProvider(\"POLAR\");\n\npolarRoutes.get(\"/connect\", (c) => {\n\tconst auth = getAuth(c);\n\treturn c.redirect(buildAuthorizationUrl(provider, auth.userId));\n});\n\npolarRoutes.get(\"/callback\", (c) => handleProviderOAuthCallback(provider, \"polar\", c));\n\npolarRoutes.post(\"/disconnect\", async (c) => {\n\tconst auth = getAuth(c);\n\tconst client = createAdminClient();\n\tawait disconnectProvider(provider, auth.userId, client);\n\treturn c.json({ status: \"disconnected\", provider: \"POLAR\" });\n});\n\npolarRoutes.post(\"/sync\", (c) => handleProviderSync(provider, \"POLAR\", c));\n", "// ============================================================\n// Strava OAuth Routes\n// /api/integrations/strava/connect \u2014 redirect to Strava\n// /api/integrations/strava/callback \u2014 handle OAuth callback\n// /api/integrations/strava/disconnect \u2014 revoke + delete\n// /api/integrations/strava/sync \u2014 manual sync trigger\n//\n// Security: HMAC-signed state, encrypted tokens\n// ============================================================\n\nimport { Hono } from \"hono\";\nimport { getAuth } from \"../../middleware/auth.js\";\nimport { createAdminClient } from \"../../services/ai/supabase.js\";\nimport {\n\tbuildAuthorizationUrl,\n\tdisconnectProvider,\n\thandleProviderOAuthCallback,\n\thandleProviderSync,\n} from \"../../services/integrations/oauth.js\";\nimport { getProvider } from \"../../services/integrations/registry.js\";\n\nexport const stravaRoutes = new Hono();\n\nconst provider = getProvider(\"STRAVA\");\n\nstravaRoutes.get(\"/connect\", (c) => {\n\tconst auth = getAuth(c);\n\treturn c.redirect(buildAuthorizationUrl(provider, auth.userId));\n});\n\nstravaRoutes.get(\"/callback\", (c) => handleProviderOAuthCallback(provider, \"strava\", c));\n\nstravaRoutes.post(\"/disconnect\", async (c) => {\n\tconst auth = getAuth(c);\n\tconst client = createAdminClient();\n\tawait disconnectProvider(provider, auth.userId, client);\n\treturn c.json({ status: \"disconnected\", provider: \"STRAVA\" });\n});\n\nstravaRoutes.post(\"/sync\", (c) => handleProviderSync(provider, \"STRAVA\", c));\n", "// ============================================================\n// Wahoo OAuth Routes\n// /api/integrations/wahoo/connect, /callback, /disconnect, /sync\n// ============================================================\n\nimport { Hono } from \"hono\";\nimport { getAuth } from \"../../middleware/auth.js\";\nimport { createAdminClient } from \"../../services/ai/supabase.js\";\nimport {\n\tbuildAuthorizationUrl,\n\tdisconnectProvider,\n\thandleProviderOAuthCallback,\n\thandleProviderSync,\n} from \"../../services/integrations/oauth.js\";\nimport { getProvider } from \"../../services/integrations/registry.js\";\n\nexport const wahooRoutes = new Hono();\n\nconst provider = getProvider(\"WAHOO\");\n\nwahooRoutes.get(\"/connect\", (c) => {\n\tconst auth = getAuth(c);\n\treturn c.redirect(buildAuthorizationUrl(provider, auth.userId));\n});\n\nwahooRoutes.get(\"/callback\", (c) => handleProviderOAuthCallback(provider, \"wahoo\", c));\n\nwahooRoutes.post(\"/disconnect\", async (c) => {\n\tconst auth = getAuth(c);\n\tconst client = createAdminClient();\n\tawait disconnectProvider(provider, auth.userId, client);\n\treturn c.json({ status: \"disconnected\", provider: \"WAHOO\" });\n});\n\nwahooRoutes.post(\"/sync\", (c) => handleProviderSync(provider, \"WAHOO\", c));\n", "/**\n * Planned Workouts REST API \u2014 CRUD endpoints for the calendar UI.\n *\n * All routes are protected by JWT auth + claims extraction\n * (applied in server.ts for /api/* routes).\n */\n\nimport { createClient } from \"@supabase/supabase-js\";\nimport { PlannedWorkoutInput, PlannedWorkoutUpdate } from \"@triathlon/types\";\nimport { Hono } from \"hono\";\nimport { createLogger } from \"../../lib/logger.js\";\nimport { getAuth } from \"../../middleware/auth.js\";\nimport { isResponse, parseBody } from \"../../middleware/validate.js\";\n\nconst log = createLogger({ module: \"planned-workouts\" });\n\nconst SUPABASE_URL = process.env.SUPABASE_URL!;\nconst SUPABASE_SERVICE_KEY = process.env.SUPABASE_SERVICE_ROLE_KEY!;\n\nfunction getSupabase() {\n\treturn createClient(SUPABASE_URL, SUPABASE_SERVICE_KEY);\n}\n\nexport const plannedWorkoutsRoutes = new Hono();\n\n// \u2500\u2500 GET /api/planned-workouts \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\n// Query params: from (ISO date), to (ISO date), status (optional)\nplannedWorkoutsRoutes.get(\"/\", async (c) => {\n\tconst { userId, clubId } = getAuth(c);\n\tconst from = c.req.query(\"from\");\n\tconst to = c.req.query(\"to\");\n\tconst status = c.req.query(\"status\");\n\n\tif (!from || !to) {\n\t\treturn c.json({ error: \"Missing required query params: from, to\" }, 400);\n\t}\n\n\tconst supabase = getSupabase();\n\tlet query = supabase\n\t\t.from(\"planned_workouts\")\n\t\t.select(\"*\")\n\t\t.eq(\"athlete_id\", userId)\n\t\t.eq(\"club_id\", clubId)\n\t\t.gte(\"planned_date\", from)\n\t\t.lte(\"planned_date\", to)\n\t\t.order(\"planned_date\", { ascending: true })\n\t\t.order(\"sort_order\", { ascending: true });\n\n\tif (status) {\n\t\tquery = query.eq(\"status\", status);\n\t}\n\n\tconst { data, error } = await query;\n\n\tif (error) {\n\t\tlog.error({ err: error }, \"Failed to fetch planned workouts\");\n\t\treturn c.json({ error: error.message }, 500);\n\t}\n\n\treturn c.json({ data });\n});\n\n// \u2500\u2500 GET /api/planned-workouts/:id \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\nplannedWorkoutsRoutes.get(\"/:id\", async (c) => {\n\tconst { userId } = getAuth(c);\n\tconst id = c.req.param(\"id\");\n\tconst supabase = getSupabase();\n\n\tconst { data, error } = await supabase\n\t\t.from(\"planned_workouts\")\n\t\t.select(\"*\")\n\t\t.eq(\"id\", id)\n\t\t.eq(\"athlete_id\", userId)\n\t\t.single();\n\n\tif (error || !data) {\n\t\treturn c.json({ error: \"Planned workout not found\" }, 404);\n\t}\n\n\treturn c.json({ data });\n});\n\n// \u2500\u2500 POST /api/planned-workouts \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\nplannedWorkoutsRoutes.post(\"/\", async (c) => {\n\tconst { userId, clubId } = getAuth(c);\n\tconst body = await parseBody(c, PlannedWorkoutInput);\n\tif (isResponse(body)) return body;\n\n\tconst supabase = getSupabase();\n\tconst { data, error } = await supabase\n\t\t.from(\"planned_workouts\")\n\t\t.insert({\n\t\t\tathlete_id: userId,\n\t\t\tclub_id: clubId,\n\t\t\tplan_id: body.planId || null,\n\t\t\tplanned_date: body.plannedDate,\n\t\t\tplanned_time: body.plannedTime || null,\n\t\t\tactivity_type: body.activityType,\n\t\t\ttitle: body.title,\n\t\t\tdescription: body.description || null,\n\t\t\tduration_min: body.durationMin || null,\n\t\t\tdistance_km: body.distanceKm || null,\n\t\t\ttarget_tss: body.targetTss || null,\n\t\t\ttarget_rpe: body.targetRpe || null,\n\t\t\tintensity: body.intensity || null,\n\t\t\tsession_data: body.sessionData || {},\n\t\t\tstatus: \"planned\",\n\t\t\tsort_order: body.sortOrder || 0,\n\t\t\tnotes: body.notes || null,\n\t\t\tcoach_notes: body.coachNotes || null,\n\t\t\tsource: body.source || \"MANUAL\",\n\t\t})\n\t\t.select()\n\t\t.single();\n\n\tif (error) {\n\t\tlog.error({ err: error }, \"Failed to create planned workout\");\n\t\treturn c.json({ error: error.message }, 500);\n\t}\n\n\treturn c.json({ data }, 201);\n});\n\n// \u2500\u2500 PATCH /api/planned-workouts/:id \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\n// Supports partial updates (drag-drop reschedule, inline edit)\nplannedWorkoutsRoutes.patch(\"/:id\", async (c) => {\n\tconst { userId } = getAuth(c);\n\tconst id = c.req.param(\"id\");\n\tconst body = await parseBody(c, PlannedWorkoutUpdate);\n\tif (isResponse(body)) return body;\n\n\t// Map camelCase to snake_case for the fields being updated\n\tconst updateData: Record<string, unknown> = {};\n\tif (body.plannedDate !== undefined) updateData.planned_date = body.plannedDate;\n\tif (body.plannedTime !== undefined) updateData.planned_time = body.plannedTime;\n\tif (body.activityType !== undefined) updateData.activity_type = body.activityType;\n\tif (body.title !== undefined) updateData.title = body.title;\n\tif (body.description !== undefined) updateData.description = body.description;\n\tif (body.durationMin !== undefined) updateData.duration_min = body.durationMin;\n\tif (body.distanceKm !== undefined) updateData.distance_km = body.distanceKm;\n\tif (body.targetTss !== undefined) updateData.target_tss = body.targetTss;\n\tif (body.targetRpe !== undefined) updateData.target_rpe = body.targetRpe;\n\tif (body.intensity !== undefined) updateData.intensity = body.intensity;\n\tif (body.sessionData !== undefined) updateData.session_data = body.sessionData;\n\tif (body.status !== undefined) updateData.status = body.status;\n\tif (body.sortOrder !== undefined) updateData.sort_order = body.sortOrder;\n\tif (body.notes !== undefined) updateData.notes = body.notes;\n\tif (body.coachNotes !== undefined) updateData.coach_notes = body.coachNotes;\n\n\tif (Object.keys(updateData).length === 0) {\n\t\treturn c.json({ error: \"No fields to update\" }, 400);\n\t}\n\n\tconst supabase = getSupabase();\n\tconst { data, error } = await supabase\n\t\t.from(\"planned_workouts\")\n\t\t.update(updateData)\n\t\t.eq(\"id\", id)\n\t\t.eq(\"athlete_id\", userId)\n\t\t.select()\n\t\t.single();\n\n\tif (error) {\n\t\tlog.error({ err: error }, \"Failed to update planned workout\");\n\t\treturn c.json({ error: error.message }, 500);\n\t}\n\n\treturn c.json({ data });\n});\n\n// \u2500\u2500 PATCH /api/planned-workouts/:id/complete \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\n// Mark as completed and optionally link to a workout record\nplannedWorkoutsRoutes.patch(\"/:id/complete\", async (c) => {\n\tconst { userId } = getAuth(c);\n\tconst id = c.req.param(\"id\");\n\tconst body = await c.req.json().catch(() => ({}));\n\n\tconst supabase = getSupabase();\n\tconst { data, error } = await supabase\n\t\t.from(\"planned_workouts\")\n\t\t.update({\n\t\t\tstatus: \"completed\",\n\t\t\tworkout_id: body.workoutId || null,\n\t\t})\n\t\t.eq(\"id\", id)\n\t\t.eq(\"athlete_id\", userId)\n\t\t.select()\n\t\t.single();\n\n\tif (error) {\n\t\tlog.error({ err: error }, \"Failed to complete planned workout\");\n\t\treturn c.json({ error: error.message }, 500);\n\t}\n\n\treturn c.json({ data });\n});\n\n// \u2500\u2500 DELETE /api/planned-workouts/:id \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\nplannedWorkoutsRoutes.delete(\"/:id\", async (c) => {\n\tconst { userId } = getAuth(c);\n\tconst id = c.req.param(\"id\");\n\n\tconst supabase = getSupabase();\n\tconst { error } = await supabase\n\t\t.from(\"planned_workouts\")\n\t\t.delete()\n\t\t.eq(\"id\", id)\n\t\t.eq(\"athlete_id\", userId);\n\n\tif (error) {\n\t\tlog.error({ err: error }, \"Failed to delete planned workout\");\n\t\treturn c.json({ error: error.message }, 500);\n\t}\n\n\treturn c.json({ success: true });\n});\n", "// ============================================================\n// Zod Validation Helper for Hono\n// Parses request body against a Zod schema, returns 400 on failure.\n// ============================================================\n\nimport type { Context } from \"hono\";\nimport type { z } from \"zod/v4\";\n\n/**\n * Validate the JSON request body against a Zod schema.\n * Returns the parsed data on success, or a 400 Response on failure.\n */\nexport async function parseBody<T extends z.ZodType>(\n\tc: Context,\n\tschema: T,\n): Promise<z.infer<T> | Response> {\n\tconst body = await c.req\n\t\t.json()\n\t\t.catch((err: unknown) => (err instanceof SyntaxError ? null : Promise.reject(err)));\n\n\tif (body === null) {\n\t\treturn c.json({ error: \"Invalid JSON body\" }, 400);\n\t}\n\n\tconst result = schema.safeParse(body);\n\n\tif (!result.success) {\n\t\treturn c.json(\n\t\t\t{\n\t\t\t\terror: \"Validation failed\",\n\t\t\t\tissues: result.error.issues.map((issue) => ({\n\t\t\t\t\tpath: issue.path.join(\".\"),\n\t\t\t\t\tmessage: issue.message,\n\t\t\t\t})),\n\t\t\t},\n\t\t\t400,\n\t\t);\n\t}\n\n\treturn result.data as z.infer<T>;\n}\n\n/**\n * Type guard to check if parseBody returned a Response (validation error).\n */\nexport function isResponse(value: unknown): value is Response {\n\treturn value instanceof Response;\n}\n", "// ============================================================\n// Webhook Routes\n// Handles incoming webhook events from all fitness platforms.\n// Verifies signatures \u2192 enqueues for async processing \u2192\n// returns 200 immediately to prevent timeouts.\n// ============================================================\n\nimport { Hono } from \"hono\";\nimport { INTEGRATION_CONFIG } from \"../../config/integrations.js\";\nimport { createLogger } from \"../../lib/logger.js\";\nimport { getProvider } from \"../../services/integrations/registry.js\";\nimport type { ProviderName } from \"../../services/integrations/types.js\";\nimport { enqueueWebhook } from \"../../services/integrations/webhook-queue.js\";\n\nconst log = createLogger({ module: \"webhooks\" });\n\nexport const webhookRoutes = new Hono();\n\n// \u2500\u2500 Generic webhook handler \u2500\u2500\n// Verifies signature + enqueues for async processing.\n// Returns 200 immediately \u2014 actual processing happens in webhook-queue.ts.\nasync function handleWebhook(\n\tproviderName: ProviderName,\n\theaders: Record<string, string>,\n\tbody: string,\n): Promise<{ status: string; code: number }> {\n\tconst provider = getProvider(providerName);\n\n\t// 1. Verify webhook signature/authenticity\n\tconst valid = await provider.verifyWebhook(headers, body);\n\tif (!valid) {\n\t\tlog.warn({ provider: providerName }, \"Invalid webhook signature\");\n\t\treturn { status: \"invalid_signature\", code: 401 };\n\t}\n\n\t// 2. Enqueue for async processing\n\tconst event = JSON.parse(body) as Record<string, unknown>;\n\tawait enqueueWebhook(providerName, event);\n\n\treturn { status: \"accepted\", code: 200 };\n}\n\n// \u2500\u2500 Strava Webhooks \u2500\u2500\n\n// POST \u2014 activity events (create/update/delete)\nwebhookRoutes.post(\"/strava\", async (c) => {\n\ttry {\n\t\tconst body = await c.req.text();\n\t\tconst parsed = JSON.parse(body) as Record<string, unknown>;\n\n\t\t// Only process activity.create events\n\t\tif (parsed.object_type !== \"activity\" || parsed.aspect_type !== \"create\") {\n\t\t\treturn c.json({ status: \"ignored\" }, 200);\n\t\t}\n\n\t\tconst headers = Object.fromEntries(c.req.raw.headers.entries());\n\t\tconst result = await handleWebhook(\"STRAVA\", headers, body);\n\t\treturn c.json({ status: result.status }, result.code as 200);\n\t} catch (err) {\n\t\tlog.error({ err, provider: \"STRAVA\" }, \"Webhook processing error\");\n\t\treturn c.json({ status: \"error\" }, 200); // 200 to prevent retries\n\t}\n});\n\n// GET \u2014 Strava webhook subscription validation\nwebhookRoutes.get(\"/strava\", (c) => {\n\tconst mode = c.req.query(\"hub.mode\");\n\tconst token = c.req.query(\"hub.verify_token\");\n\tconst challenge = c.req.query(\"hub.challenge\");\n\n\tif (mode === \"subscribe\" && token === INTEGRATION_CONFIG.STRAVA.verifyToken) {\n\t\tlog.info(\"Strava subscription verified\");\n\t\treturn c.json({ \"hub.challenge\": challenge });\n\t}\n\n\treturn c.text(\"Forbidden\", 403);\n});\n\n// \u2500\u2500 Garmin Webhooks \u2500\u2500\nwebhookRoutes.post(\"/garmin\", async (c) => {\n\ttry {\n\t\tconst body = await c.req.text();\n\t\tconst headers = Object.fromEntries(c.req.raw.headers.entries());\n\t\tconst result = await handleWebhook(\"GARMIN\", headers, body);\n\t\treturn c.json({ status: result.status }, result.code as 200);\n\t} catch (err) {\n\t\tlog.error({ err, provider: \"GARMIN\" }, \"Webhook processing error\");\n\t\treturn c.json({ status: \"error\" }, 200);\n\t}\n});\n\n// \u2500\u2500 Polar Webhooks \u2500\u2500\nwebhookRoutes.post(\"/polar\", async (c) => {\n\ttry {\n\t\tconst body = await c.req.text();\n\t\tconst headers = Object.fromEntries(c.req.raw.headers.entries());\n\t\tconst result = await handleWebhook(\"POLAR\", headers, body);\n\t\treturn c.json({ status: result.status }, result.code as 200);\n\t} catch (err) {\n\t\tlog.error({ err, provider: \"POLAR\" }, \"Webhook processing error\");\n\t\treturn c.json({ status: \"error\" }, 200);\n\t}\n});\n\n// \u2500\u2500 Wahoo Webhooks \u2500\u2500\nwebhookRoutes.post(\"/wahoo\", async (c) => {\n\ttry {\n\t\tconst body = await c.req.text();\n\t\tconst headers = Object.fromEntries(c.req.raw.headers.entries());\n\t\tconst result = await handleWebhook(\"WAHOO\", headers, body);\n\t\treturn c.json({ status: result.status }, result.code as 200);\n\t} catch (err) {\n\t\tlog.error({ err, provider: \"WAHOO\" }, \"Webhook processing error\");\n\t\treturn c.json({ status: \"error\" }, 200);\n\t}\n});\n", "// ============================================================\n// Webhook Queue \u2014 Persistent PostgreSQL-backed queue\n//\n// Replaces the in-memory array that lost data on restart.\n// Uses PostgreSQL FOR UPDATE SKIP LOCKED for safe concurrent\n// job claiming across multiple API instances.\n// ============================================================\n\nimport { createLogger } from \"../../lib/logger.js\";\nimport { createAdminClient } from \"../../services/ai/supabase.js\";\nimport { normalizeAndStore } from \"./normalizer.js\";\nimport { getProvider } from \"./registry.js\";\nimport { ensureFreshToken } from \"./token-manager.js\";\nimport type { ProviderName } from \"./types.js\";\n\nconst log = createLogger({ module: \"webhook-queue\" });\n\n/** Delay between queue polling cycles (ms) */\nconst POLL_INTERVAL_MS = 3000;\n\n/** Number of jobs to claim per poll cycle */\nconst BATCH_SIZE = 5;\n\n/** Visibility timeout \u2014 if processing takes longer, job becomes visible again */\nconst VISIBILITY_TIMEOUT_SECONDS = 60;\n\n/** Retry delay for failed jobs (seconds) */\nconst RETRY_DELAY_SECONDS = 10;\n\nlet pollIntervalId: ReturnType<typeof setInterval> | null = null;\n\n/**\n * Enqueue a webhook job for async processing.\n * Returns immediately \u2014 the webhook handler can respond 200.\n */\nexport async function enqueueWebhook(\n\tprovider: ProviderName,\n\tevent: Record<string, unknown>,\n): Promise<void> {\n\tconst admin = createAdminClient();\n\n\tconst { error } = await admin.from(\"webhook_queue\").insert({\n\t\tprovider,\n\t\tevent_data: event,\n\t\tstatus: \"pending\",\n\t\tattempts: 0,\n\t\tmax_attempts: 3,\n\t});\n\n\tif (error) {\n\t\tlog.error({ err: error, provider }, \"Failed to enqueue webhook job\");\n\t\treturn;\n\t}\n\n\tlog.info({ provider }, \"Enqueued webhook job\");\n\n\t// Auto-start polling if not already running\n\tensurePolling();\n}\n\n/**\n * Start the queue poller if not already running.\n */\nfunction ensurePolling(): void {\n\tif (pollIntervalId) return;\n\n\tlog.info(\"Starting webhook queue poller\");\n\n\tpollIntervalId = setInterval(async () => {\n\t\ttry {\n\t\t\tawait pollAndProcess();\n\t\t} catch (err) {\n\t\t\tlog.error({ err }, \"Queue poller error\");\n\t\t}\n\t}, POLL_INTERVAL_MS);\n}\n\n/**\n * Poll for available jobs and process them.\n */\nasync function pollAndProcess(): Promise<void> {\n\tconst admin = createAdminClient();\n\n\t// Claim a batch of jobs atomically\n\tconst { data: jobs, error } = await admin.rpc(\"claim_webhook_jobs\", {\n\t\tbatch_size: BATCH_SIZE,\n\t\tvisibility_timeout_seconds: VISIBILITY_TIMEOUT_SECONDS,\n\t});\n\n\tif (error) {\n\t\tlog.error({ err: error }, \"Failed to claim webhook jobs\");\n\t\treturn;\n\t}\n\n\tif (!jobs || jobs.length === 0) return;\n\n\tlog.debug({ jobCount: jobs.length }, \"Claimed webhook jobs\");\n\n\t// Process each job concurrently\n\tconst results = await Promise.allSettled(\n\t\tjobs.map(\n\t\t\t(job: {\n\t\t\t\tid: number;\n\t\t\t\tprovider: string;\n\t\t\t\tevent_data: Record<string, unknown>;\n\t\t\t\tattempts: number;\n\t\t\t}) => processJob(admin, job),\n\t\t),\n\t);\n\n\tfor (const result of results) {\n\t\tif (result.status === \"rejected\") {\n\t\t\tlog.error({ err: result.reason }, \"Unhandled error in job processing\");\n\t\t}\n\t}\n}\n\n/**\n * Process a single webhook job with error isolation.\n */\nasync function processJob(\n\tadmin: ReturnType<typeof createAdminClient>,\n\tjob: { id: number; provider: string; event_data: Record<string, unknown>; attempts: number },\n): Promise<void> {\n\tconst startMs = Date.now();\n\n\ttry {\n\t\tconst provider = getProvider(job.provider as ProviderName);\n\n\t\t// Extract owner/activity from event\n\t\tconst ownerId = provider.extractOwnerIdFromWebhook(job.event_data);\n\t\tconst activityId = provider.extractActivityIdFromWebhook(job.event_data);\n\n\t\t// Look up connected account\n\t\tconst { data: account } = await admin\n\t\t\t.from(\"connected_accounts\")\n\t\t\t.select(\"*\")\n\t\t\t.eq(\"provider\", job.provider)\n\t\t\t.eq(\"provider_uid\", ownerId)\n\t\t\t.single();\n\n\t\tif (!account) {\n\t\t\tawait logSyncResult(admin, {\n\t\t\t\tprovider: job.provider,\n\t\t\t\teventType: \"webhook\",\n\t\t\t\tstatus: \"skipped\",\n\t\t\t\terrorMessage: `No account for provider UID ${ownerId}`,\n\t\t\t\tdurationMs: Date.now() - startMs,\n\t\t\t});\n\t\t\t// Mark as completed (no point retrying if account doesn't exist)\n\t\t\tawait admin.rpc(\"complete_webhook_job\", { job_id: job.id });\n\t\t\treturn;\n\t\t}\n\n\t\t// Refresh token if needed\n\t\tconst accessToken = await ensureFreshToken(provider, account, admin);\n\n\t\t// Fetch full activity\n\t\tconst activity = await provider.fetchActivity(accessToken, activityId);\n\n\t\t// Fetch health data (optional)\n\t\tconst healthData = provider.fetchHealthData\n\t\t\t? await provider.fetchHealthData(accessToken, new Date())\n\t\t\t: [];\n\n\t\t// Get club_id\n\t\tconst { data: profile } = await admin\n\t\t\t.from(\"profiles\")\n\t\t\t.select(\"club_id\")\n\t\t\t.eq(\"id\", account.athlete_id)\n\t\t\t.single();\n\n\t\tif (!profile) {\n\t\t\tawait logSyncResult(admin, {\n\t\t\t\tathleteId: account.athlete_id,\n\t\t\t\tprovider: job.provider,\n\t\t\t\teventType: \"webhook\",\n\t\t\t\tstatus: \"failed\",\n\t\t\t\terrorMessage: \"No profile found\",\n\t\t\t\tdurationMs: Date.now() - startMs,\n\t\t\t});\n\t\t\tawait admin.rpc(\"complete_webhook_job\", { job_id: job.id });\n\t\t\treturn;\n\t\t}\n\n\t\t// Normalize + store\n\t\tconst result = await normalizeAndStore(\n\t\t\t[activity],\n\t\t\thealthData,\n\t\t\taccount.athlete_id,\n\t\t\tprofile.club_id,\n\t\t\tadmin,\n\t\t);\n\n\t\t// Update last_sync_at\n\t\tawait admin\n\t\t\t.from(\"connected_accounts\")\n\t\t\t.update({ last_sync_at: new Date().toISOString() })\n\t\t\t.eq(\"id\", account.id);\n\n\t\t// Mark job completed\n\t\tawait admin.rpc(\"complete_webhook_job\", { job_id: job.id });\n\n\t\t// Log success\n\t\tawait logSyncResult(admin, {\n\t\t\tathleteId: account.athlete_id,\n\t\t\tprovider: job.provider,\n\t\t\teventType: \"webhook\",\n\t\t\tstatus: \"success\",\n\t\t\tworkoutsAdded: result.workoutsInserted,\n\t\t\tmetricsAdded: result.metricsInserted,\n\t\t\tdurationMs: Date.now() - startMs,\n\t\t});\n\n\t\tlog.info(\n\t\t\t{\n\t\t\t\tprovider: job.provider,\n\t\t\t\tjobId: job.id,\n\t\t\t\tworkoutsInserted: result.workoutsInserted,\n\t\t\t\tmetricsInserted: result.metricsInserted,\n\t\t\t\tdurationMs: Date.now() - startMs,\n\t\t\t},\n\t\t\t\"Webhook job complete\",\n\t\t);\n\t} catch (err) {\n\t\tconst errMsg = err instanceof Error ? err.message : String(err);\n\n\t\tlog.warn({ jobId: job.id, attempt: job.attempts, error: errMsg }, \"Webhook job failed\");\n\n\t\t// Mark as failed \u2014 the DB function handles retry vs dead letter\n\t\tawait admin.rpc(\"fail_webhook_job\", {\n\t\t\tjob_id: job.id,\n\t\t\terr_msg: errMsg,\n\t\t\tretry_delay_seconds: RETRY_DELAY_SECONDS,\n\t\t});\n\n\t\t// Log failure on final attempt\n\t\tif (job.attempts >= 3) {\n\t\t\tawait logSyncResult(admin, {\n\t\t\t\tprovider: job.provider,\n\t\t\t\teventType: \"webhook\",\n\t\t\t\tstatus: \"failed\",\n\t\t\t\terrorMessage: errMsg,\n\t\t\t\tdurationMs: Date.now() - startMs,\n\t\t\t});\n\t\t}\n\t}\n}\n\n/**\n * Log a sync result to the sync_history table.\n */\nasync function logSyncResult(\n\tadmin: ReturnType<typeof createAdminClient>,\n\tentry: {\n\t\tathleteId?: string;\n\t\tprovider: string;\n\t\teventType: string;\n\t\tstatus: string;\n\t\tworkoutsAdded?: number;\n\t\tmetricsAdded?: number;\n\t\terrorMessage?: string;\n\t\tdurationMs: number;\n\t},\n): Promise<void> {\n\ttry {\n\t\tawait admin.from(\"sync_history\").insert({\n\t\t\tathlete_id: entry.athleteId || null,\n\t\t\tprovider: entry.provider,\n\t\t\tevent_type: entry.eventType,\n\t\t\tstatus: entry.status,\n\t\t\tworkouts_added: entry.workoutsAdded || 0,\n\t\t\tmetrics_added: entry.metricsAdded || 0,\n\t\t\terror_message: entry.errorMessage || null,\n\t\t\tduration_ms: entry.durationMs,\n\t\t});\n\t} catch (err) {\n\t\tlog.error({ err }, \"Failed to log sync result\");\n\t}\n}\n\n/** Stop the queue poller (for graceful shutdown). */\nexport function stopPolling(): void {\n\tif (pollIntervalId) {\n\t\tclearInterval(pollIntervalId);\n\t\tpollIntervalId = null;\n\t\tlog.info(\"Webhook queue poller stopped\");\n\t}\n}\n"],
  "mappings": "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",
  "names": ["createMiddleware", "createMiddleware", "HumanMessage", "z", "z", "log", "data", "error", "AzureChatOpenAI", "createClient", "log", "SUPABASE_URL", "createClient", "z", "z", "tool", "z", "tool", "z", "tool", "z", "tool", "z", "log", "z", "tool", "tool", "z", "tool", "z", "tool", "z", "tool", "z", "tool", "z", "tool", "z", "tool", "z", "tool", "z", "tool", "z", "tool", "z", "tool", "z", "tool", "z", "tool", "z", "tool", "z", "log", "z", "tool", "tool", "AzureOpenAIEmbeddings", "z", "tool", "AzureOpenAIEmbeddings", "z", "tool", "z", "tool", "z", "tool", "z", "tool", "z", "tool", "z", "tool", "AzureOpenAIEmbeddings", "z", "log", "tool", "AzureOpenAIEmbeddings", "z", "tool", "z", "log", "z", "tool", "tool", "AzureOpenAIEmbeddings", "z", "tool", "AzureOpenAIEmbeddings", "z", "tool", "z", "tool", "z", "tool", "log", "z", "log", "AzureOpenAIEmbeddings", "AzureChatOpenAI", "AzureChatOpenAI", "AzureOpenAIEmbeddings", "log", "AzureChatOpenAI", "AzureOpenAIEmbeddings", "log", "HumanMessage", "HumanMessage", "Hono", "log", "Hono", "HumanMessage", "Hono", "provider", "provider", "log", "log", "log", "timingSafeEqual", "log", "timingSafeEqual", "log", "provider", "Hono", "log", "createHmac", "timingSafeEqual", "log", "createHmac", "timingSafeEqual", "log", "provider", "Hono", "provider", "Hono", "Hono", "provider", "Hono", "Hono", "provider", "Hono", "Hono", "provider", "Hono", "provider", "createClient", "Hono", "log", "SUPABASE_URL", "getSupabase", "createClient", "Hono", "Hono", "log", "provider", "log", "Hono", "provider"]
}
